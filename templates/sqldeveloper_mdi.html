<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle SQL Developer - UNA.md/orasldev</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- CodeMirror –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ SQL/PL-SQL -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/simplescrollbars.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/scroll/simplescrollbars.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #2b2b2b;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Menu Bar */
        .menu-bar {
            background: #1e1e1e;
            border-bottom: 1px solid #3c3c3c;
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .menu-item {
            padding: 5px 12px;
            cursor: pointer;
            color: #d4d4d4;
            border-radius: 3px;
            margin-right: 5px;
            transition: background 0.2s;
        }
        
        .menu-item:hover {
            background: #3c3c3c;
        }
        
        .menu-item.active {
            background: #007acc;
            color: white;
        }
        
        .menu-item.user {
            margin-left: auto;
            color: #858585;
        }
        
        /* Toolbar */
        .toolbar {
            background: #252526;
            border-bottom: 1px solid #3c3c3c;
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            z-index: 999;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .toolbar-btn:hover {
            background: #555;
        }
        
        .toolbar-btn.primary {
            background: #007acc;
            border-color: #007acc;
            color: white;
        }
        
        /* MDI Container */
        .mdi-container {
            height: calc(100vh - 70px);
            position: relative;
            background: #1e1e1e;
            overflow: hidden;
            display: flex;
        }
        
        /* MDI Window */
        .mdi-window {
            position: absolute;
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            min-width: 400px;
            min-height: 300px;
        }
        
        .mdi-window.active {
            display: flex;
            z-index: 100;
        }
        
        .mdi-window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        .mdi-window-header {
            background: #2d2d30;
            padding: 8px 12px;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            cursor: move;
            user-select: none;
        }
        
        .mdi-window-title {
            flex: 1;
            font-size: 12px;
            font-weight: 600;
        }
        
        .mdi-window-controls {
            display: flex;
            gap: 5px;
        }
        
        .mdi-window-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: #d4d4d4;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .mdi-window-btn:hover {
            background: #3c3c3c;
        }
        
        .mdi-window-content {
            flex: 1;
            overflow: auto;
            padding: 10px;
        }
        
        /* SQL Worksheet Window */
        .sql-worksheet-window {
            width: 800px;
            height: 600px;
            top: 50px;
            left: 50px;
        }
        
        .sql-editor {
            width: 100%;
            min-height: 300px;
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .sql-editor-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        
        .CodeMirror {
            height: auto;
            min-height: 300px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            background: #1e1e1e !important;
            color: #d4d4d4 !important;
        }
        
        .CodeMirror-scroll {
            min-height: 300px;
            max-height: none;
        }
        
        .CodeMirror-vscrollbar, .CodeMirror-hscrollbar {
            background: #252526;
        }
        
        .ai-sql-editor-container {
            display: flex;
            flex-direction: column;
            min-height: 300px;
            flex: 1;
        }
        
        .ai-sql-editor {
            min-height: 300px;
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 3px;
        }
        
        .results-table {
            min-height: 200px;
            overflow: auto;
            background: #1e1e1e;
            margin-top: 10px;
            padding: 10px;
        }
        
        .results-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: #1e1e1e;
        }
        
        .results-table th {
            background: #252526;
            color: #d4d4d4;
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #3c3c3c;
            position: sticky;
            top: 0;
            font-weight: 600;
            z-index: 10;
        }
        
        .results-table td {
            padding: 8px;
            border-bottom: 1px solid #2d2d30;
            color: #d4d4d4;
            background: #1e1e1e;
        }
        
        .results-table tr:hover {
            background: #2a2d2e;
        }
        
        .results-table         tr:hover td {
            background: #2a2d2e;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è CLOB —è—á–µ–µ–∫ */
        td[data-clob-full] {
            position: relative;
        }
        
        td[data-clob-full]:hover::after {
            content: attr(data-clob-full);
            position: absolute;
            left: 100%;
            top: 0;
            background: #252526;
            color: #d4d4d4;
            padding: 10px;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1000;
            max-width: 600px;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            margin-left: 10px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è CLOB tooltip */
        .clob-cell {
            cursor: help;
            position: relative;
        }
        
        .clob-tooltip {
            position: fixed;
            background: #252526;
            color: #d4d4d4;
            padding: 10px;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 10000;
            max-width: 600px;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            display: none;
            pointer-events: none;
        }
        
        .clob-tooltip.show {
            display: block;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: #252526;
            border-right: 1px solid #3c3c3c;
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
        }
        
        .schema-selector {
            padding: 10px;
            border-bottom: 1px solid #3c3c3c;
            background: #1e1e1e;
        }
        
        .schema-selector select {
            width: 100%;
            padding: 6px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .schema-selector select:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .schema-selector label {
            display: block;
            font-size: 11px;
            color: #858585;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .filter-input {
            width: 100%;
            padding: 6px;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 10px;
            box-sizing: border-box;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .filter-input::placeholder {
            color: #858585;
        }
        
        .sidebar-section {
            padding: 10px;
        }
        
        .sidebar-title {
            font-size: 11px;
            font-weight: bold;
            color: #858585;
            text-transform: uppercase;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .sidebar-item {
            padding: 6px 10px;
            cursor: pointer;
            color: #d4d4d4;
            border-radius: 3px;
            margin-bottom: 2px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-item:hover {
            background: #3c3c3c;
        }
        
        .sidebar-item.active {
            background: #007acc;
            color: white;
        }
        
        .sidebar-item-icon {
            font-size: 14px;
        }
        
        .sidebar-item-count {
            margin-left: auto;
            color: #858585;
            font-size: 11px;
        }
        
        .sidebar-items {
            padding-left: 10px;
        }
        
        .sidebar-items.sidebar-collapsed {
            display: none;
        }
        
        .toggle {
            margin-left: auto;
            font-size: 10px;
            color: #858585;
        }
        
        .mdi-workspace {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* Status Bar */
        .status-bar {
            background: #007acc;
            height: 22px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            color: white;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .error-message {
            background: #5a1d1d;
            color: #f48771;
            padding: 10px;
            border-left: 3px solid #f48771;
            margin: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .success-message {
            background: #1e3a1e;
            color: #89d185;
            padding: 10px;
            border-left: 3px solid #89d185;
            margin: 10px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Menu Bar -->
    <div class="menu-bar">
        <div class="menu-item active" onclick="openWindow('sql-worksheet')">{{ _('SQL Worksheet') }}</div>
        <div class="menu-item" onclick="openWindow('dashboard')">{{ _('Dashboard') }}</div>
        <div class="menu-item" onclick="openWindow('ai-generator')">ü§ñ {{ _('AI Generator') }}</div>
        <div class="menu-item" onclick="openWindow('combo-scenario')">üîÑ {{ _('Combo Scenario') }}</div>
        <div class="menu-item" onclick="openWindow('connections')">{{ _('Connections') }}</div>
        <div class="menu-item" onclick="window.location.href='/UNA.md/orasldev/digi-marketing'">üì∫ DIGI Marketing</div>
        <div class="menu-item" style="margin-left: auto; padding: 5px 8px;">
            <select id="languageSelect" onchange="changeLanguage(this.value)" style="background: #2d2d30; color: #d4d4d4; border: 1px solid #3c3c3c; border-radius: 3px; padding: 2px 5px; font-size: 11px; cursor: pointer;">
                {% for lang_code, lang_name in languages.items() %}
                <option value="{{ lang_code }}" {% if get_locale() == lang_code %}selected{% endif %}>{{ lang_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="menu-item user" onclick="logout()">üë§ {{ username }} | {{ _('Logout') }}</div>
    </div>
    
    <!-- Toolbar -->
    <div class="toolbar">
        <button class="toolbar-btn primary" onclick="executeSQL()">‚ñ∂ {{ _('Execute') }} (F5)</button>
        <button class="toolbar-btn" onclick="clearEditor()">{{ _('Clear') }}</button>
        <div style="flex: 1;"></div>
        <button class="toolbar-btn" onclick="openWindow('dashboard')">üìä {{ _('Dashboard') }}</button>
    </div>
    
    <!-- MDI Container -->
    <div class="mdi-container" id="mdiContainer">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="schema-selector">
                <label for="schemaSelect">{{ _('Schema') }}:</label>
                <select id="schemaSelect" onchange="changeSchema(this.value)">
                    <option value="">{{ _('Loading...') }}</option>
                </select>
                <input type="text" 
                       id="objectFilter" 
                       class="filter-input" 
                       placeholder="{{ _('üîç Filter objects (min 3 chars, 2s delay)') }}"
                       autocomplete="off">
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <span>{{ _('Connections') }}</span>
                </div>
                <div class="sidebar-item active">
                    <span class="sidebar-item-icon">üîå</span>
                    <span class="sidebar-item-name">ADMIN@HXPAVUNKCLU9HE7Q</span>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" onclick="toggleSection('objects')">
                    <span>{{ _('Database Objects') }}</span>
                    <span class="toggle" id="objects-toggle">‚ñº</span>
                </div>
                <div class="sidebar-items" id="objects-items">
                    <div class="sidebar-item" onclick="loadObjects('tables')">
                        <span class="sidebar-item-icon">üìä</span>
                        <span class="sidebar-item-name">{{ _('Tables') }}</span>
                        <span class="sidebar-item-count" id="tables-count"></span>
                    </div>
                    <div id="tables-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('views')">
                        <span class="sidebar-item-icon">üëÅÔ∏è</span>
                        <span class="sidebar-item-name">{{ _('Views') }}</span>
                        <span class="sidebar-item-count" id="views-count"></span>
                    </div>
                    <div id="views-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('procedures')">
                        <span class="sidebar-item-icon">‚öôÔ∏è</span>
                        <span class="sidebar-item-name">{{ _('Procedures') }}</span>
                        <span class="sidebar-item-count" id="procedures-count"></span>
                    </div>
                    <div id="procedures-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('functions')">
                        <span class="sidebar-item-icon">üîß</span>
                        <span class="sidebar-item-name">{{ _('Functions') }}</span>
                        <span class="sidebar-item-count" id="functions-count"></span>
                    </div>
                    <div id="functions-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('packages')">
                        <span class="sidebar-item-icon">üì¶</span>
                        <span class="sidebar-item-name">{{ _('Packages') }}</span>
                        <span class="sidebar-item-count" id="packages-count"></span>
                    </div>
                    <div id="packages-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('sequences')">
                        <span class="sidebar-item-icon">üî¢</span>
                        <span class="sidebar-item-name">{{ _('Sequences') }}</span>
                        <span class="sidebar-item-count" id="sequences-count"></span>
                    </div>
                    <div id="sequences-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('synonyms')">
                        <span class="sidebar-item-icon">üîó</span>
                        <span class="sidebar-item-name">{{ _('Synonyms') }}</span>
                        <span class="sidebar-item-count" id="synonyms-count"></span>
                    </div>
                    <div id="synonyms-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('indexes')">
                        <span class="sidebar-item-icon">üìá</span>
                        <span class="sidebar-item-name">{{ _('Indexes') }}</span>
                        <span class="sidebar-item-count" id="indexes-count"></span>
                    </div>
                    <div id="indexes-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('triggers')">
                        <span class="sidebar-item-icon">‚ö°</span>
                        <span class="sidebar-item-name">{{ _('Triggers') }}</span>
                        <span class="sidebar-item-count" id="triggers-count"></span>
                    </div>
                    <div id="triggers-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('types')">
                        <span class="sidebar-item-icon">üè∑Ô∏è</span>
                        <span class="sidebar-item-name">{{ _('Types') }}</span>
                        <span class="sidebar-item-count" id="types-count"></span>
                    </div>
                    <div id="types-list" class="sidebar-items"></div>
                    
                    <div class="sidebar-item" onclick="loadObjects('materialized_views')">
                        <span class="sidebar-item-icon">üíæ</span>
                        <span class="sidebar-item-name">{{ _('Materialized Views') }}</span>
                        <span class="sidebar-item-count" id="materialized_views-count"></span>
                    </div>
                    <div id="materialized_views-list" class="sidebar-items"></div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title" onclick="toggleSection('dba')">
                    <span>{{ _('DBA') }}</span>
                    <span class="toggle" id="dba-toggle">‚ñº</span>
                </div>
                <div class="sidebar-items" id="dba-items">
                    <div class="sidebar-item" onclick="openWindow('dashboard')">
                        <span class="sidebar-item-icon">üìà</span>
                        <span class="sidebar-item-name">{{ _('Performance') }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MDI Workspace -->
        <div class="mdi-workspace" id="mdiWorkspace">
            <!-- SQL Worksheet Window -->
            <div class="mdi-window sql-worksheet-window active" id="sql-worksheet-window">
            <div class="mdi-window-header">
                <div class="mdi-window-title">{{ _('SQL Worksheet') }}</div>
                <div class="mdi-window-controls">
                    <button class="mdi-window-btn" onclick="maximizeWindow('sql-worksheet-window')">‚ñ°</button>
                    <button class="mdi-window-btn" onclick="closeWindow('sql-worksheet-window')">√ó</button>
                </div>
            </div>
            <div class="mdi-window-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div class="sql-editor-container" style="flex: 1; min-height: 0; display: flex; flex-direction: column;">
                    <textarea id="sqlEditor"></textarea>
                </div>
                <div class="results-table" id="resultsTable" style="flex: 1; min-height: 200px; max-height: 50%; margin-top: 10px;">
                    <div style="padding: 20px; text-align: center; color: #858585;">
                        {{ _('No results. Execute a query to see results here.') }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Table Generator Window -->
        <div class="mdi-window" id="ai-generator-window" style="width: 700px; height: 700px; top: 50px; left: 870px; z-index: 99;">
            <div class="mdi-window-header">
                <div class="mdi-window-title">ü§ñ {{ _('AI Table Generator') }}</div>
                <div class="mdi-window-controls">
                    <button class="mdi-window-btn" onclick="maximizeWindow('ai-generator-window')">‚ñ°</button>
                    <button class="mdi-window-btn" onclick="closeWindow('ai-generator-window')">√ó</button>
                </div>
            </div>
            <div class="mdi-window-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 12px; color: #858585; margin-bottom: 5px;">
                        {{ _('Table description (in Russian or English):') }}
                    </label>
                    <textarea id="aiDescription" 
                              style="width: 100%; height: 100px; background: #1e1e1e; color: #d4d4d4; border: 1px solid #3c3c3c; padding: 8px; font-family: inherit; font-size: 12px; resize: vertical; border-radius: 3px;"
                              placeholder="{{ _('For example: Table to store users with fields: id (number), name (string), email (string), registration_date (date)') }}"></textarea>
                </div>
                
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button id="aiGenerateBtn" 
                            class="toolbar-btn primary" 
                            onclick="generateTableSQL()"
                            style="flex: 1;">
                        ‚ú® {{ _('Generate SQL') }}
                    </button>
                    <button class="toolbar-btn" 
                            onclick="clearAIDescription()"
                            style="flex: 0 0 auto;">
                        üóëÔ∏è {{ _('Clear') }}
                    </button>
                    <div id="aiStatus" style="font-size: 11px; color: #858585;"></div>
                </div>
                
                <div style="margin-bottom: 10px; flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
                    <label style="display: block; font-size: 12px; color: #858585; margin-bottom: 5px;">
                        {{ _('Generated SQL:') }}
                    </label>
                    <div class="ai-sql-editor-container" style="flex: 1; min-height: 0; display: flex; flex-direction: column;">
                        <textarea id="aiGeneratedSQL"></textarea>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="toolbar-btn" 
                            onclick="insertSQLToEditor()"
                            style="flex: 1;">
                        üìã {{ _('Insert into editor') }}
                    </button>
                    <button class="toolbar-btn" 
                            onclick="copySQLToClipboard()"
                            style="flex: 1;">
                        üìÑ {{ _('Copy') }}
                    </button>
                </div>
                
                <div id="aiError" style="margin-top: 10px; display: none;"></div>
            </div>
        </div>
        
        <!-- Combo Scenario Window -->
        <div class="mdi-window" id="combo-scenario-window" style="width: 800px; height: 750px; top: 50px; left: 950px; z-index: 99;">
            <div class="mdi-window-header">
                <div class="mdi-window-title">üîÑ {{ _('Combo Scenario') }}</div>
                <div class="mdi-window-controls">
                    <button class="mdi-window-btn" onclick="maximizeWindow('combo-scenario-window')">‚ñ°</button>
                    <button class="mdi-window-btn" onclick="closeWindow('combo-scenario-window')">√ó</button>
                </div>
            </div>
            <div class="mdi-window-content" style="display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 15px;">
                <!-- –ì–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞ -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 12px; color: #858585; margin-bottom: 5px; font-weight: bold;">
                        {{ _('Main Task (–ì–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞):') }}
                    </label>
                    <input type="text" id="comboMainTask" 
                           value="–ø—Ä–æ–≤–µ—Ä—å –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ ADMIN.TEST_QUESTIONS_CXX —Ç–æ —É–¥–∞–ª–∏ –µ—ë –∏ —Å–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ —Ç–µ—Å—Ç–æ–≤ –ø–æ —Å++ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏: QUESTION_ID (NUMBER, PRIMARY KEY), QUESTION_TEXT (VARCHAR2(4000), NOT NULL), ANSWER (VARCHAR2(4000)), CREATED_DATE (DATE DEFAULT SYSTIMESTAMP)"
                           style="width: 100%; background: #1e1e1e; color: #d4d4d4; border: 1px solid #3c3c3c; padding: 8px; font-family: inherit; font-size: 12px; border-radius: 3px;"
                           placeholder="{{ _('Example: —Å–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ —Ç–µ—Å—Ç sql') }}">
                </div>
                
                <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 12px; color: #858585; margin-bottom: 5px; font-weight: bold;">
                        {{ _('Iterations Count (–°–∫–æ–ª—å–∫–æ –∏—Ç–µ—Ä–∞—Ü–∏–π):') }}
                    </label>
                    <input type="number" id="comboIterationsCount" 
                           value="50" min="1" max="1000"
                           style="width: 100%; background: #1e1e1e; color: #d4d4d4; border: 1px solid #3c3c3c; padding: 8px; font-family: inherit; font-size: 12px; border-radius: 3px;">
                </div>
                
                <!-- –ò—Ç–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ -->
                <div style="margin-bottom: 15px; flex: 1; display: flex; flex-direction: column; min-height: 0;">
                    <label style="display: block; font-size: 12px; color: #858585; margin-bottom: 5px; font-weight: bold;">
                        {{ _('Iterative Task (–ò—Ç–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ):') }}
                    </label>
                    <textarea id="comboIterativeTask" 
                              style="flex: 1; min-height: 100px; background: #1e1e1e; color: #d4d4d4; border: 1px solid #3c3c3c; padding: 8px; font-family: inherit; font-size: 12px; resize: vertical; border-radius: 3px;"
                              placeholder="{{ _('Example: –∑–∞–ø–æ–ª–Ω–∏ —Ç–∞–±–ª–∏—Ü—É 10 –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ sql') }}">–∑–∞–ø–æ–ª–Ω–∏ —Ç–∞–±–ª–∏—Ü—É 10 –Ω–æ–≤—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –ø–æ —Å++. –ò—Å–ø–æ–ª—å–∑—É–π INSERT INTO –∫–æ–º–∞–Ω–¥—ã. –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏</textarea>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                    <button id="comboExecuteBtn" 
                            class="toolbar-btn primary" 
                            onclick="executeComboScenario()"
                            style="flex: 1;">
                        ‚ñ∂Ô∏è {{ _('Execute Scenario') }}
                    </button>
                    <button id="comboStopBtn" 
                            class="toolbar-btn" 
                            onclick="stopComboScenario()"
                            style="flex: 0 0 auto; display: none; background: #c6262e; color: white;"
                            disabled>
                        ‚èπÔ∏è {{ _('Stop') }}
                    </button>
                    <button class="toolbar-btn" 
                            onclick="clearComboScenario()"
                            style="flex: 0 0 auto;">
                        üóëÔ∏è {{ _('Clear') }}
                    </button>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
                <div id="comboStatus" style="margin-bottom: 10px; font-size: 11px; color: #858585;">
                    {{ _('Ready to execute') }}
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #858585; margin-bottom: 5px;">
                        <span id="comboProgressText">{{ _('Progress:') }} 0/0</span>
                        <span id="comboProgressPercent">0%</span>
                    </div>
                    <div style="width: 100%; height: 20px; background: #1e1e1e; border: 1px solid #3c3c3c; border-radius: 3px; overflow: hidden;">
                        <div id="comboProgressBar" style="width: 0%; height: 100%; background: #007acc; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <!-- –õ–æ–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                <div style="flex: 1; min-height: 150px; display: flex; flex-direction: column; overflow: hidden;">
                    <label style="display: block; font-size: 12px; color: #858585; margin-bottom: 5px; font-weight: bold;">
                        {{ _('Execution Log:') }}
                    </label>
                    <div id="comboLog" 
                         style="flex: 1; background: #1e1e1e; color: #d4d4d4; border: 1px solid #3c3c3c; padding: 10px; font-family: 'Courier New', monospace; font-size: 11px; overflow-y: auto; border-radius: 3px;">
                        {{ _('Log will appear here...') }}
                    </div>
                </div>
                
                <!-- –û—à–∏–±–∫–∏ -->
                <div id="comboError" style="margin-top: 10px; display: none; color: #f48771; font-size: 11px;"></div>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <span>Ready</span>
        <span style="margin-left: 15px;" id="status-time"></span>
    </div>
    
    <script>
        // Translations object for JavaScript
        const translations = {
            'All commands': '{{ _("All commands") }}',
            'Total commands': '{{ _("Total commands") }}',
            'Success': '{{ _("Success") }}',
            'Errors': '{{ _("Errors") }}',
            'Error': '{{ _("Error") }}',
            'rows': '{{ _("rows") }}',
            'Results': '{{ _("Results") }}',
            'Execution details': '{{ _("Execution details") }}',
            'Command': '{{ _("Command") }}',
            'Query executed successfully. No rows returned.': '{{ _("Query executed successfully. No rows returned.") }}',
            'Error:': '{{ _("Error:") }}',
            'Clear SQL editor?': '{{ _("Clear SQL editor?") }}',
            'No results. Execute a query to see results here.': '{{ _("No results. Execute a query to see results here.") }}',
            'Loading schemas...': '{{ _("Loading schemas...") }}',
            'Current User': '{{ _("Current User") }}',
            'Loading...': '{{ _("Loading...") }}',
            'Ready': '{{ _("Ready") }}',
            'Executing...': '{{ _("Executing...") }}',
            'Executing iteration': '{{ _("Executing iteration") }}',
            'Please enter a SQL query': '{{ _("Please enter a SQL query") }}',
            'Generating SQL...': '{{ _("Generating SQL...") }}',
            'SQL generated successfully!': '{{ _("SQL generated successfully!") }}',
            'Error generating SQL:': '{{ _("Error generating SQL:") }}',
            'SQL inserted into editor': '{{ _("SQL inserted into editor") }}',
            'SQL copied to clipboard': '{{ _("SQL copied to clipboard") }}',
            'Command executed successfully': '{{ _("Command executed successfully") }}',
            'All commands executed successfully': '{{ _("All commands executed successfully") }}',
            'Executed commands': '{{ _("Executed commands") }}',
            'Script execution error': '{{ _("Script execution error") }}',
            'of': '{{ _("of") }}',
            'Query executed successfully. Found rows:': '{{ _("Query executed successfully. Found rows:") }}',
            'Iteration': '{{ _("Iteration") }}',
            'Prompt': '{{ _("Prompt") }}',
            'SQL': '{{ _("SQL") }}',
            'Stop': '{{ _("Stop") }}',
            'Stopped by user': '{{ _("Stopped by user") }}',
            'Ready to execute': '{{ _("Ready to execute") }}'
        };
        
        function t(key) {
            return translations[key] || key;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±—ç–∫–µ–Ω–¥–∞
        function translateBackendMessage(message) {
            if (!message) return message;
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª—é—á–∏-—Å–æ–æ–±—â–µ–Ω–∏—è
            if (message.startsWith('COMMAND_SUCCESS_ROWS:')) {
                const rows = message.split(':')[1];
                return t('Command executed successfully') + ` (${rows} ${t('rows')})`;
            }
            if (message === 'COMMAND_SUCCESS') {
                return t('Command executed successfully');
            }
            if (message.startsWith('QUERY_SUCCESS_ROWS:')) {
                const rows = message.split(':')[1];
                return t('Query executed successfully. Found rows:') + ' ' + rows;
            }
            if (message.startsWith('ALL_COMMANDS_SUCCESS:')) {
                const parts = message.split(':');
                const success = parts[1];
                const total = parts[2];
                return t('All commands executed successfully') + ` (${success} ${t('of')} ${total})`;
            }
            if (message.startsWith('COMMANDS_PARTIAL:')) {
                const parts = message.split(':');
                const success = parts[1];
                const total = parts[2];
                const errors = parts[3];
                return t('Executed commands') + ` ${success} ${t('of')} ${total}, ${t('Errors')}: ${errors}`;
            }
            if (message.startsWith('SCRIPT_ERROR:')) {
                const error = message.split(':').slice(1).join(':');
                return t('Script execution error') + ': ' + error;
            }
            
            return message;
        }
        
        // Escape HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ CLOB - —Å–æ–∫—Ä–∞—â–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π –¥–ª—è tooltip
        function formatCLOBCell(cellValue, maxLength = 100) {
            if (cellValue === null || cellValue === undefined) {
                return { display: '<em>NULL</em>', full: null, isClob: false };
            }
            
            const cellStr = String(cellValue);
            const isLong = cellStr.length > maxLength;
            
            if (isLong) {
                const truncated = cellStr.substring(0, maxLength) + '...';
                return {
                    display: escapeHtml(truncated),
                    full: cellStr, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è JSON –∏ tooltip
                    isClob: true,
                    length: cellStr.length
                };
            } else {
                return {
                    display: escapeHtml(cellStr),
                    full: null,
                    isClob: false
                };
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º tooltip —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è CLOB
        let clobTooltip = null;
        function createCLOBTooltip() {
            if (!clobTooltip) {
                clobTooltip = document.createElement('div');
                clobTooltip.className = 'clob-tooltip';
                clobTooltip.id = 'clobTooltip';
                document.body.appendChild(clobTooltip);
            }
            return clobTooltip;
        }
        
        // –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Å—É—â–Ω–æ—Å—Ç–µ–π
        function decodeHtmlEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è DDL –æ–±—ä–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ DBMS_METADATA.GET_DDL
        async function loadObjectDDL(objectType, objectName, schemaPrefix) {
            const resultsTable = document.getElementById('resultsTable');
            if (!resultsTable) return;
            
            // –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è DBMS_METADATA
            const ddlTypeMap = {
                'tables': 'TABLE',
                'views': 'VIEW',
                'materialized_views': 'MATERIALIZED_VIEW',
                'procedures': 'PROCEDURE',
                'functions': 'FUNCTION',
                'packages': 'PACKAGE',
                'sequences': 'SEQUENCE',
                'synonyms': 'SYNONYM',
                'indexes': 'INDEX',
                'triggers': 'TRIGGER',
                'types': 'TYPE'
            };
            
            const ddlType = ddlTypeMap[objectType] || 'TABLE';
            const fullName = schemaPrefix + objectName;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            resultsTable.innerHTML = `<div style="padding: 20px; text-align: center; color: #858585;">${t('Loading DDL...')}</div>`;
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è DDL
                let ddlQuery = '';
                const schemaName = schemaPrefix ? schemaPrefix.replace('.', '') : null;
                
                if (schemaName) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ö–µ–º–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è
                    ddlQuery = `SELECT DBMS_METADATA.GET_DDL('${ddlType}', '${objectName}', '${schemaName}') AS DDL FROM DUAL`;
                } else {
                    // –ë–µ–∑ —Å—Ö–µ–º—ã
                    ddlQuery = `SELECT DBMS_METADATA.GET_DDL('${ddlType}', '${objectName}') AS DDL FROM DUAL`;
                }
                
                const response = await fetch('/api/execute-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sql: ddlQuery })
                });
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned ${contentType || 'unknown'} instead of JSON. Status: ${response.status}. Response: ${text.substring(0, 200)}`);
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 500)}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const ddlText = data.data[0][0]; // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞, –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const jsonResult = {
                        object_type: ddlType,
                        object_name: fullName,
                        ddl: ddlText
                    };
                    
                    const jsonString = JSON.stringify(jsonResult, null, 2);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º DDL —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ AI
                    lastDDLResult = jsonResult;
                    // –û—á–∏—â–∞–µ–º SELECT —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Ç–∞–∫ –∫–∞–∫ DDL –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                    lastSelectResults = null;
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ JSON)
                    const jsonLines = jsonString.split('\n');
                    const previewLine = jsonLines.length > 0 ? jsonLines[0] : jsonString;
                    const ddlPreview = previewLine.length > 100 ? previewLine.substring(0, 100) + '...' : previewLine;
                    
                    let html = `<div style="margin-bottom: 15px;">
                        <strong style="color: #d4d4d4;">${t('DDL for')} ${escapeHtml(fullName)}:</strong>
                    </div>`;
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º details/summary –¥–ª—è —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–≥–æ—Å—è –±–ª–æ–∫–∞, –∫–∞–∫ —É JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    html += `<div style="background: #1e1e1e; padding: 15px; border-radius: 4px; border: 1px solid #3c3c3c; margin-bottom: 15px;">`;
                    html += `<details style="cursor: pointer;">`;
                    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º JSON –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ
                    const escapedJson = escapeHtml(jsonString).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    html += `<summary class="ddl-summary" style="color: #858585; font-size: 11px; margin-bottom: 5px; user-select: none; outline: none; padding: 5px; background: #252526; border-radius: 3px; cursor: pointer; position: relative;" data-ddl-full="${escapedJson}" title="Click to expand or hover to see full DDL">`;
                    html += `üìã DDL (${jsonString.length} chars) - <span style="color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 10px;">${escapeHtml(ddlPreview)}</span>`;
                    html += `</summary>`;
                    html += `<pre style="background: #252526; padding: 10px; border-radius: 3px; overflow: auto; max-height: 400px; font-size: 11px; color: #d4d4d4; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #3c3c3c; margin: 5px 0 0 0;">${escapeHtml(jsonString)}</pre>`;
                    html += `</details>`;
                    html += `</div>`;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–≤—Å—Ç–∞–≤–∏—Ç—å –≤ AI"
                    html += `<div style="margin-top: 10px;">
                        <button class="toolbar-btn primary" onclick="insertWorksheetToAI()" style="width: 100%;">
                            ü§ñ ${t('Insert into AI')}
                        </button>
                    </div>`;
                    
                    resultsTable.innerHTML = html;
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º tooltip –¥–ª—è DDL summary –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ HTML
                    setTimeout(() => {
                        const ddlSummary = resultsTable.querySelector('.ddl-summary');
                        if (ddlSummary) {
                            const tooltip = createCLOBTooltip();
                            ddlSummary.addEventListener('mouseenter', function(e) {
                                const fullText = this.getAttribute('data-ddl-full');
                                if (fullText) {
                                    const decodedText = decodeHtmlEntities(fullText);
                                    const rect = this.getBoundingClientRect();
                                    tooltip.textContent = decodedText;
                                    tooltip.style.left = (rect.right + 10) + 'px';
                                    tooltip.style.top = rect.top + 'px';
                                    
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
                                    setTimeout(() => {
                                        const tooltipRect = tooltip.getBoundingClientRect();
                                        if (tooltipRect.right > window.innerWidth) {
                                            tooltip.style.left = (rect.left - tooltipRect.width - 10) + 'px';
                                        }
                                        if (tooltipRect.bottom > window.innerHeight) {
                                            tooltip.style.top = (window.innerHeight - tooltipRect.height - 10) + 'px';
                                        }
                                    }, 10);
                                    
                                    tooltip.classList.add('show');
                                }
                            });
                            ddlSummary.addEventListener('mouseleave', function() {
                                tooltip.classList.remove('show');
                            });
                        }
                    }, 100);
                } else {
                    resultsTable.innerHTML = `<div class="error-message" style="padding: 15px;">
                        <strong>${t('Error')}:</strong><br>
                        <pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 10px;">${escapeHtml(data.message || 'Failed to get DDL')}</pre>
                    </div>`;
                }
            } catch (error) {
                console.error('DDL Load Error:', error);
                resultsTable.innerHTML = `<div class="error-message" style="padding: 15px;">
                    <strong>${t('Error')}:</strong><br>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 10px;">${escapeHtml(error.message)}</pre>
                </div>`;
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ SELECT –∑–∞–ø—Ä–æ—Å–æ–≤
        let lastSelectResults = null;
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ DDL —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        let lastDDLResult = null;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è HTML —Ç–∞–±–ª–∏—Ü—ã –≤ JSON
        function tableToJSON(tableElement) {
            const rows = tableElement.querySelectorAll('tbody tr');
            const headers = Array.from(tableElement.querySelectorAll('thead th')).map(th => {
                return (th.textContent || '').trim();
            });
            
            if (headers.length === 0 || rows.length === 0) {
                return null;
            }
            
            const data = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === headers.length) {
                    const rowData = {};
                    headers.forEach((header, index) => {
                        let cellText = cells[index].textContent || '';
                        // –£–±–∏—Ä–∞–µ–º –º–µ—Ç–∫–∏ [CLOB: X chars] –µ—Å–ª–∏ –µ—Å—Ç—å
                        cellText = cellText.replace(/\[CLOB:\s*\d+\s*chars\]/gi, '').trim();
                        rowData[header] = cellText || null;
                    });
                    data.push(rowData);
                }
            });
            
            return { columns: headers, data: data };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ SQL Worksheet –≤ AI –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
        function insertWorksheetToAI() {
            const aiDescription = document.getElementById('aiDescription');
            if (!aiDescription) {
                alert(t('AI Generator window is not open'));
                return;
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ SQL Worksheet
            let worksheetContent = '';
            
            // 1. SQL –∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            if (sqlEditorCM) {
                const sqlText = sqlEditorCM.getValue();
                if (sqlText.trim()) {
                    worksheetContent += '=== SQL Queries ===\n';
                    worksheetContent += sqlText + '\n\n';
                }
            } else {
                const sqlEditor = document.getElementById('sqlEditor');
                if (sqlEditor && sqlEditor.value.trim()) {
                    worksheetContent += '=== SQL Queries ===\n';
                    worksheetContent += sqlEditor.value + '\n\n';
                }
            }
            
            // 2. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ resultsTable
            const resultsTable = document.getElementById('resultsTable');
            if (resultsTable) {
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–∏–ø—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–µ –∏—Å–∫–ª—é—á–∞—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞
                
                // 2.1. DDL —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (lastDDLResult) {
                    const jsonString = JSON.stringify(lastDDLResult, null, 2);
                    worksheetContent += '=== DDL Result ===\n';
                    worksheetContent += jsonString + '\n\n';
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ DDL –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ resultsTable
                    const resultsTableHTML = resultsTable.innerHTML || '';
                    if (resultsTableHTML.includes('DDL for') || resultsTableHTML.includes('DDL –¥–ª—è') || resultsTableHTML.includes('DDL pentru')) {
                        // –ò—â–µ–º pre —ç–ª–µ–º–µ–Ω—Ç —Å JSON
                        const preElements = resultsTable.querySelectorAll('pre');
                        preElements.forEach(pre => {
                            const preText = pre.textContent || '';
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ DDL JSON - –∏—â–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø–æ–ª—è DDL
                            if (preText.includes('"ddl"') || (preText.includes('"object_type"') && preText.includes('"object_name"'))) {
                                // –î–æ–±–∞–≤–ª—è–µ–º DDL –∫–æ–Ω—Ç–µ–Ω—Ç - –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ JSON
                                try {
                                    // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å JSON –æ–±—ä–µ–∫—Ç
                                    const jsonMatch = preText.match(/\{[\s\S]*\}/);
                                    if (jsonMatch) {
                                        const jsonObj = JSON.parse(jsonMatch[0]);
                                        const jsonString = JSON.stringify(jsonObj, null, 2);
                                        worksheetContent += '=== DDL Result ===\n';
                                        worksheetContent += jsonString + '\n\n';
                                    } else {
                                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                                        worksheetContent += '=== DDL Result ===\n';
                                        worksheetContent += preText.trim() + '\n\n';
                                    }
                                } catch (e) {
                                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                                    worksheetContent += '=== DDL Result ===\n';
                                    worksheetContent += preText.trim() + '\n\n';
                                }
                            }
                        });
                    }
                }
                
                // 2.2. SELECT —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å) - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç DDL
                if (lastSelectResults && lastSelectResults.data && lastSelectResults.data.length > 0 && lastSelectResults.columns) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∏–º–µ–Ω–∞–º–∏ –∫–æ–ª–æ–Ω–æ–∫
                    const jsonData = lastSelectResults.data.map(row => {
                        const obj = {};
                        lastSelectResults.columns.forEach((col, idx) => {
                            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –º–∞—Å—Å–∏–≤ (–æ–±—ã—á–Ω—ã–π —Å–ª—É—á–∞–π)
                            if (Array.isArray(row)) {
                                obj[col] = row[idx] !== null && row[idx] !== undefined ? row[idx] : null;
                            } else {
                                // –ï—Å–ª–∏ row - –æ–±—ä–µ–∫—Ç
                                obj[col] = row[col] !== null && row[col] !== undefined ? row[col] : null;
                            }
                        });
                        return obj;
                    });
                    const jsonString = JSON.stringify(jsonData, null, 2);
                    worksheetContent += '=== SELECT Results ===\n';
                    worksheetContent += jsonString + '\n\n';
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å HTML —Ç–∞–±–ª–∏—Ü—ã
                    const tables = resultsTable.querySelectorAll('table');
                    if (tables.length > 0) {
                        tables.forEach(table => {
                            const jsonData = tableToJSON(table);
                            if (jsonData && jsonData.data.length > 0) {
                                // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã (jsonData.data —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—ä–µ–∫—Ç—ã)
                                const jsonString = JSON.stringify(jsonData.data, null, 2);
                                worksheetContent += '=== SELECT Results ===\n';
                                worksheetContent += jsonString + '\n\n';
                            }
                        });
                    }
                }
                
                // 2.3. –î—Ä—É–≥–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ç.–¥.), –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —è–≤–ª—è–µ—Ç—Å—è SELECT –∏–ª–∏ DDL
                const tables = resultsTable.querySelectorAll('table');
                if (tables.length === 0 && (!lastSelectResults || !lastSelectResults.data || lastSelectResults.data.length === 0) && !lastDDLResult) {
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = resultsTable.innerHTML;
                    
                    // –£–¥–∞–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–∫–Ω–æ–ø–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏)
                    // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ "Insert into AI" –∏ –≤–µ—Å—å –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π
                    const buttons = tempDiv.querySelectorAll('button[onclick*="insertWorksheetToAI"]');
                    buttons.forEach(btn => {
                        const buttonContainer = btn.closest('div');
                        if (buttonContainer && buttonContainer.style && buttonContainer.style.borderTop) {
                            buttonContainer.remove();
                        } else {
                            btn.remove();
                        }
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –±–ª–æ–∫–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ "Execution details", "–î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è" –∏ —Ç.–¥.
                    const allDivs = tempDiv.querySelectorAll('div');
                    allDivs.forEach(el => {
                        const text = el.textContent || '';
                        if (text.includes('–î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è') || 
                            text.includes('Execution details') ||
                            text.includes('Detalii executare') ||
                            (text.includes('–ö–æ–º–∞–Ω–¥–∞') && (text.includes('(SELECT)') || text.includes('(INSERT)') || text.includes('(UPDATE)'))) ||
                            (text.includes('Command') && (text.includes('(SELECT)') || text.includes('(INSERT)') || text.includes('(UPDATE)'))) ||
                            (text.includes('ComandƒÉ') && (text.includes('(SELECT)') || text.includes('(INSERT)') || text.includes('(UPDATE)'))) ||
                            text.includes('Insert into AI') ||
                            text.includes('–í—Å—Ç–∞–≤–∏—Ç—å –≤ AI') ||
                            text.includes('Inserare √Æn AI')) {
                            el.remove();
                        }
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –±–ª–æ–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
                    const executionDetails = tempDiv.querySelectorAll('div[class*="success-message"], div[class*="error-message"]');
                    executionDetails.forEach(el => {
                        const text = el.textContent || '';
                        if (text.includes('–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞') || 
                            text.includes('Command executed') ||
                            text.includes('ComandƒÉ executatƒÉ') ||
                            text.includes('Total commands') ||
                            text.includes('Total comenzi') ||
                            text.includes('–í—Å–µ–≥–æ –∫–æ–º–∞–Ω–¥') ||
                            text.includes('–í—Å–µ –∫–æ–º–∞–Ω–¥—ã') ||
                            text.includes('All commands') ||
                            text.includes('Toate comenzile') ||
                            (text.match(/‚úÖ.*[–ö–∫]–æ–º–∞–Ω–¥–∞/) || text.match(/‚úÖ.*Command/) || text.match(/‚úÖ.*ComandƒÉ/)) ||
                            text.includes('Success:') ||
                            text.includes('Succes:') ||
                            text.includes('–£—Å–ø–µ—à–Ω–æ:') ||
                            text.includes('Errors:') ||
                            text.includes('Erori:') ||
                            text.includes('–û—à–∏–±–∫–∏:') ||
                            text.includes('–∏–∑ 1)') ||
                            text.includes('of 1)')) {
                            el.remove();
                        }
                    });
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    
                    if (textContent.trim()) {
                        worksheetContent += '=== Other Results ===\n';
                        worksheetContent += textContent + '\n\n';
                    }
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –ø–æ–ª–µ AI (–Ω–µ –æ—á–∏—â–∞—è –µ–≥–æ)
            if (worksheetContent.trim()) {
                const currentContent = aiDescription.value.trim();
                if (currentContent) {
                    aiDescription.value = currentContent + '\n\n' + worksheetContent.trim();
                } else {
                    aiDescription.value = worksheetContent.trim();
                }
            }
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ AI
            aiDescription.focus();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const aiStatus = document.getElementById('aiStatus');
            if (aiStatus) {
                aiStatus.textContent = t('Content inserted successfully');
                aiStatus.style.color = '#89d185';
                setTimeout(() => {
                    aiStatus.textContent = '';
                }, 3000);
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è CLOB —è—á–µ–µ–∫
        function setupCLOBTooltips(container) {
            const clobCells = container.querySelectorAll('td[data-clob-full]');
            const tooltip = createCLOBTooltip();
            
            clobCells.forEach(cell => {
                cell.addEventListener('mouseenter', function(e) {
                    const encodedText = this.getAttribute('data-clob-full');
                    if (encodedText) {
                        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º HTML —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        const fullText = decodeHtmlEntities(encodedText);
                        const rect = this.getBoundingClientRect();
                        tooltip.textContent = fullText;
                        tooltip.style.left = (rect.right + 10) + 'px';
                        tooltip.style.top = rect.top + 'px';
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ tooltip –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
                        setTimeout(() => {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            if (tooltipRect.right > window.innerWidth) {
                                tooltip.style.left = (rect.left - tooltipRect.width - 10) + 'px';
                            }
                            if (tooltipRect.bottom > window.innerHeight) {
                                tooltip.style.top = (window.innerHeight - tooltipRect.height - 10) + 'px';
                            }
                        }, 10);
                        
                        tooltip.classList.add('show');
                    }
                });
                
                cell.addEventListener('mouseleave', function() {
                    tooltip.classList.remove('show');
                });
                
                cell.addEventListener('mousemove', function(e) {
                    if (tooltip.classList.contains('show')) {
                        const rect = this.getBoundingClientRect();
                        let left = rect.right + 10;
                        let top = rect.top;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –æ–∫–Ω–∞
                        setTimeout(() => {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            if (left + tooltipRect.width > window.innerWidth) {
                                left = rect.left - tooltipRect.width - 10;
                            }
                            if (top + tooltipRect.height > window.innerHeight) {
                                top = window.innerHeight - tooltipRect.height - 10;
                            }
                            tooltip.style.left = left + 'px';
                            tooltip.style.top = top + 'px';
                        }, 0);
                    }
                });
            });
        }
        
        // Initialize Socket.IO
        const socket = io();
        
        socket.on('connect', () => {
            console.log('Connected to server');
        });
        
        socket.on('error', (data) => {
            console.error('Socket error:', data);
        });
        
        // CodeMirror editors
        let sqlEditorCM = null;
        let aiGeneratedSQLCM = null;
        
        // Language switcher
        async function changeLanguage(lang) {
            try {
                const response = await fetch('/api/set-language', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lang: lang })
                });
                if (response.ok) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Language change error:', error);
            }
        }
        
        // Window management
        let windows = {};
        let zIndexCounter = 100;
        
        function openWindow(type) {
            if (type === 'sql-worksheet') {
                document.getElementById('sql-worksheet-window').classList.add('active');
                bringToFront('sql-worksheet-window');
            } else if (type === 'ai-generator') {
                document.getElementById('ai-generator-window').classList.add('active');
                bringToFront('ai-generator-window');
            } else if (type === 'combo-scenario') {
                document.getElementById('combo-scenario-window').classList.add('active');
                bringToFront('combo-scenario-window');
                checkAIStatus();
            } else if (type === 'dashboard') {
                window.location.href = '/UNA.md/orasldev/dashboard';
            }
        }
        
        function closeWindow(windowId) {
            document.getElementById(windowId).classList.remove('active');
        }
        
        function maximizeWindow(windowId) {
            const window = document.getElementById(windowId);
            window.classList.toggle('maximized');
        }
        
        function bringToFront(windowId) {
            const window = document.getElementById(windowId);
            window.style.zIndex = zIndexCounter++;
        }
        
        // Make windows draggable
        document.querySelectorAll('.mdi-window-header').forEach(header => {
            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            
            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                const window = header.closest('.mdi-window');
                initialX = e.clientX - window.offsetLeft;
                initialY = e.clientY - window.offsetTop;
                bringToFront(window.id);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    const window = header.closest('.mdi-window');
                    if (!window.classList.contains('maximized')) {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                        window.style.left = currentX + 'px';
                        window.style.top = currentY + 'px';
                    }
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        });
        
        // Execute SQL
        async function executeSQL() {
            let sql = '';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            if (sqlEditorCM) {
                const selection = sqlEditorCM.getSelection();
                if (selection && selection.trim()) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                    sql = selection.trim();
                } else {
                    // –ï—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç
                    sql = sqlEditorCM.getValue().trim();
                }
            } else {
                const editor = document.getElementById('sqlEditor');
                if (editor) {
                    // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ textarea –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    if (start !== end && end > start) {
                        // –ï—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                        sql = editor.value.substring(start, end).trim();
                    } else {
                        // –ù–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è - –≤–µ—Å—å —Ç–µ–∫—Å—Ç
                        sql = editor.value.trim();
                    }
                }
            }
            
            if (!sql) {
                alert(t('Please enter a SQL query'));
                return;
            }
            
            const resultsTable = document.getElementById('resultsTable');
            resultsTable.innerHTML = `<div style="padding: 20px; text-align: center; color: #858585;">${t('Executing...')}</div>`;
            
            try {
                const response = await fetch('/api/execute-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sql: sql })
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned ${contentType || 'unknown'} instead of JSON. Status: ${response.status}. Response: ${text.substring(0, 200)}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 500)}`);
                }
                
                const data = await response.json();
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥)
                if (data.script_results && data.script_results.length > 0) {
                    let html = `<div class="success-message" style="margin-bottom: 15px;">
                        <strong>${translateBackendMessage(data.message)}</strong><br>
                        ${t('Total commands')}: ${data.total_commands} | 
                        ${t('Success')}: <span style="color: #89d185;">${data.success_count}</span> | 
                        ${t('Errors')}: <span style="color: #f48771;">${data.error_count}</span>
                    </div>`;
                    
                    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –µ—Å—Ç—å SELECT)
                    if (data.data && data.data.length > 0 && data.columns) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ AI
                        lastSelectResults = {
                            columns: data.columns,
                            data: data.data
                        };
                        
                        html += `<div style="margin-bottom: 20px;"><strong>${t('Results')}:</strong></div>`;
                        html += '<div style="overflow: auto; max-height: 50vh;">';
                        html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr>';
                        data.columns.forEach(col => {
                            html += `<th style="background: #252526; color: #d4d4d4; padding: 8px; text-align: left; border-bottom: 1px solid #3c3c3c; position: sticky; top: 0; font-weight: 600;">${escapeHtml(String(col))}</th>`;
                        });
                        html += '</tr></thead><tbody>';
                        
                        data.data.forEach(row => {
                            html += '<tr>';
                            if (Array.isArray(row)) {
                                row.forEach((cell, cellIdx) => {
                                    const cellInfo = formatCLOBCell(cell);
                                    let cellHtml = '';
                                    if (cellInfo.isClob) {
                                        const escapedFull = String(cellInfo.full).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                        cellHtml = `<td class="clob-cell" style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e; cursor: help; max-width: 500px;" 
                                                    data-clob-full="${escapedFull}"
                                                    data-clob-length="${cellInfo.length}">
                                                    <span style="color: #858585; font-size: 10px;">[CLOB: ${cellInfo.length} chars]</span><br>
                                                    ${cellInfo.display}
                                                   </td>`;
                                    } else {
                                        cellHtml = `<td style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e;">${cellInfo.display}</td>`;
                                    }
                                    html += cellHtml;
                                });
                            } else {
                                data.columns.forEach(col => {
                                    const cellInfo = formatCLOBCell(row[col]);
                                    let cellHtml = '';
                                    if (cellInfo.isClob) {
                                        const escapedFull = String(cellInfo.full).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                        cellHtml = `<td class="clob-cell" style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e; cursor: help; max-width: 500px;" 
                                                    data-clob-full="${escapedFull}"
                                                    data-clob-length="${cellInfo.length}">
                                                    <span style="color: #858585; font-size: 10px;">[CLOB: ${cellInfo.length} chars]</span><br>
                                                    ${cellInfo.display}
                                                   </td>`;
                                    } else {
                                        cellHtml = `<td style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e;">${cellInfo.display}</td>`;
                                    }
                                    html += cellHtml;
                                });
                            }
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table>';
                        html += '</div>';
                    }
                    
                    // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
                    html += `<div style="margin-top: 20px; margin-bottom: 15px;"><strong>${t('Execution details')}:</strong></div>`;
                    html += '<div style="max-height: 400px; overflow-y: auto;">';
                    
                    data.script_results.forEach(result => {
                        const statusClass = result.success ? 'success-message' : 'error-message';
                        const statusIcon = result.success ? '‚úÖ' : '‚ùå';
                        const typeLabel = result.type || 'UNKNOWN';
                        
                        html += `<div class="${statusClass}" style="margin-bottom: 10px; padding: 10px; font-size: 12px;">`;
                        html += `<strong>${statusIcon} ${t('Command')} ${result.command_num} (${typeLabel}):</strong><br>`;
                        html += `<code style="font-size: 11px; color: #d4d4d4; word-break: break-all;">${escapeHtml(result.command)}</code><br>`;
                        html += `<span style="font-size: 11px;">${translateBackendMessage(result.message)}</span>`;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è SELECT –∑–∞–ø—Ä–æ—Å–æ–≤
                        if (result.success && result.data && Array.isArray(result.data) && result.data.length > 0 && result.columns && Array.isArray(result.columns)) {
                            html += '<div style="margin-top: 10px;">';
                            html += '<details style="cursor: pointer;">';
                            html += `<summary style="color: #858585; font-size: 11px; margin-bottom: 5px; user-select: none;">üìã JSON Result (${result.data.length} ${result.data.length === 1 ? 'row' : 'rows'})</summary>`;
                            
                            // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –æ–±—ä–µ–∫—Ç
                            try {
                                const jsonResult = result.data.map(row => {
                                    const obj = {};
                                    result.columns.forEach((col, idx) => {
                                        obj[col] = row[idx] !== null && row[idx] !== undefined ? row[idx] : null;
                                    });
                                    return obj;
                                });
                                
                                const jsonString = JSON.stringify(jsonResult, null, 2);
                                html += `<pre style="background: #1e1e1e; padding: 10px; border-radius: 3px; overflow: auto; max-height: 300px; font-size: 11px; color: #d4d4d4; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #3c3c3c;">${escapeHtml(jsonString)}</pre>`;
                            } catch (e) {
                                html += `<div style="color: #f48771; font-size: 11px;">Error formatting JSON: ${escapeHtml(e.message)}</div>`;
                            }
                            html += '</details>';
                            html += '</div>';
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–≤—Å—Ç–∞–≤–∏—Ç—å –≤ AI" –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫—Ä–∏–ø—Ç–∞
                    html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #3c3c3c;">
                        <button class="toolbar-btn primary" onclick="insertWorksheetToAI()" style="width: 100%;">
                            ü§ñ ${t('Insert into AI')}
                        </button>
                    </div>`;
                    
                    resultsTable.innerHTML = html;
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º tooltip –¥–ª—è CLOB —è—á–µ–µ–∫ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞
                    setTimeout(() => {
                        setupCLOBTooltips(resultsTable);
                    }, 100);
                }
                // –û–±—ã—á–Ω—ã–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
                else if (data.success) {
                    if (data.data && Array.isArray(data.data) && data.data.length > 0 && data.columns && Array.isArray(data.columns)) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ AI
                        lastSelectResults = {
                            columns: data.columns,
                            data: data.data
                        };
                        
                        const rowCount = data.rowcount || data.data.length;
                        let html = `<div class="success-message" style="margin-bottom: 10px; padding: 8px;">
                            <strong>‚úÖ ${t('Success')}</strong> - ${rowCount} ${t('rows')}
                        </div>`;
                        html += '<div style="overflow: auto; max-height: 70vh; background: #1e1e1e;">';
                        html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr>';
                        
                        data.columns.forEach(col => {
                            html += `<th style="background: #252526; color: #d4d4d4; padding: 8px; text-align: left; border-bottom: 1px solid #3c3c3c; position: sticky; top: 0; font-weight: 600;">${escapeHtml(String(col))}</th>`;
                        });
                        html += '</tr></thead><tbody>';
                        
                        data.data.forEach(row => {
                            html += '<tr>';
                            if (Array.isArray(row)) {
                                row.forEach((cell, cellIdx) => {
                                    const cellInfo = formatCLOBCell(cell);
                                    let cellHtml = '';
                                    if (cellInfo.isClob) {
                                        // CLOB —è—á–µ–π–∫–∞ —Å tooltip - –∏—Å–ø–æ–ª—å–∑—É–µ–º data-–∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                                        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HTML –∞—Ç—Ä–∏–±—É—Ç–∞—Ö
                                        const escapedFull = String(cellInfo.full).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                        cellHtml = `<td class="clob-cell" style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e; cursor: help; max-width: 500px;" 
                                                    data-clob-full="${escapedFull}"
                                                    data-clob-length="${cellInfo.length}">
                                                    <span style="color: #858585; font-size: 10px;">[CLOB: ${cellInfo.length} chars]</span><br>
                                                    ${cellInfo.display}
                                                   </td>`;
                                    } else {
                                        cellHtml = `<td style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e;">${cellInfo.display}</td>`;
                                    }
                                    html += cellHtml;
                                });
                            } else {
                                // –ï—Å–ª–∏ row - —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å columns –∫–∞–∫ –∫–ª—é—á–∏
                                data.columns.forEach(col => {
                                    const cellInfo = formatCLOBCell(row[col]);
                                    let cellHtml = '';
                                    if (cellInfo.isClob) {
                                        const escapedFull = String(cellInfo.full).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                        cellHtml = `<td class="clob-cell" style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e; cursor: help; max-width: 500px;" 
                                                    data-clob-full="${escapedFull}"
                                                    data-clob-length="${cellInfo.length}">
                                                    <span style="color: #858585; font-size: 10px;">[CLOB: ${cellInfo.length} chars]</span><br>
                                                    ${cellInfo.display}
                                                   </td>`;
                                    } else {
                                        cellHtml = `<td style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e;">${cellInfo.display}</td>`;
                                    }
                                    html += cellHtml;
                                });
                            }
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table>';
                        html += '</div>';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–≤—Å—Ç–∞–≤–∏—Ç—å –≤ AI"
                        html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #3c3c3c;">
                            <button class="toolbar-btn primary" onclick="insertWorksheetToAI()" style="width: 100%;">
                                ü§ñ ${t('Insert into AI')}
                            </button>
                        </div>`;
                        
                        resultsTable.innerHTML = html;
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º tooltip –¥–ª—è CLOB —è—á–µ–µ–∫
                        setTimeout(() => {
                            setupCLOBTooltips(resultsTable);
                        }, 100);
                    } else {
                        let html = `<div class="success-message" style="padding: 10px;">‚úÖ ${t('Query executed successfully. No rows returned.')}</div>`;
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–≤—Å—Ç–∞–≤–∏—Ç—å –≤ AI" –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                        html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #3c3c3c;">
                            <button class="toolbar-btn primary" onclick="insertWorksheetToAI()" style="width: 100%;">
                                ü§ñ ${t('Insert into AI')}
                            </button>
                        </div>`;
                        resultsTable.innerHTML = html;
                    }
                } else {
                    let html = `<div class="error-message" style="padding: 10px;">${t('Error:')} ${escapeHtml(data.message || 'Unknown error')}</div>`;
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–≤—Å—Ç–∞–≤–∏—Ç—å –≤ AI" –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #3c3c3c;">
                        <button class="toolbar-btn primary" onclick="insertWorksheetToAI()" style="width: 100%;">
                            ü§ñ ${t('Insert into AI')}
                        </button>
                    </div>`;
                    resultsTable.innerHTML = html;
                }
            } catch (error) {
                console.error('SQL Execution Error:', error);
                let errorMessage = error.message || 'Unknown error';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                if (errorMessage.includes('Unexpected token')) {
                    errorMessage = `Server returned invalid response. ${errorMessage}`;
                }
                
                resultsTable.innerHTML = `<div class="error-message" style="padding: 15px;">
                    <strong>${t('Error')}:</strong><br>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 10px;">${escapeHtml(errorMessage)}</pre>
                    <p style="font-size: 11px; color: #858585; margin-top: 10px;">
                        ${t('Please check the server logs for more details.')}
                    </p>
                </div>`;
            }
        }
        
        function clearEditor() {
            const confirmMessage = t('Clear SQL editor?') || 'Clear SQL editor?';
            if (confirm(confirmMessage)) {
                if (sqlEditorCM) {
                    sqlEditorCM.setValue('');
                    sqlEditorCM.focus();
                } else {
                    const editor = document.getElementById('sqlEditor');
                    if (editor) {
                        editor.value = '';
                        editor.focus();
                    }
                }
                const resultsTable = document.getElementById('resultsTable');
                if (resultsTable) {
                    resultsTable.innerHTML = `<div style="padding: 20px; text-align: center; color: #858585;">${t('No results. Execute a query to see results here.')}</div>`;
                }
                // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SELECT –∏ DDL
                lastSelectResults = null;
                lastDDLResult = null;
            }
        }
        
        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                fetch('/api/logout', { method: 'POST' })
                    .then(() => window.location.href = '/login');
            }
        }
        
        // Keyboard shortcuts
        document.getElementById('sqlEditor').addEventListener('keydown', function(e) {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'Enter')) {
                e.preventDefault();
                executeSQL();
            }
        });
        
        // Update time
        function updateTime() {
            document.getElementById('status-time').textContent = new Date().toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();
        
        // –¢–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞
        let currentSchema = '';
        
        // –§–∏–ª—å—Ç—Ä –æ–±—ä–µ–∫—Ç–æ–≤
        let objectFilter = '';
        let filterTimeout = null;
        let allObjectsCache = {}; // –ö—ç—à –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ —Ç–∏–ø–∞–º
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
        document.addEventListener('DOMContentLoaded', () => {
            const filterInput = document.getElementById('objectFilter');
            if (filterInput) {
                filterInput.addEventListener('input', (e) => {
                    const value = e.target.value.trim();
                    
                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
                    if (filterTimeout) {
                        clearTimeout(filterTimeout);
                    }
                    
                    // –ï—Å–ª–∏ –º–µ–Ω—å—à–µ 3 —Å–∏–º–≤–æ–ª–æ–≤, –æ—á–∏—â–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                    if (value.length < 3 && value.length > 0) {
                        return; // –ñ–¥–µ–º –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥–µ—Ç –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
                    filterTimeout = setTimeout(() => {
                        objectFilter = value;
                        applyFilter();
                    }, 2000);
                });
            }
        });
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º –æ–±—ä–µ–∫—Ç–∞–º
        function applyFilter() {
            const allTypes = ['tables', 'views', 'procedures', 'functions', 'packages', 
                            'sequences', 'synonyms', 'indexes', 'triggers', 'types', 'materialized_views'];
            
            allTypes.forEach(type => {
                const listElement = document.getElementById(type + '-list');
                if (!listElement) return;
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –∫—ç—à–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                if (!allObjectsCache[type]) return;
                
                const objects = allObjectsCache[type];
                const filterLower = objectFilter.toLowerCase();
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã
                const filtered = objectFilter.length >= 3
                    ? objects.filter(obj => {
                        const name = (obj.name || '').toLowerCase();
                        return name.includes(filterLower);
                    })
                    : objects;
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                listElement.innerHTML = '';
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
                filtered.forEach(obj => {
                    const item = document.createElement('div');
                    item.className = 'sidebar-item';
                    item.style.paddingLeft = '20px';
                    item.style.fontSize = '12px';
                    item.onclick = async () => {
                        const objectName = obj.name || obj;
                        const schemaPrefix = (obj.schema || currentSchema) 
                            ? `${obj.schema || currentSchema}.` 
                            : '';
                        const fullName = schemaPrefix + objectName;
                        
                        let insertText = '';
                        if (type === 'tables' || type === 'views' || type === 'materialized_views') {
                            insertText = `SELECT * FROM ${fullName};\n`;
                        } else if (type === 'sequences') {
                            insertText = `SELECT ${fullName}.NEXTVAL FROM DUAL;\n`;
                        } else if (type === 'synonyms') {
                            insertText = `SELECT * FROM ${fullName};\n`;
                        } else {
                            insertText = `-- ${type.slice(0, -1).toUpperCase()}: ${fullName}\n`;
                        }
                        
                        if (sqlEditorCM) {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º CodeMirror API - –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
                            const currentValue = sqlEditorCM.getValue();
                            sqlEditorCM.setValue(insertText + currentValue);
                            sqlEditorCM.setCursor(0, 0);
                            sqlEditorCM.focus();
                        } else {
                            const editor = document.getElementById('sqlEditor');
                            if (editor) {
                                editor.value = insertText + editor.value;
                                editor.focus();
                            }
                        }
                        
                        // –ü–æ–ª—É—á–∞–µ–º DDL —á–µ—Ä–µ–∑ DBMS_METADATA.GET_DDL
                        await loadObjectDDL(type, objectName, schemaPrefix);
                    };
                    item.innerHTML = `
                        <span class="sidebar-item-icon">${getObjectIcon(type.slice(0, -1))}</span>
                        <span class="sidebar-item-name">${obj.name || obj}</span>
                    `;
                    listElement.appendChild(item);
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                const countElement = document.getElementById(type + '-count');
                if (countElement) {
                    const totalCount = objects.length;
                    const filteredCount = filtered.length;
                    if (objectFilter.length >= 3 && filteredCount < totalCount) {
                        countElement.textContent = `(${filteredCount}/${totalCount})`;
                    } else {
                        countElement.textContent = `(${totalCount})`;
                    }
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ö–µ–º
        async function loadSchemas() {
            const schemaSelect = document.getElementById('schemaSelect');
            if (!schemaSelect) return Promise.resolve();
            
            schemaSelect.innerHTML = `<option value="">${t('Loading schemas...')}</option>`;
            schemaSelect.disabled = true;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000); // –¢–∞–π–º–∞—É—Ç 2 —Å–µ–∫—É–Ω–¥—ã
                
                const response = await fetch('/api/objects/schemas', {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned ${contentType || 'unknown'} instead of JSON. Status: ${response.status}. Response: ${text.substring(0, 200)}`);
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 500)}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.schemas && data.schemas.length > 0) {
                    schemaSelect.innerHTML = `<option value="">-- ${t('Current User')} --</option>`;
                    data.schemas.forEach(schema => {
                        const option = document.createElement('option');
                        option.value = schema.name;
                        option.textContent = schema.display_name;
                        schemaSelect.appendChild(option);
                    });
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    if (data.schemas.length > 0) {
                        const currentUser = data.schemas[0].name;
                        schemaSelect.value = currentUser;
                        currentSchema = currentUser;
                    }
                } else {
                    // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    schemaSelect.innerHTML = `<option value="">${t('Current User')}</option>`;
                    currentSchema = '';
                }
            } catch (error) {
                console.error('Error loading schemas:', error);
                // –ë—ã—Å—Ç—Ä—ã–π fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                schemaSelect.innerHTML = `<option value="">${t('Current User')}</option>`;
                currentSchema = '';
                schemaSelect.disabled = false;
            }
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã
        function changeSchema(schema) {
            currentSchema = schema || '';
            // –û—á–∏—â–∞–µ–º –∫—ç—à –∏ —Ñ–∏–ª—å—Ç—Ä
            allObjectsCache = {};
            objectFilter = '';
            const filterInput = document.getElementById('objectFilter');
            if (filterInput) {
                filterInput.value = '';
            }
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã
            const activeLists = ['tables', 'views', 'procedures', 'functions', 'packages', 
                                'sequences', 'synonyms', 'indexes', 'triggers', 'types', 'materialized_views'];
            activeLists.forEach(type => {
                const listElement = document.getElementById(type + '-list');
                if (listElement && listElement.innerHTML.trim() !== '' && !listElement.innerHTML.includes('Loading...')) {
                    loadObjects(type);
                }
            });
        }
        
        // Sidebar functions for database objects
        function toggleSection(sectionId) {
            const items = document.getElementById(sectionId + '-items');
            const toggle = document.getElementById(sectionId + '-toggle');
            if (items) {
                items.classList.toggle('sidebar-collapsed');
                toggle.textContent = items.classList.contains('sidebar-collapsed') ? '‚ñ∂' : '‚ñº';
            }
        }
        
        function getObjectIcon(type) {
            const icons = {
                'tables': 'üìä',
                'views': 'üëÅÔ∏è',
                'procedures': '‚öôÔ∏è',
                'functions': 'üîß',
                'packages': 'üì¶',
                'sequences': 'üî¢',
                'synonyms': 'üîó',
                'indexes': 'üìá',
                'triggers': '‚ö°',
                'types': 'üè∑Ô∏è',
                'materialized_views': 'üíæ',
                'table': 'üìã',
                'view': 'üëÅÔ∏è',
                'procedure': '‚öôÔ∏è',
                'function': 'üîß',
                'package': 'üì¶',
                'sequence': 'üî¢',
                'synonym': 'üîó',
                'index': 'üìá',
                'trigger': '‚ö°',
                'type': 'üè∑Ô∏è',
                'materialized_view': 'üíæ'
            };
            return icons[type] || 'üìÑ';
        }
        
        async function loadObjects(type) {
            const listId = type + '-list';
            const countId = type + '-count';
            const listElement = document.getElementById(listId);
            const countElement = document.getElementById(countId);
            
            if (!listElement) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            listElement.innerHTML = `<div style="padding: 5px; color: #858585; font-size: 11px;">${t('Loading...')}</div>`;
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä schema –≤ –∑–∞–ø—Ä–æ—Å
                const url = currentSchema 
                    ? `/api/objects/${type}?schema=${encodeURIComponent(currentSchema)}`
                    : `/api/objects/${type}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // –¢–∞–π–º–∞—É—Ç 10 —Å–µ–∫—É–Ω–¥
                
                const response = await fetch(url, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success && data.objects) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    allObjectsCache[type] = data.objects;
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
                    if (objectFilter.length >= 3) {
                        applyFilter();
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                    if (countElement) {
                        countElement.textContent = `(${data.count || data.objects.length})`;
                    }
                    
                    // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                    listElement.innerHTML = '';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã
                    data.objects.forEach(obj => {
                        const item = document.createElement('div');
                        item.className = 'sidebar-item';
                        item.style.paddingLeft = '20px';
                        item.style.fontSize = '12px';
                        item.onclick = async () => {
                            // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–±—ä–µ–∫—Ç –≤—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –∏–º—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                            const objectName = obj.name || obj;
                            const schemaPrefix = (obj.schema || currentSchema) 
                                ? `${obj.schema || currentSchema}.` 
                                : '';
                            const fullName = schemaPrefix + objectName;
                            
                            let insertText = '';
                            // –î–ª—è —Ç–∞–±–ª–∏—Ü –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π - SELECT, –¥–ª—è –ø—Ä–æ—Ü–µ–¥—É—Ä/—Ñ—É–Ω–∫—Ü–∏–π - –≤—ã–∑–æ–≤
                            if (type === 'tables' || type === 'views' || type === 'materialized_views') {
                                insertText = `SELECT * FROM ${fullName};\n`;
                            } else if (type === 'sequences') {
                                insertText = `SELECT ${fullName}.NEXTVAL FROM DUAL;\n`;
                            } else if (type === 'synonyms') {
                                insertText = `SELECT * FROM ${fullName};\n`;
                            } else {
                                insertText = `-- ${type.slice(0, -1).toUpperCase()}: ${fullName}\n`;
                            }
                            
                            if (sqlEditorCM) {
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º CodeMirror API - –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
                                const currentValue = sqlEditorCM.getValue();
                                sqlEditorCM.setValue(insertText + currentValue);
                                sqlEditorCM.setCursor(0, 0);
                                sqlEditorCM.focus();
                            } else {
                                const editor = document.getElementById('sqlEditor');
                                if (editor) {
                                    editor.value = insertText + editor.value;
                                    editor.focus();
                                }
                            }
                            
                            // –ü–æ–ª—É—á–∞–µ–º DDL —á–µ—Ä–µ–∑ DBMS_METADATA.GET_DDL
                            await loadObjectDDL(type, objectName, schemaPrefix);
                        };
                        item.innerHTML = `
                            <span class="sidebar-item-icon">${getObjectIcon(type.slice(0, -1))}</span>
                            <span class="sidebar-item-name">${obj.name || obj}</span>
                        `;
                        listElement.appendChild(item);
                    });
                    
                    if (data.objects.length === 0) {
                        listElement.innerHTML = '<div style="padding: 5px; color: #858585; font-size: 11px;">No objects found</div>';
                    }
                } else {
                    listElement.innerHTML = `<div style="padding: 5px; color: #f48771; font-size: 11px;">Error: ${data.error || 'Failed to load'}</div>`;
                }
            } catch (error) {
                listElement.innerHTML = `<div style="padding: 5px; color: #f48771; font-size: 11px;">Error: ${error.message}</div>`;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—è AI –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
        function clearAIDescription() {
            const aiDescription = document.getElementById('aiDescription');
            if (aiDescription) {
                aiDescription.value = '';
                aiDescription.focus();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const aiStatus = document.getElementById('aiStatus');
                if (aiStatus) {
                    aiStatus.textContent = t('Field cleared');
                    aiStatus.style.color = '#858585';
                    setTimeout(() => {
                        aiStatus.textContent = '';
                    }, 2000);
                }
            }
        }
        
        // AI Table Generator Functions
        async function checkAIStatus() {
            try {
                const response = await fetch('/api/ai-status');
                const data = await response.json();
                const statusEl = document.getElementById('aiStatus');
                
                if (data.success) {
                    if (data.ai_available) {
                        statusEl.textContent = '‚úÖ AI –¥–æ—Å—Ç—É–ø–µ–Ω';
                        statusEl.style.color = '#89d185';
                    } else {
                        statusEl.textContent = data.is_server ? '‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º (–∑–∞–≥–ª—É—à–∫–∞)' : '‚ö†Ô∏è AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∑–∞–≥–ª—É—à–∫–∞)';
                        statusEl.style.color = '#f48771';
                    }
                }
            } catch (error) {
                console.error('Error checking AI status:', error);
            }
        }
        
        async function generateTableSQL() {
            const description = document.getElementById('aiDescription').value.trim();
            const generateBtn = document.getElementById('aiGenerateBtn');
            const errorEl = document.getElementById('aiError');
            const statusEl = document.getElementById('aiStatus');
            
            if (!description) {
                errorEl.innerHTML = '<div class="error-message">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã</div>';
                errorEl.style.display = 'block';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
            errorEl.style.display = 'none';
            statusEl.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL...';
            statusEl.style.color = '#858585';
            
            try {
                const response = await fetch('/api/ai-generate-table', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: description,
                        use_ai: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const sqlText = data.sql || '';
                    if (aiGeneratedSQLCM) {
                        aiGeneratedSQLCM.setValue(sqlText);
                        aiGeneratedSQLCM.refresh();
                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è
                        setTimeout(() => {
                            if (aiGeneratedSQLCM) {
                                const container = aiGeneratedSQLCM.getWrapperElement().parentElement;
                                if (container) {
                                    const containerHeight = container.offsetHeight || container.clientHeight;
                                    aiGeneratedSQLCM.setSize(null, Math.max(300, containerHeight - 20));
                                    aiGeneratedSQLCM.refresh();
                                    aiGeneratedSQLCM.scrollTo(0, 0);
                                }
                            }
                        }, 100);
                    } else {
                        const aiEditor = document.getElementById('aiGeneratedSQL');
                        if (aiEditor) {
                            aiEditor.value = sqlText;
                        }
                    }
                    
                    if (data.note) {
                        statusEl.textContent = '‚ÑπÔ∏è ' + data.note;
                        statusEl.style.color = '#858585';
                    } else {
                        statusEl.textContent = '‚úÖ SQL —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω';
                        statusEl.style.color = '#89d185';
                    }
                    
                    errorEl.style.display = 'none';
                } else {
                    errorEl.innerHTML = `<div class="error-message">–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
                    errorEl.style.display = 'block';
                    statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
                    statusEl.style.color = '#f48771';
                }
            } catch (error) {
                errorEl.innerHTML = `<div class="error-message">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                errorEl.style.display = 'block';
                statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                statusEl.style.color = '#f48771';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SQL';
            }
        }
        
        function insertSQLToEditor() {
            const generatedSQL = aiGeneratedSQLCM ? aiGeneratedSQLCM.getValue().trim() : document.getElementById('aiGeneratedSQL').value.trim();
            
            if (!generatedSQL) {
                alert('–ù–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ SQL –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏');
                return;
            }
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º SQL –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
            if (sqlEditorCM) {
                const currentValue = sqlEditorCM.getValue();
                sqlEditorCM.setValue(generatedSQL + '\n\n' + currentValue);
                sqlEditorCM.focus();
                sqlEditorCM.setCursor(0, 0);
            } else {
                const sqlEditor = document.getElementById('sqlEditor');
                const currentValue = sqlEditor.value;
                sqlEditor.value = generatedSQL + '\n\n' + currentValue;
                sqlEditor.focus();
                sqlEditor.scrollTop = 0;
            }
        }
        
        async function copySQLToClipboard() {
            const generatedSQL = aiGeneratedSQLCM ? aiGeneratedSQLCM.getValue().trim() : document.getElementById('aiGeneratedSQL').value.trim();
            
            if (!generatedSQL) {
                alert('–ù–µ—Ç SQL –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(generatedSQL);
                const statusEl = document.getElementById('aiStatus');
                statusEl.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞';
                statusEl.style.color = '#89d185';
                
                setTimeout(() => {
                    checkAIStatus();
                }, 2000);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
            }
        }
        
        // Initialize CodeMirror editors
        function initCodeMirror() {
            // Oracle SQL keywords –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏
            CodeMirror.defineMode('oraclesql', function(config, parserConfig) {
                const sqlMode = CodeMirror.getMode(config, 'text/x-sql');
                return CodeMirror.overlayMode(sqlMode, {
                    token: function(stream, state) {
                        const ch = stream.next();
                        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ Oracle-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
                        if (stream.match(/^BEGIN\b/i) || stream.match(/^END\b/i) || 
                            stream.match(/^DECLARE\b/i) || stream.match(/^EXCEPTION\b/i) ||
                            stream.match(/^RAISE\b/i) || stream.match(/^CURSOR\b/i) ||
                            stream.match(/^TYPE\b/i) || stream.match(/^RECORD\b/i) ||
                            stream.match(/^TABLE\s+OF\b/i) || stream.match(/^VARRAY\b/i) ||
                            stream.match(/^PACKAGE\b/i) || stream.match(/^PROCEDURE\b/i) ||
                            stream.match(/^FUNCTION\b/i) || stream.match(/^TRIGGER\b/i)) {
                            return 'keyword';
                        }
                        return null;
                    }
                });
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SQL Editor
            const sqlEditorEl = document.getElementById('sqlEditor');
            if (sqlEditorEl) {
                sqlEditorCM = CodeMirror.fromTextArea(sqlEditorEl, {
                    mode: 'text/x-sql',
                    theme: 'monokai',
                    lineNumbers: true,
                    lineWrapping: true,
                    indentUnit: 4,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    styleActiveLine: true,
                    scrollbarStyle: 'simple',
                    extraKeys: {
                        "Ctrl-Space": "autocomplete",
                        "Ctrl-/": function(cm) {
                            cm.toggleComment({ indent: true, fillBlank: false });
                        }
                    },
                    placeholder: '-- Enter your SQL query here...\nSELECT * FROM DUAL;'
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                function updateSQLEditorSize() {
                    const container = sqlEditorCM.getWrapperElement().parentElement;
                    if (container) {
                        const containerHeight = container.offsetHeight || container.clientHeight;
                        sqlEditorCM.setSize(null, containerHeight - 20);
                        sqlEditorCM.refresh();
                    }
                }
                
                sqlEditorCM.on('change', function() {
                    updateSQLEditorSize();
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                const resizeObserver = new ResizeObserver(updateSQLEditorSize);
                if (sqlEditorCM.getWrapperElement().parentElement) {
                    resizeObserver.observe(sqlEditorCM.getWrapperElement().parentElement);
                }
                
                // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
                setTimeout(updateSQLEditorSize, 100);
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI Generated SQL Editor (readonly)
            const aiGeneratedSQLEl = document.getElementById('aiGeneratedSQL');
            if (aiGeneratedSQLEl) {
                aiGeneratedSQLCM = CodeMirror.fromTextArea(aiGeneratedSQLEl, {
                    mode: 'text/x-sql',
                    theme: 'monokai',
                    lineNumbers: true,
                    lineWrapping: true,
                    indentUnit: 4,
                    matchBrackets: true,
                    readOnly: true,
                    scrollbarStyle: 'simple',
                    placeholder: 'SQL —Å–∫—Ä–∏–ø—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...'
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                function updateAISQLEditorSize() {
                    const container = aiGeneratedSQLCM.getWrapperElement().parentElement;
                    if (container) {
                        const containerHeight = container.offsetHeight || container.clientHeight;
                        aiGeneratedSQLCM.setSize(null, Math.max(300, containerHeight - 20));
                        aiGeneratedSQLCM.refresh();
                    }
                }
                
                aiGeneratedSQLCM.on('change', function() {
                    updateAISQLEditorSize();
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —á–µ—Ä–µ–∑ setValue
                const originalSetValue = aiGeneratedSQLCM.setValue.bind(aiGeneratedSQLCM);
                aiGeneratedSQLCM.setValue = function(value) {
                    originalSetValue(value);
                    setTimeout(updateAISQLEditorSize, 10);
                };
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                const aiResizeObserver = new ResizeObserver(updateAISQLEditorSize);
                if (aiGeneratedSQLCM.getWrapperElement().parentElement) {
                    aiResizeObserver.observe(aiGeneratedSQLCM.getWrapperElement().parentElement);
                }
                
                // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
                setTimeout(updateAISQLEditorSize, 100);
            }
        }
        
        // Auto-load schemas and tables on page load
        window.addEventListener('load', () => {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º CodeMirror —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
            setTimeout(() => {
                initCodeMirror();
            }, 100);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ö–µ–º—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å —Ç–∞–π–º–∞—É—Ç–æ–º - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            Promise.race([
                loadSchemas(),
                new Promise((resolve) => setTimeout(() => resolve(), 2000)) // –ú–∞–∫—Å–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã
            ]).then(() => {
                // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ö–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
                setTimeout(() => {
                    loadObjects('tables');
                }, 500);
            }).catch((error) => {
                console.error('Schema loading failed:', error);
                // –í—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
                setTimeout(() => {
                    loadObjects('tables');
                }, 500);
            });
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ò–ò –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(() => {
                openWindow('ai-generator');
            }, 1000);
        });
        
        // ===== Combo Scenario Functions =====
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è
        let comboScenarioRunning = false;
        let comboScenarioStopped = false;
        
        function clearComboScenario() {
            document.getElementById('comboMainTask').value = '';
            document.getElementById('comboIterationsCount').value = '50';
            document.getElementById('comboIterativeTask').value = '';
            document.getElementById('comboLog').innerHTML = t('Log will appear here...');
            document.getElementById('comboStatus').textContent = t('Ready to execute');
            document.getElementById('comboStatus').style.color = '#858585';
            document.getElementById('comboProgressBar').style.width = '0%';
            document.getElementById('comboProgressText').textContent = t('Progress:') + ' 0/0';
            document.getElementById('comboProgressPercent').textContent = '0%';
            document.getElementById('comboError').style.display = 'none';
            comboScenarioRunning = false;
            comboScenarioStopped = false;
            const executeBtn = document.getElementById('comboExecuteBtn');
            const stopBtn = document.getElementById('comboStopBtn');
            executeBtn.disabled = false;
            executeBtn.textContent = '‚ñ∂Ô∏è ' + t('Execute Scenario');
            stopBtn.style.display = 'none';
            stopBtn.disabled = true;
        }
        
        function stopComboScenario() {
            comboScenarioStopped = true;
            comboScenarioRunning = false;
            const statusEl = document.getElementById('comboStatus');
            statusEl.textContent = t('Stopped by user');
            statusEl.style.color = '#f48771';
            
            const executeBtn = document.getElementById('comboExecuteBtn');
            const stopBtn = document.getElementById('comboStopBtn');
            executeBtn.disabled = false;
            executeBtn.textContent = '‚ñ∂Ô∏è ' + t('Execute Scenario');
            stopBtn.style.display = 'none';
            stopBtn.disabled = true;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ AI Generator –≤–∏–¥–∂–µ—Ç–∞
        function clearAIGeneratorWidget() {
            const aiDescription = document.getElementById('aiDescription');
            const aiGeneratedSQL = document.getElementById('aiGeneratedSQL');
            
            if (aiDescription) {
                aiDescription.value = '';
            }
            
            if (aiGeneratedSQL) {
                if (aiGeneratedSQLCM) {
                    aiGeneratedSQLCM.setValue('');
                    aiGeneratedSQLCM.refresh();
                } else {
                    aiGeneratedSQL.value = '';
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ SQL Worksheet –≤–∏–¥–∂–µ—Ç–∞
        function clearSQLWorksheetWidget() {
            // –û—á–∏—â–∞–µ–º SQL —Ä–µ–¥–∞–∫—Ç–æ—Ä
            if (sqlEditorCM) {
                sqlEditorCM.setValue('');
                sqlEditorCM.refresh();
            } else {
                const sqlEditor = document.getElementById('sqlEditor');
                if (sqlEditor) {
                    sqlEditor.value = '';
                }
            }
            
            // –û—á–∏—â–∞–µ–º results table
            const resultsTable = document.getElementById('resultsTable');
            if (resultsTable) {
                resultsTable.innerHTML = '<div style="padding: 20px; text-align: center; color: #858585;">' + 
                    t('No results. Execute a query to see results here.') + '</div>';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è AI Generator –≤–∏–¥–∂–µ—Ç–∞
        function updateAIGeneratorWidget(prompt, sqlResult) {
            const aiDescription = document.getElementById('aiDescription');
            const aiGeneratedSQL = document.getElementById('aiGeneratedSQL');
            
            if (aiDescription) {
                aiDescription.value = prompt;
            }
            
            if (sqlResult && aiGeneratedSQL) {
                if (aiGeneratedSQLCM) {
                    aiGeneratedSQLCM.setValue(sqlResult);
                    aiGeneratedSQLCM.refresh();
                } else {
                    aiGeneratedSQL.value = sqlResult;
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SQL Worksheet –≤–∏–¥–∂–µ—Ç–∞
        function updateSQLWorksheetWidget(sqlCode, executionResult) {
            // –û–±–Ω–æ–≤–ª—è–µ–º SQL —Ä–µ–¥–∞–∫—Ç–æ—Ä
            if (sqlEditorCM) {
                sqlEditorCM.setValue(sqlCode);
                sqlEditorCM.refresh();
            } else {
                const sqlEditor = document.getElementById('sqlEditor');
                if (sqlEditor) {
                    sqlEditor.value = sqlCode;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º results table —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            const resultsTable = document.getElementById('resultsTable');
            if (!resultsTable) return;
            
            if (executionResult && executionResult.success) {
                if (executionResult.data && Array.isArray(executionResult.data) && executionResult.data.length > 0 && executionResult.columns) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    const rowCount = executionResult.rowcount || executionResult.data.length;
                    let html = `<div class="success-message" style="margin-bottom: 10px; padding: 8px;">
                        <strong>‚úÖ ${t('Success')}</strong> - ${rowCount} ${t('rows')}
                    </div>`;
                    
                    html += '<div style="overflow: auto; max-height: 50vh;">';
                    html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr>';
                    executionResult.columns.forEach(col => {
                        html += `<th style="background: #252526; color: #d4d4d4; padding: 8px; text-align: left; border-bottom: 1px solid #3c3c3c; position: sticky; top: 0; font-weight: 600;">${escapeHtml(String(col))}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    executionResult.data.forEach(row => {
                        html += '<tr>';
                        if (Array.isArray(row)) {
                            row.forEach(cell => {
                                const cellInfo = formatCLOBCell(cell);
                                html += `<td style="padding: 8px; border-bottom: 1px solid #2d2d30; color: #d4d4d4; background: #1e1e1e;">${cellInfo.display}</td>`;
                            });
                        }
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                    resultsTable.innerHTML = html;
                } else {
                    // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —É—Å–ø–µ—à–Ω–æ
                    resultsTable.innerHTML = `<div class="success-message" style="padding: 10px;">
                        <strong>‚úÖ ${t('Command executed successfully')}</strong>
                    </div>`;
                }
            } else if (executionResult && !executionResult.success) {
                // –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                resultsTable.innerHTML = `<div class="error-message" style="padding: 10px;">
                    <strong>‚ùå ${t('Error')}:</strong> ${escapeHtml(executionResult.message || executionResult.error || 'Unknown error')}
                </div>`;
            }
        }
        
        async function executeComboScenario() {
            if (comboScenarioRunning) {
                return;
            }
            
            const mainTask = document.getElementById('comboMainTask').value.trim();
            const iterationsCount = parseInt(document.getElementById('comboIterationsCount').value);
            const iterativeTask = document.getElementById('comboIterativeTask').value.trim();
            
            if (!mainTask) {
                alert(t('Please enter main task'));
                return;
            }
            
            if (iterationsCount < 1 || iterationsCount > 1000) {
                alert(t('Iterations count must be between 1 and 1000'));
                return;
            }
            
            comboScenarioRunning = true;
            comboScenarioStopped = false;
            const executeBtn = document.getElementById('comboExecuteBtn');
            const stopBtn = document.getElementById('comboStopBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = '‚è≥ ' + t('Executing...');
            stopBtn.style.display = 'inline-block';
            stopBtn.disabled = false;
            
            const statusEl = document.getElementById('comboStatus');
            const logEl = document.getElementById('comboLog');
            const progressBar = document.getElementById('comboProgressBar');
            const progressText = document.getElementById('comboProgressText');
            const progressPercent = document.getElementById('comboProgressPercent');
            const errorEl = document.getElementById('comboError');
            
            statusEl.textContent = t('Executing scenario...');
            statusEl.style.color = '#007acc';
            errorEl.style.display = 'none';
            logEl.innerHTML = '';
            
            // –û—á–∏—â–∞–µ–º –≤–∏–¥–∂–µ—Ç—ã –û–î–ò–ù –†–ê–ó –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            clearAIGeneratorWidget();
            clearSQLWorksheetWidget();
            
            // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π
            const previousIterations = [];
            
            try {
                // –í—ã–ø–æ–ª–Ω—è–µ–º –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ –æ–¥–Ω–æ–π
                for (let i = 1; i <= iterationsCount; i++) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å—Ç–æ–ø
                    if (comboScenarioStopped) {
                        statusEl.textContent = t('Stopped by user');
                        statusEl.style.color = '#f48771';
                        break;
                    }
                    
                    statusEl.textContent = `${t('Executing iteration')} ${i}/${iterationsCount}...`;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    const percent = Math.round((i / iterationsCount) * 100);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = t('Progress:') + ` ${i}/${iterationsCount}`;
                    progressPercent.textContent = percent + '%';
                    
                    try {
                        const response = await fetch('/api/combo-scenario/execute-iteration', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                main_task: mainTask,
                                iterations_count: iterationsCount,
                                iterative_task: iterativeTask,
                                current_iteration: i,
                                previous_iterations: previousIterations
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success && data.iteration_result) {
                            const iterResult = data.iteration_result;
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π
                            previousIterations.push(iterResult);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º AI Generator –≤–∏–¥–∂–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                            updateAIGeneratorWidget(iterResult.prompt, iterResult.ai_response);
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º SQL Worksheet –≤–∏–¥–∂–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                            updateSQLWorksheetWidget(iterResult.ai_response, iterResult.sql_execution_result);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª–æ–≥
                            const iterDiv = document.createElement('div');
                            iterDiv.style.marginBottom = '10px';
                            iterDiv.style.padding = '10px';
                            iterDiv.style.background = '#252526';
                            iterDiv.style.border = '1px solid #3c3c3c';
                            iterDiv.style.borderRadius = '3px';
                            
                            const iterHeader = document.createElement('div');
                            iterHeader.style.fontWeight = 'bold';
                            iterHeader.style.marginBottom = '5px';
                            iterHeader.style.color = iterResult.error ? '#f48771' : '#4ec9b0';
                            iterHeader.textContent = `${t('Iteration')} ${iterResult.iteration_number}: ${iterResult.error ? t('Error') : t('Success')}`;
                            iterDiv.appendChild(iterHeader);
                            
                            const promptDiv = document.createElement('div');
                            promptDiv.style.marginBottom = '5px';
                            promptDiv.style.fontSize = '10px';
                            promptDiv.style.color = '#858585';
                            promptDiv.innerHTML = `<strong>${t('Prompt')}:</strong> ${escapeHtml(iterResult.prompt.substring(0, 200))}...`;
                            iterDiv.appendChild(promptDiv);
                            
                            const sqlDiv = document.createElement('div');
                            sqlDiv.style.marginBottom = '5px';
                            sqlDiv.style.fontSize = '10px';
                            sqlDiv.style.color = '#ce9178';
                            sqlDiv.innerHTML = `<strong>${t('SQL')}:</strong> <pre style="margin: 5px 0; white-space: pre-wrap;">${escapeHtml(iterResult.ai_response.substring(0, 500))}...</pre>`;
                            iterDiv.appendChild(sqlDiv);
                            
                            if (iterResult.error) {
                                const errorDiv = document.createElement('div');
                                errorDiv.style.color = '#f48771';
                                errorDiv.style.fontSize = '10px';
                                errorDiv.textContent = t('Error') + ': ' + iterResult.error;
                                iterDiv.appendChild(errorDiv);
                            } else if (iterResult.sql_execution_result && iterResult.sql_execution_result.success) {
                                const resultDiv = document.createElement('div');
                                resultDiv.style.fontSize = '10px';
                                resultDiv.style.color = '#4ec9b0';
                                resultDiv.textContent = t('SQL executed successfully');
                                iterDiv.appendChild(resultDiv);
                            }
                            
                            logEl.appendChild(iterDiv);
                            
                            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –ª–æ–≥ –≤–Ω–∏–∑
                            logEl.scrollTop = logEl.scrollHeight;
                            
                            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                        } else {
                            throw new Error(data.error || 'Unknown error');
                        }
                    } catch (iterError) {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–¥–Ω–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                        const errorIterDiv = document.createElement('div');
                        errorIterDiv.style.marginBottom = '10px';
                        errorIterDiv.style.padding = '10px';
                        errorIterDiv.style.background = '#252526';
                        errorIterDiv.style.border = '1px solid #f48771';
                        errorIterDiv.style.borderRadius = '3px';
                        errorIterDiv.innerHTML = `<div style="color: #f48771; font-weight: bold;">${t('Iteration')} ${i}: ${t('Error')}</div><div style="font-size: 10px; color: #f48771;">${escapeHtml(iterError.message)}</div>`;
                        logEl.appendChild(errorIterDiv);
                    }
                }
                
                statusEl.textContent = t('Scenario completed successfully');
                statusEl.style.color = '#4ec9b0';
                
            } catch (error) {
                statusEl.textContent = t('Error executing scenario');
                statusEl.style.color = '#f48771';
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                console.error('Combo scenario error:', error);
            } finally {
                comboScenarioRunning = false;
                executeBtn.disabled = false;
                executeBtn.textContent = '‚ñ∂Ô∏è ' + t('Execute Scenario');
                stopBtn.style.display = 'none';
                stopBtn.disabled = true;
                
                // –ï—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–µ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
                if (!comboScenarioStopped && statusEl.textContent.includes('Executing')) {
                    statusEl.textContent = t('Scenario completed successfully');
                    statusEl.style.color = '#4ec9b0';
                }
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>


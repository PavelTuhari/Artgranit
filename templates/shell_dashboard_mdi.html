<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>{{ project_name }} - Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Menu Bar */
        .menu-bar {
            background: #1e1e1e;
            border-bottom: 1px solid #3c3c3c;
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            z-index: 1000;
            transition: height 0.3s, opacity 0.3s;
        }
        
        body.fullscreen .menu-bar {
            display: none;
        }
        
        .menu-item {
            padding: 5px 12px;
            cursor: pointer;
            color: #d4d4d4;
            border-radius: 3px;
            margin-right: 5px;
            transition: background 0.2s;
        }
        
        .menu-item:hover {
            background: #3c3c3c;
        }
        
        .menu-item.active {
            background: #007acc;
            color: white;
        }
        
        .dashboard-tabs {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 5px;
        }
        
        .dashboard-tab {
            padding: 5px 12px;
            cursor: pointer;
            color: #d4d4d4;
            border-radius: 3px;
            transition: background 0.2s;
            font-size: 11px;
        }
        
        .dashboard-tab:hover {
            background: #3c3c3c;
        }
        
        .dashboard-tab.active {
            background: #007acc;
            color: white;
        }
        
        /* MDI Container */
        .mdi-container {
            height: calc(100vh - 30px);
            position: relative;
            background: #1e1e1e;
            overflow: hidden;
        }
        
        body.fullscreen .mdi-container {
            height: 100vh;
        }
        
        /* MDI Window */
        .mdi-window {
            position: absolute;
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            min-width: 300px;
            min-height: 200px;
            overflow: hidden;
        }
        
        /* Resize handles */
        .mdi-window-resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10;
        }
        
        /* –£–≥–ª–æ–≤—ã–µ handle */
        .mdi-window-resize-handle.nw {
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: nw-resize;
        }
        
        .mdi-window-resize-handle.ne {
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: ne-resize;
        }
        
        .mdi-window-resize-handle.sw {
            bottom: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: sw-resize;
        }
        
        .mdi-window-resize-handle.se {
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: se-resize;
        }
        
        /* –ë–æ–∫–æ–≤—ã–µ handle */
        .mdi-window-resize-handle.n {
            top: 0;
            left: 10px;
            right: 10px;
            height: 5px;
            cursor: n-resize;
        }
        
        .mdi-window-resize-handle.s {
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 5px;
            cursor: s-resize;
        }
        
        .mdi-window-resize-handle.e {
            top: 10px;
            bottom: 10px;
            right: 0;
            width: 5px;
            cursor: e-resize;
        }
        
        .mdi-window-resize-handle.w {
            top: 10px;
            bottom: 10px;
            left: 0;
            width: 5px;
            cursor: w-resize;
        }
        
        /* –û—Ç–∫–ª—é—á–∞–µ–º resize –¥–ª—è –º–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–∫–æ–Ω */
        .mdi-window.maximized .mdi-window-resize-handle {
            display: none;
        }
        
        .mdi-window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Resize handles */
        .mdi-window-resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10;
        }
        
        /* –£–≥–ª–æ–≤—ã–µ handle */
        .mdi-window-resize-handle.nw {
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: nw-resize;
        }
        
        .mdi-window-resize-handle.ne {
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: ne-resize;
        }
        
        .mdi-window-resize-handle.sw {
            bottom: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: sw-resize;
        }
        
        .mdi-window-resize-handle.se {
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: se-resize;
        }
        
        /* –ë–æ–∫–æ–≤—ã–µ handle */
        .mdi-window-resize-handle.n {
            top: 0;
            left: 10px;
            right: 10px;
            height: 5px;
            cursor: n-resize;
        }
        
        .mdi-window-resize-handle.s {
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 5px;
            cursor: s-resize;
        }
        
        .mdi-window-resize-handle.e {
            top: 10px;
            bottom: 10px;
            right: 0;
            width: 5px;
            cursor: e-resize;
        }
        
        .mdi-window-resize-handle.w {
            top: 10px;
            bottom: 10px;
            left: 0;
            width: 5px;
            cursor: w-resize;
        }
        
        /* –û—Ç–∫–ª—é—á–∞–µ–º resize –¥–ª—è –º–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–∫–æ–Ω */
        .mdi-window.maximized .mdi-window-resize-handle {
            display: none;
        }
        
        .mdi-window-header {
            background: #2d2d30;
            padding: 8px 12px;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            cursor: move;
            user-select: none;
        }
        
        .mdi-window-title {
            flex: 1;
            font-size: 12px;
            font-weight: 600;
        }
        
        .mdi-window-controls {
            display: flex;
            gap: 5px;
        }
        
        .mdi-window-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: #d4d4d4;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .mdi-window-btn:hover {
            background: #3c3c3c;
        }
        
        .mdi-window-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .mdi-window-content.mdi-window-content-embed {
            padding: 0;
            overflow: hidden;
        }
        
        /* Metric Card */
        .metric-card {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #007acc;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-card.warning {
            border-left-color: #ff9800;
        }
        
        .metric-card.danger {
            border-left-color: #f44336;
        }
        
        .metric-card.success {
            border-left-color: #4caf50;
        }
        
        .metric-title {
            font-size: 12px;
            color: #858585;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #d4d4d4;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            color: #858585;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #2d2d30;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007acc 0%, #005a9e 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, #ff9800 0%, #f57c00 100%);
        }
        
        .progress-fill.danger {
            background: linear-gradient(90deg, #f44336 0%, #d32f2f 100%);
        }
        
        .loading-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #3c3c3c;
            border-top: 2px solid #007acc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th {
            background: #2d2d30;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #d4d4d4;
            border-bottom: 2px solid #3c3c3c;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #2d2d30;
            color: #d4d4d4;
        }
        
        tr:hover {
            background: #2a2d2e;
        }
        
        /* ========================================
           RESPONSIVE DESIGN FOR MOBILE DEVICES
           ======================================== */
        
        /* Tablet devices (768px - 1024px) */
        @media screen and (max-width: 1024px) {
            .mdi-window {
                min-width: 250px;
                min-height: 180px;
            }
            
            .metric-value {
                font-size: 28px;
            }
            
            .mdi-window-content {
                padding: 15px;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 8px;
            }
        }
        
        /* Mobile devices (–¥–æ 768px) */
        @media screen and (max-width: 768px) {
            /* Menu Bar –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
            .menu-bar {
                height: auto;
                flex-wrap: wrap;
                padding: 8px 5px;
            }
            
            .menu-item {
                padding: 8px 10px;
                font-size: 11px;
                margin: 2px;
            }
            
            .dashboard-tabs {
                width: 100%;
                margin-top: 5px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .dashboard-tab {
                padding: 6px 10px;
                font-size: 10px;
                margin: 2px;
            }
            
            /* MDI Container - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .mdi-container {
                height: calc(100vh - 60px);
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                display: flex;
                flex-direction: column;
                align-items: stretch;
                padding: 10px;
                gap: 10px;
            }
            
            body.fullscreen .mdi-container {
                height: 100vh;
                padding: 10px;
            }
            
            /* MDI Windows - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–º–µ—Å—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
            .mdi-window {
                position: static !important;
                width: 100% !important;
                min-width: 100% !important;
                max-width: 100% !important;
                min-height: auto !important;
                height: auto !important;
                left: auto !important;
                top: auto !important;
                margin: 0 !important;
                margin-bottom: 10px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
            
            /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .mdi-window-header {
                padding: 6px 10px !important;
                min-height: 32px;
                display: flex;
                align-items: center;
                cursor: default !important; /* –û—Ç–∫–ª—é—á–∞–µ–º –∫—É—Ä—Å–æ—Ä move –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            }
            
            .mdi-window-title {
                font-size: 12px !important;
                font-weight: 600;
            }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ */
            .mdi-window-controls {
                gap: 4px;
            }
            
            .mdi-window-btn {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px !important;
                touch-action: manipulation;
            }
            
            .mdi-window-content {
                padding: 12px !important;
                font-size: 14px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Metric Cards */
            .metric-card {
                padding: 15px;
            }
            
            .metric-title {
                font-size: 11px;
            }
            
            .metric-value {
                font-size: 24px;
            }
            
            .metric-label {
                font-size: 12px;
            }
            
            /* Progress bars */
            .progress-bar {
                height: 24px;
            }
            
            /* Tables */
            table {
                font-size: 11px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            th, td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            
            /* –£–ª—É—á—à–∞–µ–º —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .mdi-window {
                box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            }
        }
        
        /* Small mobile devices (–¥–æ 480px) */
        @media screen and (max-width: 480px) {
            /* Menu Bar */
            .menu-bar {
                font-size: 11px;
            }
            
            .menu-item {
                padding: 6px 8px;
                font-size: 10px;
            }
            
            .dashboard-tab {
                padding: 5px 8px;
                font-size: 9px;
            }
            
            /* MDI Container - –µ—â–µ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π */
            .mdi-container {
                padding: 5px;
                gap: 8px;
            }
            
            /* MDI Windows - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ */
            .mdi-window {
                position: static !important;
                width: 100% !important;
                min-width: 100% !important;
                max-width: 100% !important;
                left: auto !important;
                top: auto !important;
                margin: 0 !important;
                margin-bottom: 8px !important;
            }
            
            /* –ï—â–µ –±–æ–ª–µ–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
            .mdi-window-header {
                padding: 5px 8px !important;
                min-height: 28px;
            }
            
            .mdi-window-title {
                font-size: 11px !important;
            }
            
            .mdi-window-btn {
                width: 24px !important;
                height: 24px !important;
                font-size: 12px !important;
            }
            
            .mdi-window-content {
                padding: 10px !important;
                font-size: 13px;
            }
            
            /* Metrics */
            .metric-value {
                font-size: 20px;
            }
            
            .metric-title {
                font-size: 10px;
            }
            
            /* Tables - –µ—â–µ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ */
            table {
                font-size: 10px;
            }
            
            th, td {
                padding: 6px 4px;
            }
        }
        
        /* Landscape orientation –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .mdi-window {
                min-height: auto !important;
            }
            
            .menu-bar {
                height: 28px;
            }
            
            .mdi-container {
                height: calc(100vh - 28px);
                padding: 8px;
                gap: 8px;
            }
            
            /* –ï—â–µ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ landscape */
            .mdi-window-header {
                padding: 4px 8px !important;
                min-height: 24px;
            }
            
            .mdi-window-title {
                font-size: 11px !important;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            /* –î–ª—è touch-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            .mdi-window-btn {
                min-width: 44px;
                min-height: 44px;
            }
            
            .dashboard-tab {
                min-height: 44px;
                padding: 10px 12px;
            }
            
            .menu-item {
                min-height: 44px;
                padding: 10px 12px;
            }
            
            /* –û—Ç–∫–ª—é—á–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ touch-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
            .metric-card:hover {
                transform: none;
            }
            
            /* –£–ª—É—á—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è touch */
            .mdi-window-header {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                touch-action: none;
            }
        }
        
        /* –í—ã—Å–æ–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –ø–∏–∫—Å–µ–ª–µ–π (Retina) */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .mdi-window {
                border-width: 0.5px;
            }
            
            .menu-bar {
                border-bottom-width: 0.5px;
            }
        }
        
        /* –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media screen and (max-width: 768px) {
            .mdi-window-content {
                scrollbar-width: thin;
                -webkit-overflow-scrolling: touch;
            }
            
            .mdi-window-content::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            
            .mdi-window-content::-webkit-scrollbar-thumb {
                background: #3c3c3c;
                border-radius: 4px;
            }
            
            .mdi-window-content::-webkit-scrollbar-track {
                background: #1e1e1e;
            }
        }
    </style>
</head>
<body{% if is_fullscreen %} class="fullscreen"{% endif %}>
    <!-- Menu Bar -->
    <div class="menu-bar"{% if is_fullscreen %} style="display: none;"{% endif %}>
        <a href="/una.md/shell/projects" class="menu-item" style="text-decoration: none; color: inherit;">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤</a>
        <div class="menu-item" onclick="window.location.href='/UNA.md/orasldev'">SQL Developer</div>
        <div class="menu-item active">Dashboard</div>
        <div class="dashboard-tabs" id="dashboardTabs">
            <!-- Dashboard tabs will be loaded dynamically -->
        </div>
        <a href="/UNA.md/orasldev/digi-sm" class="menu-item" style="text-decoration: none; color: inherit;" title="DIGI SM ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Å–∞–º–∏">‚öñÔ∏è DIGI SM</a>
        <a href="/UNA.md/orasldev/docs" class="menu-item" style="margin-left: 12px; text-decoration: none; color: inherit;" title="–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ DDL/DML —Å–∫—Ä–∏–ø—Ç—ã">üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a>
    </div>
    
    <!-- MDI Container -->
    <div class="mdi-container" id="mdiContainer">
        <!-- Widgets will be loaded dynamically -->
    </div>
    
    <script>
        // Global variables
        let currentDashboardId = null;
        let currentDashboardConfig = null;
        let zIndexCounter = 200;
        let activeSubscriptions = new Set();
        
        // Initialize Socket.IO
        const socket = io();
        
        socket.on('connect', () => {
            console.log('Connected to WebSocket server');
            // –ü–æ–¥–ø–∏—Å–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ dashboard'–∞
        });
        
        socket.on('metric_update', (data) => {
            if (data.success) {
                updateMetricDisplay(data.metric, data.data);
            }
        });
        
        socket.on('error', (data) => {
            console.error('Socket error:', data);
        });
        
        function subscribeToMetric(metricName) {
            if (!activeSubscriptions.has(metricName)) {
            socket.emit('subscribe_metric', { metric: metricName });
                activeSubscriptions.add(metricName);
            }
        }
        
        function unsubscribeFromMetric(metricName) {
            if (activeSubscriptions.has(metricName)) {
                socket.emit('unsubscribe_metric', { metric: metricName });
                activeSubscriptions.delete(metricName);
            }
        }
        
        // Load dashboard list and create tabs
        async function loadDashboardsList() {
            try {
                const response = await fetch('/api/dashboard/list?project_slug={{ project_slug }}');
                const data = await response.json();
                
                if (data.success && data.dashboards) {
                    const tabsContainer = document.getElementById('dashboardTabs');
                    tabsContainer.innerHTML = '';
                    
                    data.dashboards.forEach(dashboard => {
                        const tab = document.createElement('div');
                        tab.className = 'dashboard-tab';
                        tab.textContent = dashboard.dashboard_name;
                        tab.title = dashboard.dashboard_description || dashboard.dashboard_name;
                        tab.onclick = () => loadDashboard(dashboard.dashboard_id);
                        tabsContainer.appendChild(tab);
                    });
                    
                    // Load first dashboard by default
                    if (data.dashboards.length > 0) {
                        const firstDashboard = data.dashboards[0];
                        loadDashboard(firstDashboard.dashboard_id);
                    }
                } else {
                    console.error('Failed to load dashboards:', data.error);
                }
            } catch (error) {
                console.error('Error loading dashboards list:', error);
            }
        }
        
        // Load specific dashboard
        async function loadDashboard(dashboardId, skipTabsUpdate = false) {
            try {
                // Unsubscribe from all metrics
                activeSubscriptions.forEach(metric => unsubscribeFromMetric(metric));
                activeSubscriptions.clear();
                
                // Clear container - –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ–º –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã, –≤–∫–ª—é—á–∞—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                const container = document.getElementById('mdiContainer');
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                container.innerHTML = '';
                
                // Load dashboard config
                const response = await fetch(`/api/dashboard/config/${dashboardId}`);
                const data = await response.json();
                
                if (data.success && data.config) {
                    currentDashboardId = dashboardId;
                    currentDashboardConfig = data.config;
                    
                    // Update active tab (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤ fullscreen —Ä–µ–∂–∏–º–µ)
                    if (!skipTabsUpdate) {
                        document.querySelectorAll('.dashboard-tab').forEach(tab => {
                            tab.classList.remove('active');
                            if (tab.textContent === data.config.dashboard_name) {
                                tab.classList.add('active');
                            }
                        });
                    }
                    
                    // Create widgets - —Å–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞
                    createWidgets(data.config.widgets);
                    
                    // Load initial data for all widgets - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞
                    loadWidgetsData(data.config.widgets);
                    
                } else {
                    console.error('Failed to load dashboard config:', data.error);
                    container.innerHTML = `<div style="padding: 20px; color: #f48771;">Error loading dashboard: ${data.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                const container = document.getElementById('mdiContainer');
                container.innerHTML = `<div style="padding: 20px; color: #f48771;">Error: ${error.message}</div>`;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–≤–Ω–µ createWidgets –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É window)
        function checkIfMobileDevice() {
            try {
                if (typeof window !== 'undefined') {
                    return window.innerWidth <= 768 || 
                           (window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
                }
                return document.documentElement.clientWidth <= 768;
            } catch(e) {
                return document.documentElement.clientWidth <= 768;
            }
        }
        
        // Create widgets from config
        function createWidgets(widgets) {
            const container = document.getElementById('mdiContainer');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω—ã–º
            const isMobileDevice = checkIfMobileDevice();
            
            widgets.forEach(widget => {
                if (!widget.enabled) return;
                
                const isEmbed = widget.widget_type === 'embed' && widget.embed_url;
                const isDocumentation = widget.widget_type === 'documentation';
                const isLogging = widget.widget_type === 'logging';
                
                const windowElement = document.createElement('div');
                windowElement.className = 'mdi-window';
                windowElement.id = widget.window_id;
                windowElement.style.width = widget.size.width + 'px';
                windowElement.style.height = widget.size.height + 'px';
                windowElement.style.top = widget.position.top + 'px';
                windowElement.style.left = widget.position.left + 'px';
                windowElement.style.zIndex = widget.z_index;
                
                const header = document.createElement('div');
                header.className = 'mdi-window-header';
                
                const title = document.createElement('div');
                title.className = 'mdi-window-title';
                title.innerHTML = widget.title + (isEmbed || isDocumentation || isLogging ? '' : ' <span class="loading-indicator" id="' + widget.window_id + '-loading" style="display: none;"></span>');
                
                const controls = document.createElement('div');
                controls.className = 'mdi-window-controls';
                
                if (widget.maximizable) {
                    const maxBtn = document.createElement('button');
                    maxBtn.className = 'mdi-window-btn';
                    maxBtn.textContent = '‚ñ°';
                    maxBtn.onclick = () => maximizeWindow(widget.window_id);
                    controls.appendChild(maxBtn);
                }
                
                if (widget.closable) {
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'mdi-window-btn';
                    closeBtn.textContent = '√ó';
                    closeBtn.onclick = () => closeWindow(widget.window_id);
                    controls.appendChild(closeBtn);
                }
                
                header.appendChild(title);
                header.appendChild(controls);
                
                const content = document.createElement('div');
                content.className = 'mdi-window-content' + (isEmbed ? ' mdi-window-content-embed' : '');
                content.id = widget.window_id + '-content';
                if (isEmbed) {
                    const embedUrl = widget.embed_url.startsWith('/') ? widget.embed_url : (window.location.pathname.replace(/\/dashboard.*$/, '') + '/' + widget.embed_url);
                    content.style.position = 'relative';
                    content.innerHTML = '<iframe src="' + embedUrl.replace(/"/g, '&quot;') + '" style="position:absolute;top:0;left:0;width:100%;height:100%;min-height:280px;border:0;" title="' + (widget.title || 'Embed').replace(/"/g, '&quot;') + '"></iframe>';
                } else if (isDocumentation) {
                    content.innerHTML = '<div class="loading-indicator"></div> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...';
                } else if (isLogging) {
                    content.innerHTML = '<div class="loading-indicator"></div> –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...';
                } else {
                    content.innerHTML = '<div class="loading-indicator"></div> Loading...';
                }
                
                windowElement.appendChild(header);
                windowElement.appendChild(content);
                container.appendChild(windowElement);
                
                // Make draggable if enabled (–Ω–æ –Ω–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
                if (widget.draggable && !isMobileDevice) {
                    makeWindowDraggable(windowElement, header);
                } else if (widget.draggable) {
                    // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –æ—Ç–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∏ –∫—É—Ä—Å–æ—Ä "move"
                    header.style.cursor = 'default';
                    header.style.userSelect = 'auto';
                }
                
                // Make resizable if enabled (–Ω–æ –Ω–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
                if (widget.resizable && !isMobileDevice) {
                    makeWindowResizable(windowElement);
                }
            });
        }
        
        // Make window draggable
        function makeWindowDraggable(window, header) {
            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            
            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–º—ã—à—å –∏–ª–∏ touch)
            function getClientCoords(e) {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }
            
            // –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            function startDrag(e) {
                const coords = getClientCoords(e);
                isDragging = true;
                initialX = coords.x - window.offsetLeft;
                initialY = coords.y - window.offsetTop;
                bringToFront(window.id);
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
                if (e.touches) {
                    e.preventDefault();
                }
            }
            
            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            function drag(e) {
                if (!isDragging || window.classList.contains('maximized')) return;
                
                const coords = getClientCoords(e);
                e.preventDefault();
                
                currentX = coords.x - initialX;
                currentY = coords.y - initialY;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                const container = document.getElementById('mdiContainer');
                const containerRect = container.getBoundingClientRect();
                const windowRect = window.getBoundingClientRect();
                
                const maxX = containerRect.width - windowRect.width;
                const maxY = containerRect.height - windowRect.height;
                
                currentX = Math.max(0, Math.min(currentX, maxX));
                currentY = Math.max(0, Math.min(currentY, maxY));
                
                window.style.left = currentX + 'px';
                window.style.top = currentY + 'px';
            }
            
            // –û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            function stopDrag() {
                isDragging = false;
            }
            
            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—ã—à–∏
            header.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ touch-—Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            header.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', stopDrag);
            document.addEventListener('touchcancel', stopDrag);
        }
        
        // Make window resizable
        function makeWindowResizable(window) {
            const minWidth = 300;
            const minHeight = 200;
            let isResizing = false;
            let resizeHandle = null;
            let startX, startY, startWidth, startHeight, startLeft, startTop;
            
            // –°–æ–∑–¥–∞–µ–º resize handles
            const handles = [
                { className: 'nw', cursor: 'nw-resize' },
                { className: 'ne', cursor: 'ne-resize' },
                { className: 'sw', cursor: 'sw-resize' },
                { className: 'se', cursor: 'se-resize' },
                { className: 'n', cursor: 'n-resize' },
                { className: 's', cursor: 's-resize' },
                { className: 'e', cursor: 'e-resize' },
                { className: 'w', cursor: 'w-resize' }
            ];
            
            handles.forEach(handle => {
                const handleEl = document.createElement('div');
                handleEl.className = `mdi-window-resize-handle ${handle.className}`;
                handleEl.style.cursor = handle.cursor;
                window.appendChild(handleEl);
                
                handleEl.addEventListener('mousedown', (e) => startResize(e, handle.className));
            });
            
            function startResize(e, handle) {
                if (window.classList.contains('maximized')) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                isResizing = true;
                resizeHandle = handle;
                bringToFront(window.id);
                
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(window.style.width, 10);
                startHeight = parseInt(window.style.height, 10);
                startLeft = parseInt(window.style.left, 10);
                startTop = parseInt(window.style.top, 10);
                
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
            }
            
            function doResize(e) {
                if (!isResizing) return;
                
                e.preventDefault();
                
                const container = document.getElementById('mdiContainer');
                const containerRect = container.getBoundingClientRect();
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç handle
                if (resizeHandle.includes('e')) {
                    // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π
                    newWidth = Math.max(minWidth, startWidth + deltaX);
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–æ–π –≥—Ä–∞–Ω–∏—Ü–µ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    const maxWidth = containerRect.width - startLeft;
                    newWidth = Math.min(newWidth, maxWidth);
                }
                
                if (resizeHandle.includes('w')) {
                    // –õ–µ–≤—ã–π –∫—Ä–∞–π
                    newLeft = Math.max(0, startLeft + deltaX);
                    newWidth = Math.max(minWidth, startWidth - deltaX);
                    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞, –µ—Å–ª–∏ –æ–∫–Ω–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–∞–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É
                    if (newLeft + newWidth > containerRect.width) {
                        newWidth = containerRect.width - newLeft;
                    }
                }
                
                if (resizeHandle.includes('s')) {
                    // –ù–∏–∂–Ω–∏–π –∫—Ä–∞–π
                    newHeight = Math.max(minHeight, startHeight + deltaY);
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    const maxHeight = containerRect.height - startTop;
                    newHeight = Math.min(newHeight, maxHeight);
                }
                
                if (resizeHandle.includes('n')) {
                    // –í–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π
                    newTop = Math.max(0, startTop + deltaY);
                    newHeight = Math.max(minHeight, startHeight - deltaY);
                    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞, –µ—Å–ª–∏ –æ–∫–Ω–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É
                    if (newTop + newHeight > containerRect.height) {
                        newHeight = containerRect.height - newTop;
                    }
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                window.style.width = Math.max(minWidth, newWidth) + 'px';
                window.style.height = Math.max(minHeight, newHeight) + 'px';
                window.style.left = Math.max(0, newLeft) + 'px';
                window.style.top = Math.max(0, newTop) + 'px';
            }
            
            function stopResize() {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle = null;
                    document.removeEventListener('mousemove', doResize);
                    document.removeEventListener('mouseup', stopResize);
                }
            }
        }
        
        // Load data for all widgets
        async function loadWidgetsData(widgets) {
            const metricsToLoad = new Set();
            const customSqlWidgets = [];
            
            widgets.forEach(widget => {
                if (!widget.enabled) return;
                if (widget.widget_type === 'embed') return;
                if (widget.widget_type === 'documentation') {
                    // Documentation widgets are loaded separately
                    return;
                }
                if (widget.widget_type === 'logging') {
                    return;
                }
                if (widget.widget_type === 'custom_sql') {
                    customSqlWidgets.push(widget);
                } else if (widget.metric_name) {
                    metricsToLoad.add(widget.metric_name);
                    subscribeToMetric(widget.metric_name);
                }
            });
            
            // Load initial data for each metric
            for (const metricName of metricsToLoad) {
                try {
                    const response = await fetch(`/api/dashboard/metric/${metricName}`);
                    const data = await response.json();
                    if (data.success) {
                        updateMetricDisplay(data.metric, data.data);
                    }
                } catch (error) {
                    console.error(`Error loading ${metricName}:`, error);
                }
            }
            
            // Load data for custom SQL widgets
            for (const widget of customSqlWidgets) {
                try {
                    await loadCustomSqlWidget(widget);
                } catch (error) {
                    console.error(`Error loading custom SQL widget ${widget.widget_id}:`, error);
                    const contentId = widget.window_id + '-content';
                    const loadingId = widget.window_id + '-loading';
                    const contentEl = document.getElementById(contentId);
                    const loadingEl = document.getElementById(loadingId);
                    if (loadingEl) loadingEl.style.display = 'none';
                    if (contentEl) {
                        contentEl.innerHTML = `<div style="color: #f48771;">Error: ${error.message}</div>`;
                    }
                }
            }
            
            // Load documentation widgets
            const documentationWidgets = currentDashboardConfig?.widgets?.filter(w => w.widget_type === 'documentation' && w.enabled) || [];
            for (const widget of documentationWidgets) {
                try {
                    await loadDocumentationWidget(widget);
                } catch (error) {
                    console.error(`Error loading documentation widget ${widget.widget_id}:`, error);
                    const contentId = widget.window_id + '-content';
                    const contentEl = document.getElementById(contentId);
                    if (contentEl) {
                        contentEl.innerHTML = `<div style="color: #f48771;">–û—à–∏–±–∫–∞: ${escapeHtml(error.message)}</div>`;
                    }
                }
            }

            // Load logging widgets (Output / EasyCredit logs) - —Ç–æ–ª—å–∫–æ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞
            // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∏–¥–∂–µ—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Ç–µ–∫—É—â–µ–º—É –¥–∞—à–±–æ—Ä–¥—É (–ø—Ä–æ–≤–µ—Ä—è–µ–º window_id)
            const loggingWidgets = currentDashboardConfig?.widgets?.filter(w => 
                w.widget_type === 'logging' && 
                w.enabled && 
                document.getElementById(w.window_id + '-content') !== null
            ) || [];
            for (const widget of loggingWidgets) {
                try {
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –≤–∏–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ DOM
                    const contentEl = document.getElementById(widget.window_id + '-content');
                    if (!contentEl) {
                        console.warn(`Logging widget ${widget.window_id} not found in DOM, skipping`);
                        continue;
                    }
                    await loadLoggingWidget(widget);
                } catch (error) {
                    console.error(`Error loading logging widget ${widget.widget_id}:`, error);
                    const contentId = widget.window_id + '-content';
                    const contentEl = document.getElementById(contentId);
                    if (contentEl) {
                        contentEl.innerHTML = `<div style="color: #f48771;">–û—à–∏–±–∫–∞: ${escapeHtml(error.message)}</div>`;
                    }
                }
            }
        }
        
        // Load documentation widget data
        async function loadDocumentationWidget(widget) {
            const contentId = widget.window_id + '-content';
            const contentEl = document.getElementById(contentId);
            
            if (!contentEl) return;
            
            const dashboardId = widget.dashboard_id || currentDashboardId || '00';
            
            try {
                const response = await fetch(`/api/dashboard/documentation/${dashboardId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    contentEl.innerHTML = renderDocumentationHTML(result.data, dashboardId);
                } else {
                    contentEl.innerHTML = `<div style="color: #f48771;">–û—à–∏–±–∫–∞: ${escapeHtml(result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é')}</div>`;
                }
            } catch (error) {
                contentEl.innerHTML = `<div style="color: #f48771;">–û—à–∏–±–∫–∞: ${escapeHtml(error.message)}</div>`;
                throw error;
            }
        }

        async function loadLoggingWidget(widget) {
            const contentId = widget.window_id + '-content';
            const contentEl = document.getElementById(contentId);
            if (!contentEl) return;
            const wid = widget.window_id;
            try {
                const r = await fetch('/api/credit-logs?limit=500', { credentials: 'same-origin' });
                const j = await r.json().catch(function() { return {}; });
                if (r.status === 401) {
                    contentEl.innerHTML = '<div style="padding:12px;color:#dcdcaa;">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. <a href="/login" style="color:#4ec9b0;">–í–æ–π—Ç–∏</a></div>';
                    return;
                }
                if (j.success && Array.isArray(j.data)) {
                    contentEl.innerHTML = renderLoggingHTML(j.data, wid);
                } else {
                    contentEl.innerHTML = '<div style="color: #f48771;">–û—à–∏–±–∫–∞: ' + (j.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏') + '</div>';
                }
            } catch (e) {
                contentEl.innerHTML = '<div style="color: #f48771;">–û—à–∏–±–∫–∞: ' + String(e.message).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
                throw e;
            }
        }

        async function refreshLoggingWidget(windowId) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –ø–æ windowId, –±–µ–∑ –ø–æ–∏—Å–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∏–¥–∂–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è –º–µ–∂–¥—É –¥–∞—à–±–æ—Ä–¥–∞–º–∏
            const contentId = windowId + '-content';
            const contentEl = document.getElementById(contentId);
            if (!contentEl) {
                console.warn('Logging widget not found:', windowId);
                return;
            }
            try {
                const r = await fetch('/api/credit-logs?limit=500', { credentials: 'same-origin' });
                const j = await r.json().catch(function() { return {}; });
                if (r.status === 401) {
                    contentEl.innerHTML = '<div style="padding:12px;color:#dcdcaa;">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. <a href="/login" style="color:#4ec9b0;">–í–æ–π—Ç–∏</a></div>';
                    return;
                }
                if (j.success && Array.isArray(j.data)) {
                    contentEl.innerHTML = renderLoggingHTML(j.data, windowId);
                } else {
                    contentEl.innerHTML = '<div style="color: #f48771;">–û—à–∏–±–∫–∞: ' + (j.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏') + '</div>';
                }
            } catch (e) {
                contentEl.innerHTML = '<div style="color: #f48771;">–û—à–∏–±–∫–∞: ' + String(e.message).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
            }
        }

        async function clearAndRefreshLoggingWidget(windowId) {
            try {
                await fetch('/api/credit-logs/clear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin' });
            } catch (_) {}
            await refreshLoggingWidget(windowId);
        }

        function renderLoggingHTML(entries, windowId) {
            function esc(t) {
                if (t == null) return '';
                var d = document.createElement('div');
                d.textContent = String(t);
                return d.innerHTML;
            }
            var html = '<div class="credit-log-panel" style="display:flex;flex-direction:column;height:100%;min-height:200px;padding:0;">';
            html += '<div style="flex:0 0 auto;display:flex;gap:8px;padding:8px;background:#2d2d30;border-bottom:1px solid #3c3c3c;">';
            html += '<button type="button" onclick="refreshLoggingWidget(\'' + esc(windowId) + '\')" style="padding:4px 12px;background:#0e639c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">–û–±–Ω–æ–≤–∏—Ç—å</button>';
            html += '<button type="button" onclick="clearAndRefreshLoggingWidget(\'' + esc(windowId) + '\')" style="padding:4px 12px;background:#3c3c3c;color:#d4d4d4;border:1px solid #555;border-radius:4px;cursor:pointer;font-size:12px;">–û—á–∏—Å—Ç–∏—Ç—å</button>';
            html += '<span style="color:#858585;font-size:11px;align-self:center;margin-left:8px;">Output ¬∑ EasyCredit –∏ –∫—Ä–µ–¥–∏—Ç—ã. –ü–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª.</span>';
            html += '</div>';
            html += '<pre id="credit-log-output-' + esc(windowId) + '" style="flex:1;margin:0;padding:10px;overflow:auto;font-family:Consolas,Monaco,\'Courier New\',monospace;font-size:12px;line-height:1.4;background:#1e1e1e;color:#d4d4d4;white-space:pre-wrap;word-break:break-all;">';
            if (!entries || entries.length === 0) {
                html += esc('–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ EasyCredit (–ø—Ä–µ–¥–æ–¥–æ–±—Ä–µ–Ω–∏–µ, –∑–∞—è–≤–∫–∞, —Å—Ç–∞—Ç—É—Å) –∏–ª–∏ –≤ –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–∞—Ö.');
            } else {
                for (var i = 0; i < entries.length; i++) {
                    var e = entries[i];
                    var ts = (e.ts || '').replace('T', ' ').slice(0, 19);
                    var lv = (e.level || 'INFO').toUpperCase();
                    var src = e.source || '';
                    var msg = esc(e.message || '');
                    var color = lv === 'ERROR' ? '#f48771' : lv === 'WARN' ? '#dcdcaa' : '#4ec9b0';
                    html += '<span style="color:#858585;">[' + esc(ts) + ']</span> <span style="color:' + color + '">' + lv + '</span> ' + esc(src) + ' | ' + msg;
                    var pl = e.payload;
                    if (pl && typeof pl === 'object' && Object.keys(pl).length) {
                        try { html += ' ' + esc(JSON.stringify(pl)); } catch (_) {}
                    }
                    html += '\n';
                }
            }
            html += '</pre></div>';
            return html;
        }
        
        // Render documentation HTML
        function renderDocumentationHTML(docData, dashboardId) {
            function escapeHtml(text) {
                if (text == null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }
            
            let html = `<div style="padding: 10px;">`;
            html += `<h3 style="margin-bottom: 15px; color: #4ec9b0;">${escapeHtml(docData.dashboard_name || 'Dashboard')}</h3>`;
            html += `<p style="color: #858585; margin-bottom: 20px; font-size: 12px;">${escapeHtml(docData.dashboard_description || '')}</p>`;
            
            // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            html += `<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">`;
            html += `<a href="/UNA.md/orasldev/docs/dashboard/${dashboardId}" target="_blank" style="padding: 8px 16px; background: #4ec9b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; text-decoration: none; display: inline-block;">üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a>`;
            html += `<button onclick="downloadDDL('${dashboardId}')" style="padding: 8px 16px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üì• –°–∫–∞—á–∞—Ç—å DDL</button>`;
            html += `<button onclick="downloadDML('${dashboardId}')" style="padding: 8px 16px; background: #00cc66; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üì• –°–∫–∞—á–∞—Ç—å DML</button>`;
            html += `<button onclick="viewDDL('${dashboardId}')" style="padding: 8px 16px; background: #3c3c3c; color: white; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 12px;">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä DDL</button>`;
            html += `<button onclick="viewDML('${dashboardId}')" style="padding: 8px 16px; background: #3c3c3c; color: white; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 12px;">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä DML</button>`;
            html += `</div>`;
            
            // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—â—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
            html += `<div style="margin-top: 20px; margin-bottom: 15px; padding: 12px; background: #2d2d30; border-radius: 4px; border-left: 3px solid #4ec9b0;">`;
            html += `<div style="font-weight: 600; color: #4ec9b0; margin-bottom: 5px;">üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</div>`;
            html += `<div style="font-size: 11px; color: #858585; margin-bottom: 8px;">–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é, –¥–æ—Ä–∞–±–æ—Ç–∫–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥–∞—à–±–æ—Ä–¥–∞</div>`;
            html += `<a href="/UNA.md/orasldev/docs/dashboard/${dashboardId}" target="_blank" style="color: #007acc; text-decoration: none; font-size: 12px;">‚Üí –û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</a>`;
            html += `</div>`;
            
            // –û–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ, –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
            html += `<div style="margin-bottom: 15px; padding: 12px; background: #2d2d30; border-radius: 4px; border-left: 3px solid #007acc;">`;
            html += `<div style="font-weight: 600; color: #4ec9b0; margin-bottom: 8px;">üìö –û–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</div>`;
            html += `<div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">`;
            html += `<a href="/UNA.md/orasldev/docs" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí –û–±–∑–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏</a>`;
            html += `<a href="/UNA.md/orasldev/docs/deployment" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ</a>`;
            html += `<a href="/UNA.md/orasldev/docs/configuration" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</a>`;
            html += `</div>`;
            html += `</div>`;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–æ–≤ (04, 05, 06, 07)
            if (['04', '05', '06', '07'].indexOf(dashboardId) !== -1) {
                html += `<div style="margin-bottom: 15px; padding: 12px; background: #1e2d3a; border-radius: 4px; border-left: 3px solid #007acc;">`;
                html += `<div style="font-weight: 600; color: #4ec9b0; margin-bottom: 8px;">üìé –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã</div>`;
                html += `<div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">`;
                html += `<a href="/UNA.md/orasldev/docs/sql" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí DDL —Å–∫—Ä–∏–ø—Ç—ã</a>`;
                html += `<a href="/UNA.md/orasldev/docs/api" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a>`;
                if (dashboardId === '04') {
                    html += `<a href="/UNA.md/orasldev/docs/dashboard/05" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí Dashboard 05: –ö—Ä–µ–¥–∏—Ç—ã ‚Äî –û–ø–µ—Ä–∞—Ç–æ—Ä</a>`;
                }
                if (dashboardId === '05') {
                    html += `<a href="/UNA.md/orasldev/docs/dashboard/04" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí Dashboard 04: –ö—Ä–µ–¥–∏—Ç—ã ‚Äî –ê–¥–º–∏–Ω–∫–∞</a>`;
                }
                html += `<a href="/UNA.md/orasldev/docs/easycredit" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí Easy Credit API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a>`;
                html += `<a href="/UNA.md/orasldev/docs/cred-reports" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –æ—Ç—á—ë—Ç—ã</a>`;
                if (dashboardId === '06' || dashboardId === '07') {
                    html += `<a href="/UNA.md/orasldev/docs/iute" target="_blank" style="color: #60a5fa; text-decoration: none;">‚Üí Iute REST API</a>`;
                }
                html += `</div>`;
                html += `</div>`;
            }
            
            // –°–ø–∏—Å–æ–∫ –≤–∏–¥–∂–µ—Ç–æ–≤
            html += `<h4 style="margin-top: 20px; margin-bottom: 10px; color: #4ec9b0; font-size: 14px;">–í–∏–¥–∂–µ—Ç—ã (${docData.widgets?.length || 0}):</h4>`;
            
            if (docData.widgets && docData.widgets.length > 0) {
                html += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                docData.widgets.forEach((widget, idx) => {
                    html += `<div style="background: #2d2d30; padding: 12px; border-radius: 4px; border-left: 3px solid #007acc;">`;
                    html += `<div style="font-weight: 600; color: #4ec9b0; margin-bottom: 5px;">${idx + 1}. ${escapeHtml(widget.title || widget.widget_id)}</div>`;
                    html += `<div style="font-size: 11px; color: #858585; margin-bottom: 8px;">${escapeHtml(widget.description || '')}</div>`;
                    
                    html += `<div style="font-size: 11px; color: #858585;">`;
                    html += `<div><strong>–¢–∏–ø:</strong> ${escapeHtml(widget.widget_type || 'metric')}</div>`;
                    if (widget.metric_name) {
                        html += `<div><strong>–ú–µ—Ç—Ä–∏–∫–∞:</strong> ${escapeHtml(widget.metric_name)}</div>`;
                    }
                    if (widget.class_name && widget.method_name) {
                        html += `<div><strong>–ö–ª–∞—Å—Å:</strong> ${escapeHtml(widget.class_name)}.${escapeHtml(widget.method_name)}</div>`;
                    }
                    if (widget.embed_url) {
                        html += `<div><strong>URL:</strong> <code style="background: #1e1e1e; padding: 2px 4px; border-radius: 2px;">${escapeHtml(widget.embed_url)}</code></div>`;
                    }
                    html += `</div>`;
                    html += `</div>`;
                });
                html += `</div>`;
            } else {
                html += `<div style="color: #858585; font-size: 12px;">–í–∏–¥–∂–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        // Download DDL script
        async function downloadDDL(dashboardId) {
            try {
                const response = await fetch(`/api/dashboard/ddl/${dashboardId}`);
                const result = await response.json();
                if (result.success) {
                    const blob = new Blob([result.script], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `dashboard_${dashboardId}_ddl.sql`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å DDL'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // Download DML script
        async function downloadDML(dashboardId) {
            try {
                const response = await fetch(`/api/dashboard/dml/${dashboardId}`);
                const result = await response.json();
                if (result.success) {
                    const blob = new Blob([result.script], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `dashboard_${dashboardId}_dml.sql`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å DML'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // View DDL script in modal
        async function viewDDL(dashboardId) {
            try {
                const response = await fetch(`/api/dashboard/ddl/${dashboardId}`);
                const result = await response.json();
                if (result.success) {
                    showScriptModal(`DDL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ ${dashboardId}`, result.script);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å DDL'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // View DML script in modal
        async function viewDML(dashboardId) {
            try {
                const response = await fetch(`/api/dashboard/dml/${dashboardId}`);
                const result = await response.json();
                if (result.success) {
                    showScriptModal(`DML —Å–∫—Ä–∏–ø—Ç (–¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ) –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ ${dashboardId}`, result.script);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å DML'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // Show script in modal
        function showScriptModal(title, script) {
            function escapeHtml(text) {
                if (text == null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: #252526; border: 1px solid #3c3c3c; border-radius: 4px; width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;';
            
            const header = document.createElement('div');
            header.style.cssText = 'padding: 15px; border-bottom: 1px solid #3c3c3c; display: flex; justify-content: space-between; align-items: center;';
            header.innerHTML = `<h3 style="margin: 0; color: #4ec9b0;">${escapeHtml(title)}</h3><button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="background: #3c3c3c; color: white; border: none; border-radius: 3px; padding: 5px 10px; cursor: pointer;">√ó</button>`;
            
            const textarea = document.createElement('textarea');
            textarea.value = script;
            textarea.style.cssText = 'flex: 1; background: #1e1e1e; color: #d4d4d4; border: none; padding: 15px; font-family: monospace; font-size: 12px; resize: none; outline: none;';
            textarea.readOnly = true;
            
            const footer = document.createElement('div');
            footer.style.cssText = 'padding: 10px; border-top: 1px solid #3c3c3c; display: flex; justify-content: flex-end; gap: 10px;';
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
            copyBtn.style.cssText = 'padding: 6px 12px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(script).then(() => {
                    alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                }).catch(() => {
                    alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                });
            };
            footer.appendChild(copyBtn);
            
            content.appendChild(header);
            content.appendChild(textarea);
            content.appendChild(footer);
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // Load custom SQL widget data
        async function loadCustomSqlWidget(widget) {
            const loadingId = widget.window_id + '-loading';
            const contentId = widget.window_id + '-content';
            const loadingEl = document.getElementById(loadingId);
            const contentEl = document.getElementById(contentId);
            
            if (loadingEl) loadingEl.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/dashboard/widget/custom-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        database_type: widget.database_type || 'oracle',
                        sql_query: widget.sql_query || '',
                        connection_params: widget.connection_params || {}
                    })
                });
                
                const result = await response.json();
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                if (contentEl) {
                    if (result.success) {
                        contentEl.innerHTML = renderCustomSqlResults(result);
                    } else {
                        contentEl.innerHTML = `<div style="color: #f48771;">Error: ${escapeHtml(result.error || 'Unknown error')}</div>`;
                    }
                }
            } catch (error) {
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) {
                    contentEl.innerHTML = `<div style="color: #f48771;">Error: ${escapeHtml(error.message)}</div>`;
                }
                throw error;
            }
        }
        
        // Render custom SQL results in grid
        function renderCustomSqlResults(result) {
            function escapeHtml(text) {
                if (text == null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }
            
            if (!result.data || result.data.length === 0) {
                return `<div style="color: #858585; padding: 20px;">No data returned. ${result.message || ''}</div>`;
            }
            
            if (!result.columns || result.columns.length === 0) {
                return `<div style="color: #858585; padding: 20px;">No columns in result. ${result.message || ''}</div>`;
            }
            
            let html = `<div style="margin-bottom: 10px; font-size: 11px; color: #858585;">Rows: ${result.rowcount || 0}</div>`;
            html += '<table><thead><tr>';
            
            // Header row
            result.columns.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Data rows
            result.data.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${escapeHtml(cell)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // Update metric display
        function updateMetricDisplay(metricName, data) {
            // Try to find widget by metric_name
            const widget = currentDashboardConfig?.widgets?.find(w => w.metric_name === metricName);
            if (widget) {
                const loadingId = widget.window_id + '-loading';
                const contentId = widget.window_id + '-content';
                const loadingEl = document.getElementById(loadingId);
                const contentEl = document.getElementById(contentId);
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) {
                    contentEl.innerHTML = renderMetricHTML(metricName, data);
                }
            }
        }
        
        // Render metric HTML (keep existing implementation but simplified)
        function renderMetricHTML(metricName, data) {
            function escapeHtml(text) {
                if (text == null) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function getUsageClass(percent) {
                if (!percent) return '';
                if (percent > 90) return 'danger';
                if (percent > 75) return 'warning';
                return 'success';
            }
            
            let html = '';
            
            switch(metricName) {
                case 'instance':
                    html = `
                        <div class="metric-card success">
                            <div class="metric-title">Database Status</div>
                            <div class="metric-value">${escapeHtml(data.status || 'N/A')}</div>
                            <div class="metric-label">${escapeHtml(data.database_status || '')}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">Instance Name</div>
                            <div class="metric-value" style="font-size: 24px;">${escapeHtml(data.instance_name || 'N/A')}</div>
                            <div class="metric-label">${escapeHtml(data.host_name || '')}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">Version</div>
                            <div class="metric-value" style="font-size: 14px;">${escapeHtml(data.version || 'N/A')}</div>
                        </div>
                    `;
                    break;
                    
                case 'memory':
                    const memUsage = data.usage_percent || 0;
                    const memFree = data.free_gb || 0;
                    const memTotal = data.total_gb || 0;
                    html = `
                        <div class="metric-card ${getUsageClass(memUsage)}">
                            <div class="metric-title">Database Memory (SGA)</div>
                            <div class="metric-value">${memUsage.toFixed(2)}%</div>
                            <div class="metric-label">Free: ${memFree.toFixed(2)} GB / Total: ${memTotal.toFixed(2)} GB</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${getUsageClass(memUsage)}" style="width: ${memUsage}%">
                                    ${memUsage.toFixed(1)}%
                                </div>
                            </div>
                            <div style="margin-top: 10px; font-size: 11px; color: #858585;">
                                Used: ${(memTotal - memFree).toFixed(2)} GB | Free: ${memFree.toFixed(2)} GB
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'cpu':
                    const cpuUsage = data.usage_percent || 0;
                    html = `
                        <div class="metric-card ${getUsageClass(cpuUsage)}">
                            <div class="metric-title">CPU Usage</div>
                            <div class="metric-value">${cpuUsage.toFixed(2)}%</div>
                            <div class="metric-label">Current CPU Load</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${getUsageClass(cpuUsage)}" style="width: ${cpuUsage}%">
                                    ${cpuUsage.toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'sessions':
                    html = `
                        <div class="metric-card">
                            <div class="metric-title">Active Sessions</div>
                            <div class="metric-value">${data.active || 0}</div>
                            <div class="metric-label">Total: ${data.total || 0} | Inactive: ${data.inactive || 0}</div>
                        </div>
                    `;
                    break;
                    
                case 'tablespaces':
                    if (Array.isArray(data) && data.length > 0) {
                        html = '<table><thead><tr><th>Name</th><th>Total (MB)</th><th>Used (MB)</th><th>Free (MB)</th><th>Usage %</th></tr></thead><tbody>';
                        data.forEach(ts => {
                            html += `
                                <tr>
                                    <td><strong>${escapeHtml(ts.name)}</strong></td>
                                    <td>${ts.total_mb.toFixed(2)}</td>
                                    <td>${ts.used_mb.toFixed(2)}</td>
                                    <td>${ts.free_mb.toFixed(2)}</td>
                                    <td>
                                        <div class="progress-bar" style="height: 20px;">
                                            <div class="progress-fill ${getUsageClass(ts.used_percent)}" style="width: ${ts.used_percent}%">
                                                ${ts.used_percent.toFixed(1)}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        html += '</tbody></table>';
                    } else {
                        html = '<div style="color: #858585;">No tablespace data available</div>';
                    }
                    break;
                    
                case 'top_sql':
                    if (Array.isArray(data) && data.length > 0) {
                        html = '<table><thead><tr><th>SQL ID</th><th>SQL Text</th><th>Executions</th><th>Elapsed (sec)</th><th>CPU (sec)</th></tr></thead><tbody>';
                        data.forEach(sql => {
                            html += `
                                <tr>
                                    <td><code>${escapeHtml(sql.sql_id)}</code></td>
                                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(sql.sql_text || '')}">${escapeHtml(sql.sql_text || 'N/A')}</td>
                                    <td>${sql.executions || 0}</td>
                                    <td>${(sql.elapsed_seconds || 0).toFixed(2)}</td>
                                    <td>${(sql.cpu_seconds || 0).toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        html += '</tbody></table>';
                    } else {
                        html = '<div style="color: #858585;">No SQL data available</div>';
                    }
                    break;
                    
                case 'system':
                    if (data.memory && data.disk) {
                        const mem = data.memory;
                        const disk = data.disk;
                        html = `
                            <div style="margin-bottom: 20px;">
                                <div class="metric-title" style="font-size: 14px; margin-bottom: 10px;">üíæ Server Memory</div>
                                <div class="metric-card ${getUsageClass(mem.usage_percent)}">
                                    <div class="metric-value">${mem.usage_percent.toFixed(2)}%</div>
                                    <div class="metric-label">Free: ${mem.free_gb.toFixed(2)} GB / Total: ${mem.total_gb.toFixed(2)} GB</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${getUsageClass(mem.usage_percent)}" style="width: ${mem.usage_percent}%">
                                            ${mem.usage_percent.toFixed(1)}%
                                        </div>
                                    </div>
                                    <div style="margin-top: 8px; font-size: 11px; color: #858585;">
                                        Used: ${mem.used_gb.toFixed(2)} GB | Free: ${mem.free_gb.toFixed(2)} GB
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="metric-title" style="font-size: 14px; margin-bottom: 10px;">üíø Disk Space</div>
                                <div class="metric-card ${getUsageClass(disk.usage_percent)}">
                                    <div class="metric-value">${disk.usage_percent.toFixed(2)}%</div>
                                    <div class="metric-label">Free: ${disk.free_gb.toFixed(2)} GB / Total: ${disk.total_gb.toFixed(2)} GB</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${getUsageClass(disk.usage_percent)}" style="width: ${disk.usage_percent}%">
                                            ${disk.usage_percent.toFixed(1)}%
                                        </div>
                                    </div>
                                    <div style="margin-top: 8px; font-size: 11px; color: #858585;">
                                        Used: ${disk.used_gb.toFixed(2)} GB | Free: ${disk.free_gb.toFixed(2)} GB
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (data.error) {
                        html = `<div style="color: #f48771;">Error: ${escapeHtml(data.error)}</div><div style="color: #858585; font-size: 11px; margin-top: 10px;">Install psutil: pip install psutil</div>`;
                    } else {
                        html = '<div style="color: #858585;">System metrics not available</div>';
                    }
                    break;
                    
                case 'weather':
                    if (data.time || data.temperature !== undefined) {
                        const conditionIcon = data.condition_icon || 'üå§Ô∏è';
                        const condition = data.condition || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                        const temp = data.temperature !== undefined ? data.temperature : 'N/A';
                        const tempUnit = data.temperature_unit || '¬∞C';
                        const time = data.time || '--:--:--';
                        const date = data.date || '';
                        const day = data.day || '';
                        const location = data.location || '';
                        
                        html = `
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">${conditionIcon}</div>
                                    <div class="metric-value" style="font-size: 36px; margin-bottom: 5px;">${temp}${tempUnit}</div>
                                    <div class="metric-label" style="font-size: 14px; color: #858585;">${condition}</div>
                                    ${location ? `<div style="font-size: 11px; color: #858585; margin-top: 5px;">üìç ${escapeHtml(location)}</div>` : ''}
                                </div>
                                
                                <div style="border-top: 1px solid #3c3c3c; padding-top: 15px;">
                                    <div style="text-align: center;">
                                        <div class="metric-title" style="font-size: 12px; margin-bottom: 8px;">üïê –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</div>
                                        <div class="metric-value" style="font-size: 32px; margin-bottom: 5px;">${time}</div>
                                        ${date ? `<div class="metric-label" style="font-size: 12px; color: #858585;">${day}, ${date}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (data.error) {
                        html = `<div style="color: #f48771;">Error: ${escapeHtml(data.error)}</div>`;
                    } else {
                        html = '<div style="color: #858585;">–ü–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>';
                    }
                    break;
                    
                case 'departure_board':
                    if (data.departures && data.departures.length) {
                        const curTime = data.current_time || '--:--:--';
                        html = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid #3c3c3c;">
                                <div class="metric-title" style="font-size: 16px;">${escapeHtml(data.title || '–¢–∞–±–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π')}</div>
                                <div style="font-size: 24px; font-weight: 600; color: #4ec9b0;">${curTime}</div>
                            </div>
                            <table><thead><tr>
                                <th>–†–µ–π—Å</th><th>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th><th>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th><th>–í–æ—Ä–æ—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th>
                            </tr></thead><tbody>`;
                        data.departures.forEach(d => {
                            const statusClass = (d.status || '').toLowerCase().includes('–ø–æ—Å–∞–¥–∫–∞') ? 'success' : '';
                            html += `<tr>
                                <td><strong>${escapeHtml(d.route || '')}</strong></td>
                                <td>${escapeHtml(d.destination || '')}</td>
                                <td style="font-size: 18px;">${escapeHtml(d.departure || '')}</td>
                                <td>${escapeHtml(d.platform || '')}</td>
                                <td>${escapeHtml(d.gate || '‚Äî')}</td>
                                <td><span class="metric-card ${statusClass}" style="padding: 4px 10px; font-size: 12px;">${escapeHtml(d.status || '')}</span></td>
                            </tr>`;
                        });
                        html += '</tbody></table>';
                    } else if (data.error) {
                        html = `<div style="color: #f48771;">${escapeHtml(data.error)}</div>`;
                    } else {
                        html = '<div style="color: #858585;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–π—Å–∞—Ö</div>';
                    }
                    break;
                    
                default:
                    html = `<div style="color: #858585;">Unknown metric: ${escapeHtml(metricName)}</div>`;
                    console.warn(`Unknown metric type: ${metricName}`, data);
                    break;
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            if (text == null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        function maximizeWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window) {
            window.classList.toggle('maximized');
            }
        }
        
        function closeWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window) {
            window.style.display = 'none';
            }
        }
        
        function bringToFront(windowId) {
            const window = document.getElementById(windowId);
            if (window) {
            window.style.zIndex = zIndexCounter++;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // –ü–æ–ª—É—á–∞–µ–º dashboard_id –∏–∑ —à–∞–±–ª–æ–Ω–∞ –∏–ª–∏ URL
            const dashboardIdFromTemplate = {% if dashboard_id %}'{{ dashboard_id }}'{% else %}null{% endif %};
            const projectSlug = '{{ project_slug }}';
            const urlParams = new URLSearchParams(window.location.search);
            const dashboardIdFromUrl = urlParams.get('p');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º dashboard_id (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —à–∞–±–ª–æ–Ω > URL –ø–∞—Ä–∞–º–µ—Ç—Ä)
            const targetDashboardId = dashboardIdFromTemplate || dashboardIdFromUrl;
            
            // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π dashboard (fullscreen —Ä–µ–∂–∏–º)
            if (targetDashboardId) {
                // –í fullscreen —Ä–µ–∂–∏–º–µ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π dashboard –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
                loadDashboard(targetDashboardId, true);
            } else {
                // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö dashboard'–æ–≤
                loadDashboardsList();
            }
        });
    </script>
</body>
</html>


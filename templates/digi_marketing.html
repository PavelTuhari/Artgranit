<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGI Marketing - Управление мультимедийным контентом</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== Top Bar ===== */
        .top-bar {
            background: #16213e;
            border-bottom: 1px solid #0f3460;
            height: 48px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
        }
        .top-bar .logo {
            color: #53d769;
            font-weight: 700;
            font-size: 16px;
            letter-spacing: 1px;
            margin-right: 8px;
        }
        .top-bar .logo span { color: #e94560; }
        .top-bar .nav-item {
            padding: 6px 12px;
            cursor: pointer;
            color: #a0a0c0;
            border-radius: 4px;
            font-size: 12px;
            transition: all .2s;
            white-space: nowrap;
        }
        .top-bar .nav-item:hover { background: #0f3460; color: #fff; }
        .top-bar .nav-item.active { background: #e94560; color: #fff; }
        .top-bar .spacer { flex: 1; }
        .back-link {
            color: #8888aa;
            text-decoration: none;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .back-link:hover { color: #e94560; }

        /* ===== Main Layout ===== */
        .main-layout {
            display: flex;
            height: calc(100vh - 48px);
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: 250px;
            background: #16213e;
            border-right: 1px solid #0f3460;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-section {
            border-bottom: 1px solid #0f3460;
        }
        .sidebar-header {
            padding: 10px 14px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6c6c8a;
            font-weight: 600;
        }
        .sidebar-item {
            padding: 7px 14px 7px 24px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #b0b0c8;
            transition: all .15s;
        }
        .sidebar-item:hover { background: #0f3460; color: #fff; }
        .sidebar-item.active { background: #e94560; color: #fff; }

        /* ===== Stat Cards ===== */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 14px;
        }
        .stat-card .stat-label { font-size: 11px; color: #6c6c8a; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .stat-value { font-size: 28px; font-weight: 700; margin-top: 4px; }
        .stat-card .stat-sub { font-size: 11px; color: #8888aa; margin-top: 2px; }
        .stat-value.green { color: #53d769; }
        .stat-value.red { color: #e94560; }
        .stat-value.blue { color: #17a2b8; }
        .stat-value.yellow { color: #ffc107; }
        .stat-value.white { color: #e0e0e0; }

        /* ===== Content Area ===== */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* ===== Panels ===== */
        .panel { display: none; }
        .panel.active { display: block; }

        /* ===== Cards ===== */
        .card {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .card-header {
            padding: 12px 16px;
            background: #0f3460;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body { padding: 16px; }
        .card-header .btn { margin-left: auto; }

        /* ===== Form Controls ===== */
        .form-group { margin-bottom: 14px; }
        .form-group label {
            display: block;
            font-size: 12px;
            color: #8888aa;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 8px 12px;
            background: #1a1a2e;
            border: 1px solid #333366;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
            transition: border-color .2s;
        }
        .form-control:focus { outline: none; border-color: #e94560; }
        .form-control:disabled { opacity: 0.6; cursor: not-allowed; }
        select.form-control { cursor: pointer; }
        textarea.form-control { resize: vertical; min-height: 60px; font-family: inherit; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .form-row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }

        /* ===== Buttons ===== */
        .btn {
            padding: 8px 18px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all .2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #e94560; color: #fff; }
        .btn-primary:hover:not(:disabled) { background: #d63a55; }
        .btn-secondary { background: #333366; color: #e0e0e0; }
        .btn-secondary:hover:not(:disabled) { background: #444488; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-success:hover:not(:disabled) { background: #218838; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #c82333; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover:not(:disabled) { background: #e0a800; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }
        .btn-group { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

        /* ===== Table ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            background: #0f3460;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            color: #8888aa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #0f3460;
        }
        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #1a1a3e;
        }
        .data-table tr:hover td { background: #1a1a3e; }

        /* ===== Badges ===== */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-success { background: #28a74530; color: #53d769; }
        .badge-warning { background: #ffc10730; color: #ffc107; }
        .badge-danger { background: #dc354530; color: #e94560; }
        .badge-info { background: #17a2b830; color: #17a2b8; }
        .badge-secondary { background: #33336630; color: #8888aa; }

        /* ===== Media Grid ===== */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .media-card {
            background: #1a1a2e;
            border: 1px solid #333366;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: all .2s;
        }
        .media-card:hover { border-color: #e94560; transform: translateY(-2px); }
        .media-card.selected { border-color: #53d769; box-shadow: 0 0 0 2px #53d76940; }
        .media-thumb {
            height: 120px;
            background: #0a0a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #333366;
        }
        .media-thumb.image { color: #17a2b8; }
        .media-thumb.video { color: #e94560; }
        .media-info {
            padding: 10px;
        }
        .media-info .name { font-size: 13px; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .media-info .meta { font-size: 11px; color: #6c6c8a; }
        .media-info .tags { margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px; }
        .media-info .tag { background: #33336650; padding: 1px 6px; border-radius: 8px; font-size: 10px; color: #a0a0c0; }

        /* ===== Loading / Empty ===== */
        .loading { text-align: center; padding: 40px; color: #6c6c8a; }
        .spinner {
            display: inline-block;
            width: 24px; height: 24px;
            border: 3px solid #333366;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin .8s linear infinite;
            margin-bottom: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 40px; color: #6c6c8a; }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; }

        /* ===== Modal ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            width: 600px;
            max-width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 14px 16px;
            border-bottom: 1px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #16213e;
            z-index: 1;
        }
        .modal-header h3 { font-size: 15px; }
        .modal-close { background: none; border: none; color: #888; cursor: pointer; font-size: 18px; }
        .modal-body { padding: 16px; }
        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid #0f3460;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            position: sticky;
            bottom: 0;
            background: #16213e;
        }

        /* ===== Tabs ===== */
        .tab-bar { display: flex; border-bottom: 1px solid #0f3460; margin-bottom: 16px; }
        .tab-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            color: #8888aa;
            border-bottom: 2px solid transparent;
            transition: all .2s;
        }
        .tab-item:hover { color: #e0e0e0; }
        .tab-item.active { color: #e94560; border-bottom-color: #e94560; }

        /* ===== Log ===== */
        .log-area {
            background: #0a0a1a;
            border: 1px solid #333366;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 250px;
            overflow-y: auto;
        }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #111133; }
        .log-time { color: #555577; }
        .log-success { color: #53d769; }
        .log-error { color: #e94560; }
        .log-info { color: #17a2b8; }
        .log-warn { color: #ffc107; }

        /* ===== Targeting checkboxes ===== */
        .target-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333366;
            border-radius: 4px;
            padding: 8px;
            background: #1a1a2e;
        }
        .target-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 13px;
            cursor: pointer;
        }
        .target-item:hover { color: #fff; }

        /* ===== Scrollbar ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #333366; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444488; }

        .section-title { font-size: 18px; margin-bottom: 16px; font-weight: 600; }
        .toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .toolbar .search-input {
            padding: 7px 12px;
            background: #1a1a2e;
            border: 1px solid #333366;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
            width: 250px;
        }
        .toolbar .search-input:focus { outline: none; border-color: #e94560; }
    </style>
</head>
<body>

<!-- ===== Top Bar ===== -->
<div class="top-bar">
    <div class="logo">DIGI<span>MARKETING</span></div>
    <div class="nav-item active" data-panel="dashboard" onclick="showPanel('dashboard')">Dashboard</div>
    <div class="nav-item" data-panel="stores" onclick="showPanel('stores')">Магазины</div>
    <div class="nav-item" data-panel="devices" onclick="showPanel('devices')">Устройства</div>
    <div class="nav-item" data-panel="media" onclick="showPanel('media')">Медиа</div>
    <div class="nav-item" data-panel="playlists" onclick="showPanel('playlists')">Плейлисты</div>
    <div class="nav-item" data-panel="campaigns" onclick="showPanel('campaigns')">Кампании</div>
    <div class="nav-item" data-panel="monitoring" onclick="showPanel('monitoring')">Мониторинг</div>
    <div class="spacer"></div>
    <a href="/UNA.md/orasldev" class="back-link">&#8592; SQL Developer</a>
</div>

<!-- ===== Main Layout ===== -->
<div class="main-layout">

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-header">Быстрые действия</div>
            <div class="sidebar-item" onclick="showModal('storeModal')">+ Новый магазин</div>
            <div class="sidebar-item" onclick="showModal('deviceModal')">+ Новое устройство</div>
            <div class="sidebar-item" onclick="showModal('mediaModal')">+ Загрузить медиа</div>
            <div class="sidebar-item" onclick="showModal('playlistModal')">+ Новый плейлист</div>
            <div class="sidebar-item" onclick="showModal('campaignModal')">+ Новая кампания</div>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-header">Система</div>
            <div class="sidebar-item" onclick="loadDemoData()">&#9881; Загрузить демо-данные</div>
            <div class="sidebar-item" onclick="refreshAll()">&#8635; Обновить всё</div>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-header">Лог операций <span style="cursor:pointer; float:right;" onclick="clearLog()">&#10005;</span></div>
            <div id="sidebarLog" style="padding: 4px 8px; font-size:11px; font-family:monospace; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">

        <!-- ===== Panel: Dashboard ===== -->
        <div class="panel active" id="panel-dashboard">
            <h2 class="section-title">Dashboard</h2>
            <div class="stat-grid" id="statsGrid">
                <div class="stat-card"><div class="stat-label">Магазины</div><div class="stat-value white" id="statStores">0</div></div>
                <div class="stat-card"><div class="stat-label">Устройства</div><div class="stat-value blue" id="statDevices">0</div><div class="stat-sub" id="statDevicesSub">online: 0</div></div>
                <div class="stat-card"><div class="stat-label">Медиафайлы</div><div class="stat-value yellow" id="statMedia">0</div><div class="stat-sub" id="statMediaSub">-</div></div>
                <div class="stat-card"><div class="stat-label">Плейлисты</div><div class="stat-value white" id="statPlaylists">0</div></div>
                <div class="stat-card"><div class="stat-label">Активные кампании</div><div class="stat-value green" id="statCampaigns">0</div><div class="stat-sub" id="statCampaignsSub">-</div></div>
            </div>

            <div class="card">
                <div class="card-header">Последние события</div>
                <div class="card-body" id="dashboardEvents" style="padding:0;">
                    <div class="empty-state">Нет событий</div>
                </div>
            </div>
        </div>

        <!-- ===== Panel: Stores ===== -->
        <div class="panel" id="panel-stores">
            <h2 class="section-title">Магазины</h2>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showModal('storeModal')">+ Новый магазин</button>
                <button class="btn btn-secondary" onclick="loadStores()">&#8635; Обновить</button>
            </div>
            <div class="card">
                <div class="card-body" style="padding:0;">
                    <div id="storesTable"><div class="empty-state">Загрузка...</div></div>
                </div>
            </div>
        </div>

        <!-- ===== Panel: Devices ===== -->
        <div class="panel" id="panel-devices">
            <h2 class="section-title">Устройства (Весы / Кассы)</h2>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showModal('deviceModal')">+ Зарегистрировать</button>
                <button class="btn btn-secondary" onclick="loadDevices()">&#8635; Обновить</button>
                <select class="form-control" style="width:200px;" id="deviceFilterStore" onchange="loadDevices()">
                    <option value="">Все магазины</option>
                </select>
            </div>
            <div class="card">
                <div class="card-body" style="padding:0;">
                    <div id="devicesTable"><div class="empty-state">Загрузка...</div></div>
                </div>
            </div>
        </div>

        <!-- ===== Panel: Media ===== -->
        <div class="panel" id="panel-media">
            <h2 class="section-title">Медиаконтент</h2>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showModal('mediaModal')">+ Загрузить</button>
                <button class="btn btn-secondary" onclick="loadMedia()">&#8635; Обновить</button>
                <select class="form-control" style="width:150px;" id="mediaFilterType" onchange="loadMedia()">
                    <option value="">Все типы</option>
                    <option value="image">Изображения</option>
                    <option value="video">Видео</option>
                </select>
                <select class="form-control" style="width:150px;" id="mediaFilterRes" onchange="loadMedia()">
                    <option value="">Все разрешения</option>
                    <option value="800x480">800x480</option>
                    <option value="1024x600">1024x600</option>
                    <option value="1280x800">1280x800</option>
                    <option value="1920x1080">1920x1080</option>
                </select>
            </div>
            <div id="mediaGrid" class="media-grid"></div>
        </div>

        <!-- ===== Panel: Playlists ===== -->
        <div class="panel" id="panel-playlists">
            <h2 class="section-title">Плейлисты</h2>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showModal('playlistModal')">+ Новый плейлист</button>
                <button class="btn btn-secondary" onclick="loadPlaylists()">&#8635; Обновить</button>
            </div>
            <div class="card">
                <div class="card-body" style="padding:0;">
                    <div id="playlistsTable"><div class="empty-state">Загрузка...</div></div>
                </div>
            </div>
        </div>

        <!-- ===== Panel: Campaigns ===== -->
        <div class="panel" id="panel-campaigns">
            <h2 class="section-title">Кампании</h2>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showModal('campaignModal')">+ Новая кампания</button>
                <button class="btn btn-secondary" onclick="loadCampaigns()">&#8635; Обновить</button>
                <select class="form-control" style="width:150px;" id="campaignFilterStatus" onchange="loadCampaigns()">
                    <option value="">Все статусы</option>
                    <option value="draft">Черновик</option>
                    <option value="active">Активные</option>
                    <option value="paused">Приостановлены</option>
                    <option value="stopped">Остановлены</option>
                </select>
            </div>
            <div id="campaignsContainer"></div>
        </div>

        <!-- ===== Panel: Monitoring ===== -->
        <div class="panel" id="panel-monitoring">
            <h2 class="section-title">Мониторинг и отчеты</h2>
            <div class="tab-bar">
                <div class="tab-item active" onclick="showMonTab('devices')">Статус устройств</div>
                <div class="tab-item" onclick="showMonTab('delivery')">Доставка контента</div>
                <div class="tab-item" onclick="showMonTab('events')">Журнал событий</div>
            </div>
            <div id="monTab-devices">
                <div class="card">
                    <div class="card-header">Состояние устройств</div>
                    <div class="card-body" style="padding:0;" id="monDevicesTable">
                        <div class="empty-state">Загрузка...</div>
                    </div>
                </div>
            </div>
            <div id="monTab-delivery" style="display:none;">
                <div class="card">
                    <div class="card-header">Отчет по доставке контента</div>
                    <div class="card-body" id="deliveryReport">
                        <div class="empty-state">Загрузка...</div>
                    </div>
                </div>
            </div>
            <div id="monTab-events" style="display:none;">
                <div class="card">
                    <div class="card-header">Журнал событий
                        <button class="btn btn-sm btn-secondary" onclick="loadEventLog()">&#8635;</button>
                    </div>
                    <div class="card-body" style="padding:0;" id="eventLogTable">
                        <div class="empty-state">Загрузка...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== Store Modal ===== -->
<div class="modal-overlay" id="storeModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Новый магазин</h3>
            <button class="modal-close" onclick="hideModal('storeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Название магазина</label>
                <input type="text" class="form-control" id="storeFormName" placeholder="Например: ТЦ Малина">
            </div>
            <div class="form-group">
                <label>Адрес</label>
                <input type="text" class="form-control" id="storeFormAddress" placeholder="ул. Каля Ешилор 8, Кишинёв">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Регион</label>
                    <input type="text" class="form-control" id="storeFormRegion" placeholder="Кишинёв">
                </div>
                <div class="form-group">
                    <label>Часовой пояс</label>
                    <select class="form-control" id="storeFormTimezone">
                        <option value="Europe/Chisinau">Europe/Chisinau (UTC+2/+3)</option>
                        <option value="Europe/Bucharest">Europe/Bucharest (UTC+2/+3)</option>
                        <option value="Europe/Moscow">Europe/Moscow (UTC+3)</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('storeModal')">Отмена</button>
            <button class="btn btn-primary" onclick="saveStore()">Создать</button>
        </div>
    </div>
</div>

<!-- ===== Device Modal ===== -->
<div class="modal-overlay" id="deviceModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Регистрация устройства</h3>
            <button class="modal-close" onclick="hideModal('deviceModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label>Название</label>
                    <input type="text" class="form-control" id="deviceFormName" placeholder="Весы Сыры #1">
                </div>
                <div class="form-group">
                    <label>Серийный номер</label>
                    <input type="text" class="form-control" id="deviceFormSerial" placeholder="DIGI-1234">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Тип устройства</label>
                    <select class="form-control" id="deviceFormType" onchange="onDeviceTypeChange()">
                        <option value="SM5300">DIGI SM5300</option>
                        <option value="SM6000">DIGI SM6000</option>
                        <option value="WEB3110">Касса WEB3110</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Разрешение экрана</label>
                    <select class="form-control" id="deviceFormResolution">
                        <option value="800x480">800x480</option>
                        <option value="1024x600">1024x600</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Магазин</label>
                    <select class="form-control" id="deviceFormStore" onchange="loadDepartmentsForStore('deviceFormStore', 'deviceFormDept')"></select>
                </div>
                <div class="form-group">
                    <label>Отдел</label>
                    <select class="form-control" id="deviceFormDept"><option value="">-- Выберите магазин --</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>IP адрес</label>
                    <input type="text" class="form-control" id="deviceFormIP" placeholder="192.168.1.100">
                </div>
                <div class="form-group">
                    <label>Версия прошивки</label>
                    <input type="text" class="form-control" id="deviceFormFirmware" placeholder="2.1.4">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('deviceModal')">Отмена</button>
            <button class="btn btn-primary" onclick="saveDevice()">Зарегистрировать</button>
        </div>
    </div>
</div>

<!-- ===== Media Modal ===== -->
<div class="modal-overlay" id="mediaModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Загрузка медиаконтента</h3>
            <button class="modal-close" onclick="hideModal('mediaModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Файл (имя)</label>
                <input type="text" class="form-control" id="mediaFormFilename" placeholder="promo_banner.jpg / video_ad.mp4">
            </div>
            <div class="form-group">
                <label>Описание</label>
                <textarea class="form-control" id="mediaFormDesc" placeholder="Описание контента"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Ширина (px)</label>
                    <input type="number" class="form-control" id="mediaFormWidth" value="1024">
                </div>
                <div class="form-group">
                    <label>Высота (px)</label>
                    <input type="number" class="form-control" id="mediaFormHeight" value="600">
                </div>
            </div>
            <div class="form-group">
                <label>Размер файла (байт)</label>
                <input type="number" class="form-control" id="mediaFormSize" value="500000">
            </div>
            <div class="form-group">
                <label>Длительность видео (сек, только для видео)</label>
                <input type="number" class="form-control" id="mediaFormDuration" value="0">
            </div>
            <div class="form-group">
                <label>Целевые разрешения (множественный выбор)</label>
                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;">
                    <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                        <input type="checkbox" class="media-res-check" value="800x480"> 800x480
                    </label>
                    <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                        <input type="checkbox" class="media-res-check" value="1024x600" checked> 1024x600
                    </label>
                    <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                        <input type="checkbox" class="media-res-check" value="1280x800"> 1280x800
                    </label>
                    <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                        <input type="checkbox" class="media-res-check" value="1920x1080"> 1920x1080
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>Теги (через запятую)</label>
                <input type="text" class="form-control" id="mediaFormTags" placeholder="акция, лето, промо">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('mediaModal')">Отмена</button>
            <button class="btn btn-primary" onclick="saveMedia()">Загрузить</button>
        </div>
    </div>
</div>

<!-- ===== Playlist Modal ===== -->
<div class="modal-overlay" id="playlistModal">
    <div class="modal" style="width:700px;">
        <div class="modal-header">
            <h3>Создание плейлиста</h3>
            <button class="modal-close" onclick="hideModal('playlistModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Название плейлиста</label>
                <input type="text" class="form-control" id="playlistFormName" placeholder="Летний промо-микс">
            </div>
            <div class="form-group">
                <label>Описание</label>
                <textarea class="form-control" id="playlistFormDesc" placeholder="Описание плейлиста"></textarea>
            </div>
            <div class="form-group">
                <label>Элементы плейлиста (выберите медиа)</label>
                <div id="playlistMediaSelector" class="target-list" style="max-height:250px;"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('playlistModal')">Отмена</button>
            <button class="btn btn-primary" onclick="savePlaylist()">Создать</button>
        </div>
    </div>
</div>

<!-- ===== Campaign Modal ===== -->
<div class="modal-overlay" id="campaignModal">
    <div class="modal" style="width:700px;">
        <div class="modal-header">
            <h3>Создание кампании</h3>
            <button class="modal-close" onclick="hideModal('campaignModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Название кампании</label>
                <input type="text" class="form-control" id="campaignFormName" placeholder="Летняя кампания 2025">
            </div>
            <div class="form-group">
                <label>Описание</label>
                <textarea class="form-control" id="campaignFormDesc" placeholder="Описание кампании"></textarea>
            </div>
            <div class="form-group">
                <label>Плейлист</label>
                <select class="form-control" id="campaignFormPlaylist"></select>
            </div>
            <div class="form-group">
                <label>Приоритет (1-10)</label>
                <input type="number" class="form-control" id="campaignFormPriority" min="1" max="10" value="5">
            </div>

            <!-- Таргетинг -->
            <div style="border: 1px solid #333366; border-radius: 6px; padding: 12px; margin-bottom: 14px; background: #1a1a2e;">
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">Таргетинг</div>
                <div class="form-group">
                    <label>Тип таргетинга</label>
                    <select class="form-control" id="campaignFormTargetType" onchange="onTargetTypeChange()">
                        <option value="all">Все магазины</option>
                        <option value="stores">Группа магазинов</option>
                        <option value="departments">Отделы</option>
                        <option value="devices">Конкретные устройства</option>
                    </select>
                </div>
                <div id="targetSelection" style="display:none;">
                    <div id="targetList" class="target-list"></div>
                </div>
            </div>

            <!-- Расписание -->
            <div style="border: 1px solid #333366; border-radius: 6px; padding: 12px; background: #1a1a2e;">
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">Расписание</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Дата начала</label>
                        <input type="date" class="form-control" id="campaignFormStartDate">
                    </div>
                    <div class="form-group">
                        <label>Дата окончания</label>
                        <input type="date" class="form-control" id="campaignFormEndDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Время начала</label>
                        <input type="time" class="form-control" id="campaignFormTimeFrom" value="08:00">
                    </div>
                    <div class="form-group">
                        <label>Время окончания</label>
                        <input type="time" class="form-control" id="campaignFormTimeTo" value="22:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Дни недели</label>
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;">
                        <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;"><input type="checkbox" class="day-check" value="1" checked> Пн</label>
                        <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;"><input type="checkbox" class="day-check" value="2" checked> Вт</label>
                        <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;"><input type="checkbox" class="day-check" value="3" checked> Ср</label>
                        <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;"><input type="checkbox" class="day-check" value="4" checked> Чт</label>
                        <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;"><input type="checkbox" class="day-check" value="5" checked> Пт</label>
                        <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;"><input type="checkbox" class="day-check" value="6" checked> Сб</label>
                        <label style="font-size:13px; cursor:pointer; display:flex; align-items:center; gap:4px;"><input type="checkbox" class="day-check" value="7" checked> Вс</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('campaignModal')">Отмена</button>
            <button class="btn btn-primary" onclick="saveCampaign()">Создать</button>
        </div>
    </div>
</div>

<script>
    // ===== State =====
    let currentPanel = 'dashboard';
    let storesCache = [];
    let devicesCache = [];
    let mediaCache = [];
    let playlistsCache = [];
    let campaignsCache = [];
    let departmentsCache = [];

    const API = '/api/digi';

    // ===== API Helper =====
    async function apiCall(endpoint, options = {}) {
        const url = API + endpoint;
        const config = {
            method: options.method || 'GET',
            headers: { 'Content-Type': 'application/json' },
        };
        if (options.body) config.body = JSON.stringify(options.body);
        if (options.params) {
            const params = new URLSearchParams(options.params);
            const response = await fetch(url + '?' + params.toString(), config);
            return response.json();
        }
        const response = await fetch(url, config);
        return response.json();
    }

    // ===== Logging =====
    function addLog(message, type = 'info') {
        const log = document.getElementById('sidebarLog');
        const time = new Date().toLocaleTimeString();
        log.innerHTML = `<div class="log-entry"><span class="log-time">${time}</span> <span class="log-${type}">${message}</span></div>` + log.innerHTML;
        const entries = log.querySelectorAll('.log-entry');
        if (entries.length > 50) for (let i = 50; i < entries.length; i++) entries[i].remove();
    }
    function clearLog() { document.getElementById('sidebarLog').innerHTML = ''; }

    // ===== Navigation =====
    function showPanel(name) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.top-bar .nav-item').forEach(n => n.classList.remove('active'));
        const panel = document.getElementById('panel-' + name);
        if (panel) panel.classList.add('active');
        document.querySelectorAll('.top-bar .nav-item').forEach(n => {
            if (n.dataset.panel === name) n.classList.add('active');
        });
        currentPanel = name;
        // Load data
        if (name === 'dashboard') loadDashboard();
        if (name === 'stores') loadStores();
        if (name === 'devices') loadDevices();
        if (name === 'media') loadMedia();
        if (name === 'playlists') loadPlaylists();
        if (name === 'campaigns') loadCampaigns();
        if (name === 'monitoring') { loadMonDevices(); loadDeliveryReport(); loadEventLog(); }
    }

    // ===== Modal =====
    function showModal(id) {
        document.getElementById(id).classList.add('show');
        // Pre-load data for selects
        if (id === 'deviceModal') loadStoreSelect('deviceFormStore');
        if (id === 'playlistModal') loadPlaylistMediaSelector();
        if (id === 'campaignModal') { loadPlaylistSelect(); loadTargetOptions(); }
    }
    function hideModal(id) { document.getElementById(id).classList.remove('show'); }

    // ===== Monitoring Tabs =====
    function showMonTab(tab) {
        ['devices', 'delivery', 'events'].forEach(t => {
            document.getElementById('monTab-' + t).style.display = t === tab ? 'block' : 'none';
        });
        document.querySelectorAll('#panel-monitoring .tab-item').forEach((el, i) => {
            el.classList.toggle('active', ['devices', 'delivery', 'events'][i] === tab);
        });
    }

    // ===== Dashboard =====
    async function loadDashboard() {
        try {
            const result = await apiCall('/stats');
            if (result.success && result.data) {
                const d = result.data;
                document.getElementById('statStores').textContent = d.stores;
                document.getElementById('statDevices').textContent = d.devices.total;
                document.getElementById('statDevicesSub').textContent = `online: ${d.devices.online} / offline: ${d.devices.offline}`;
                document.getElementById('statMedia').textContent = d.media.total;
                document.getElementById('statMediaSub').textContent = `img: ${d.media.images} / video: ${d.media.videos}`;
                document.getElementById('statPlaylists').textContent = d.playlists;
                document.getElementById('statCampaigns').textContent = d.campaigns.active;
                document.getElementById('statCampaignsSub').textContent = `всего: ${d.campaigns.total} / черновики: ${d.campaigns.draft}`;
            }
        } catch (e) { addLog('Dashboard error: ' + e.message, 'error'); }

        // Events
        try {
            const result = await apiCall('/events', { params: { limit: 15 } });
            if (result.success && result.data && result.data.length) {
                let html = '<table class="data-table"><thead><tr><th>Время</th><th>Действие</th><th>Объект</th><th>Описание</th></tr></thead><tbody>';
                result.data.forEach(e => {
                    html += `<tr><td style="white-space:nowrap;">${e.timestamp}</td><td>${getActionBadge(e.action)}</td><td>${e.entity_type}</td><td>${e.details}</td></tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('dashboardEvents').innerHTML = html;
            }
        } catch (e) {}
    }

    function getActionBadge(action) {
        const map = {
            'create': ['badge-success', 'Создание'],
            'update': ['badge-info', 'Изменение'],
            'delete': ['badge-danger', 'Удаление'],
            'upload': ['badge-info', 'Загрузка'],
            'publish': ['badge-success', 'Публикация'],
            'pause': ['badge-warning', 'Пауза'],
            'stop': ['badge-danger', 'Стоп'],
            'retry': ['badge-warning', 'Повтор'],
        };
        const [cls, label] = map[action] || ['badge-secondary', action];
        return `<span class="badge ${cls}">${label}</span>`;
    }

    // ===== Stores =====
    async function loadStores() {
        const div = document.getElementById('storesTable');
        try {
            const result = await apiCall('/stores');
            if (result.success) {
                storesCache = result.data || [];
                if (!storesCache.length) { div.innerHTML = '<div class="empty-state"><div class="icon">&#127978;</div>Нет магазинов</div>'; return; }
                let html = '<table class="data-table"><thead><tr><th>Название</th><th>Адрес</th><th>Регион</th><th>Часовой пояс</th><th>Статус</th><th>Действия</th></tr></thead><tbody>';
                storesCache.forEach(s => {
                    html += `<tr>
                        <td><strong>${s.name}</strong></td>
                        <td>${s.address}</td>
                        <td>${s.region}</td>
                        <td>${s.timezone}</td>
                        <td>${s.status === 'active' ? '<span class="badge badge-success">Активен</span>' : '<span class="badge badge-secondary">Неактивен</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="addDepartmentToStore('${s.id}', '${s.name}')">+ Отдел</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStore('${s.id}')">&#10005;</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                div.innerHTML = html;
                addLog('Магазины загружены: ' + storesCache.length, 'success');
            }
        } catch (e) { div.innerHTML = `<div class="empty-state" style="color:#e94560;">Ошибка: ${e.message}</div>`; }
    }

    async function saveStore() {
        const data = {
            name: document.getElementById('storeFormName').value.trim(),
            address: document.getElementById('storeFormAddress').value.trim(),
            region: document.getElementById('storeFormRegion').value.trim(),
            timezone: document.getElementById('storeFormTimezone').value,
        };
        if (!data.name) { addLog('Введите название магазина', 'warn'); return; }
        try {
            const result = await apiCall('/stores', { method: 'POST', body: data });
            if (result.success) {
                addLog('Магазин создан: ' + data.name, 'success');
                hideModal('storeModal');
                document.getElementById('storeFormName').value = '';
                document.getElementById('storeFormAddress').value = '';
                document.getElementById('storeFormRegion').value = '';
                loadStores();
            } else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function deleteStore(id) {
        if (!confirm('Удалить магазин?')) return;
        try {
            const result = await apiCall('/stores/' + id, { method: 'DELETE' });
            if (result.success) { addLog('Магазин удален', 'success'); loadStores(); }
            else { addLog('Ошибка: ' + result.error, 'error'); alert(result.error); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function addDepartmentToStore(storeId, storeName) {
        const deptType = prompt(`Добавить отдел в "${storeName}"\nТип: confectionery, culinary, cheese, sausage, meat, fish`);
        if (!deptType) return;
        const nameMap = {confectionery: 'Кондитерские изделия', culinary: 'Кулинария', cheese: 'Сыры', sausage: 'Колбасы', meat: 'Мясо', fish: 'Рыба'};
        try {
            const result = await apiCall('/departments', { method: 'POST', body: { store_id: storeId, type: deptType, name: nameMap[deptType] || deptType } });
            if (result.success) { addLog('Отдел создан', 'success'); }
            else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    // ===== Devices =====
    async function loadDevices() {
        const div = document.getElementById('devicesTable');
        const storeFilter = document.getElementById('deviceFilterStore').value;
        try {
            const params = {};
            if (storeFilter) params.store_id = storeFilter;
            const result = await apiCall('/devices', { params });
            if (result.success) {
                devicesCache = result.data || [];
                if (!devicesCache.length) { div.innerHTML = '<div class="empty-state"><div class="icon">&#9878;</div>Нет устройств</div>'; return; }
                let html = '<table class="data-table"><thead><tr><th>Название</th><th>S/N</th><th>Тип</th><th>Разрешение</th><th>Магазин</th><th>Отдел</th><th>IP</th><th>Статус</th><th>Синхр.</th><th>Действия</th></tr></thead><tbody>';
                devicesCache.forEach(d => {
                    const statusBadge = d.status === 'online' ? '<span class="badge badge-success">Online</span>' :
                        d.status === 'offline' ? '<span class="badge badge-secondary">Offline</span>' : '<span class="badge badge-danger">Error</span>';
                    html += `<tr>
                        <td><strong>${d.name}</strong></td>
                        <td>${d.serial_number}</td>
                        <td>${d.device_type}</td>
                        <td>${d.resolution}</td>
                        <td>${d.store_name}</td>
                        <td>${d.department_name}</td>
                        <td>${d.ip_address}</td>
                        <td>${statusBadge}</td>
                        <td style="font-size:11px;">${d.last_sync || 'Нет'}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteDevice('${d.id}')">&#10005;</button></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                div.innerHTML = html;
                addLog('Устройства загружены: ' + devicesCache.length, 'success');
            }
        } catch (e) { div.innerHTML = `<div class="empty-state" style="color:#e94560;">Ошибка: ${e.message}</div>`; }
    }

    function onDeviceTypeChange() {
        const type = document.getElementById('deviceFormType').value;
        const resMap = { SM5300: ['800x480', '1024x600'], SM6000: ['1024x600', '1280x800'], WEB3110: ['1920x1080', '1280x1024'] };
        const sel = document.getElementById('deviceFormResolution');
        sel.innerHTML = '';
        (resMap[type] || []).forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; sel.appendChild(o); });
    }

    async function loadStoreSelect(selectId) {
        const sel = document.getElementById(selectId);
        try {
            const result = await apiCall('/stores');
            if (result.success) {
                storesCache = result.data || [];
                sel.innerHTML = '<option value="">-- Выберите магазин --</option>';
                storesCache.forEach(s => { sel.innerHTML += `<option value="${s.id}">${s.name}</option>`; });
                // Also update filter
                const filter = document.getElementById('deviceFilterStore');
                if (filter) {
                    const current = filter.value;
                    filter.innerHTML = '<option value="">Все магазины</option>';
                    storesCache.forEach(s => { filter.innerHTML += `<option value="${s.id}">${s.name}</option>`; });
                    filter.value = current;
                }
            }
        } catch (e) {}
    }

    async function loadDepartmentsForStore(storeSelectId, deptSelectId) {
        const storeId = document.getElementById(storeSelectId).value;
        const sel = document.getElementById(deptSelectId);
        if (!storeId) { sel.innerHTML = '<option value="">-- Выберите магазин --</option>'; return; }
        try {
            const result = await apiCall('/departments', { params: { store_id: storeId } });
            if (result.success) {
                departmentsCache = result.data || [];
                sel.innerHTML = '<option value="">-- Выберите отдел --</option>';
                departmentsCache.forEach(d => { sel.innerHTML += `<option value="${d.id}">${d.name}</option>`; });
            }
        } catch (e) { sel.innerHTML = '<option value="">Ошибка загрузки</option>'; }
    }

    async function saveDevice() {
        const data = {
            name: document.getElementById('deviceFormName').value.trim(),
            serial_number: document.getElementById('deviceFormSerial').value.trim(),
            device_type: document.getElementById('deviceFormType').value,
            resolution: document.getElementById('deviceFormResolution').value,
            store_id: document.getElementById('deviceFormStore').value,
            department_id: document.getElementById('deviceFormDept').value,
            ip_address: document.getElementById('deviceFormIP').value.trim(),
            firmware_version: document.getElementById('deviceFormFirmware').value.trim(),
        };
        if (!data.name || !data.serial_number) { addLog('Заполните название и серийный номер', 'warn'); return; }
        try {
            const result = await apiCall('/devices', { method: 'POST', body: data });
            if (result.success) {
                addLog('Устройство зарегистрировано: ' + data.name, 'success');
                hideModal('deviceModal');
                loadDevices();
            } else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function deleteDevice(id) {
        if (!confirm('Удалить устройство?')) return;
        try {
            const result = await apiCall('/devices/' + id, { method: 'DELETE' });
            if (result.success) { addLog('Устройство удалено', 'success'); loadDevices(); }
            else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    // ===== Media =====
    async function loadMedia() {
        const grid = document.getElementById('mediaGrid');
        const typeFilter = document.getElementById('mediaFilterType').value;
        const resFilter = document.getElementById('mediaFilterRes').value;
        try {
            const params = {};
            if (typeFilter) params.type = typeFilter;
            if (resFilter) params.resolution = resFilter;
            const result = await apiCall('/media', { params });
            if (result.success) {
                mediaCache = result.data || [];
                if (!mediaCache.length) { grid.innerHTML = '<div class="empty-state"><div class="icon">&#127910;</div>Нет медиафайлов</div>'; return; }
                grid.innerHTML = '';
                mediaCache.forEach(m => {
                    const isVideo = m.type === 'video';
                    const sizeKB = Math.round((m.size_bytes || 0) / 1024);
                    const resText = (m.resolutions || []).join(', ');
                    const tags = (m.tags || []).map(t => `<span class="tag">${t}</span>`).join('');
                    grid.innerHTML += `
                        <div class="media-card" onclick="viewMedia('${m.id}')">
                            <div class="media-thumb ${m.type}">${isVideo ? '&#9654;' : '&#128247;'}</div>
                            <div class="media-info">
                                <div class="name">${m.original_name || m.filename}</div>
                                <div class="meta">${m.type} | ${sizeKB} KB | ${m.width}x${m.height}${isVideo ? ' | ' + m.duration_seconds + 's' : ''}</div>
                                <div class="meta">${resText}</div>
                                <div class="tags">${tags}</div>
                            </div>
                        </div>
                    `;
                });
                addLog('Медиа загружены: ' + mediaCache.length, 'success');
            }
        } catch (e) { grid.innerHTML = `<div class="empty-state" style="color:#e94560;">Ошибка: ${e.message}</div>`; }
    }

    function viewMedia(id) {
        const m = mediaCache.find(x => x.id === id);
        if (m) alert(JSON.stringify(m, null, 2));
    }

    async function saveMedia() {
        const resolutions = Array.from(document.querySelectorAll('.media-res-check:checked')).map(c => c.value);
        const tagsStr = document.getElementById('mediaFormTags').value;
        const data = {
            filename: document.getElementById('mediaFormFilename').value.trim(),
            original_name: document.getElementById('mediaFormFilename').value.trim().replace(/\.\w+$/, ''),
            description: document.getElementById('mediaFormDesc').value.trim(),
            width: parseInt(document.getElementById('mediaFormWidth').value) || 0,
            height: parseInt(document.getElementById('mediaFormHeight').value) || 0,
            size_bytes: parseInt(document.getElementById('mediaFormSize').value) || 0,
            duration_seconds: parseInt(document.getElementById('mediaFormDuration').value) || 0,
            resolutions: resolutions,
            tags: tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : [],
        };
        if (!data.filename) { addLog('Введите имя файла', 'warn'); return; }
        try {
            const result = await apiCall('/media', { method: 'POST', body: data });
            if (result.success) {
                addLog('Медиа загружен: ' + data.filename, 'success');
                hideModal('mediaModal');
                document.getElementById('mediaFormFilename').value = '';
                document.getElementById('mediaFormDesc').value = '';
                document.getElementById('mediaFormTags').value = '';
                loadMedia();
            } else { addLog('Ошибка: ' + result.error, 'error'); alert(result.error); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    // ===== Playlists =====
    async function loadPlaylists() {
        const div = document.getElementById('playlistsTable');
        try {
            const result = await apiCall('/playlists');
            if (result.success) {
                playlistsCache = result.data || [];
                if (!playlistsCache.length) { div.innerHTML = '<div class="empty-state"><div class="icon">&#127925;</div>Нет плейлистов</div>'; return; }
                let html = '<table class="data-table"><thead><tr><th>Название</th><th>Описание</th><th>Элементов</th><th>Длительность</th><th>Статус</th><th>Создан</th><th>Действия</th></tr></thead><tbody>';
                playlistsCache.forEach(pl => {
                    html += `<tr>
                        <td><strong>${pl.name}</strong></td>
                        <td>${pl.description || '-'}</td>
                        <td>${pl.item_count || 0}</td>
                        <td>${pl.total_duration || 0} сек</td>
                        <td>${pl.status === 'draft' ? '<span class="badge badge-secondary">Черновик</span>' : '<span class="badge badge-success">Активен</span>'}</td>
                        <td style="font-size:11px;">${pl.created_at}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewPlaylist('${pl.id}')">&#128065;</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePlaylist('${pl.id}')">&#10005;</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                div.innerHTML = html;
                addLog('Плейлисты загружены: ' + playlistsCache.length, 'success');
            }
        } catch (e) { div.innerHTML = `<div class="empty-state" style="color:#e94560;">Ошибка: ${e.message}</div>`; }
    }

    async function loadPlaylistMediaSelector() {
        try {
            const result = await apiCall('/media');
            if (result.success) {
                mediaCache = result.data || [];
                const div = document.getElementById('playlistMediaSelector');
                if (!mediaCache.length) { div.innerHTML = '<div style="color:#6c6c8a; padding:8px;">Нет доступных медиафайлов</div>'; return; }
                div.innerHTML = '';
                mediaCache.forEach(m => {
                    div.innerHTML += `
                        <label class="target-item">
                            <input type="checkbox" class="playlist-media-check" value="${m.id}" data-duration="${m.duration_seconds || 5}">
                            <span>${m.type === 'video' ? '&#9654;' : '&#128247;'}</span>
                            <span>${m.original_name || m.filename}</span>
                            <span style="color:#6c6c8a; font-size:11px; margin-left:auto;">${(m.resolutions || []).join(', ')}</span>
                        </label>
                    `;
                });
            }
        } catch (e) {}
    }

    async function savePlaylist() {
        const checked = document.querySelectorAll('.playlist-media-check:checked');
        const items = [];
        checked.forEach((c, i) => {
            items.push({ media_id: c.value, duration: parseInt(c.dataset.duration) || 5, order: i + 1 });
        });
        const data = {
            name: document.getElementById('playlistFormName').value.trim(),
            description: document.getElementById('playlistFormDesc').value.trim(),
            items: items,
        };
        if (!data.name) { addLog('Введите название плейлиста', 'warn'); return; }
        if (!items.length) { addLog('Выберите хотя бы один медиафайл', 'warn'); return; }
        try {
            const result = await apiCall('/playlists', { method: 'POST', body: data });
            if (result.success) {
                addLog('Плейлист создан: ' + data.name, 'success');
                hideModal('playlistModal');
                document.getElementById('playlistFormName').value = '';
                document.getElementById('playlistFormDesc').value = '';
                loadPlaylists();
            } else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function viewPlaylist(id) {
        try {
            const result = await apiCall('/playlists/' + id);
            if (result.success) alert(JSON.stringify(result.data, null, 2));
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function deletePlaylist(id) {
        if (!confirm('Удалить плейлист?')) return;
        try {
            const result = await apiCall('/playlists/' + id, { method: 'DELETE' });
            if (result.success) { addLog('Плейлист удален', 'success'); loadPlaylists(); }
            else { addLog('Ошибка: ' + result.error, 'error'); alert(result.error); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    // ===== Campaigns =====
    async function loadCampaigns() {
        const div = document.getElementById('campaignsContainer');
        const statusFilter = document.getElementById('campaignFilterStatus').value;
        try {
            const params = {};
            if (statusFilter) params.status = statusFilter;
            const result = await apiCall('/campaigns', { params });
            if (result.success) {
                campaignsCache = result.data || [];
                if (!campaignsCache.length) { div.innerHTML = '<div class="empty-state"><div class="icon">&#128227;</div>Нет кампаний</div>'; return; }
                let html = '';
                campaignsCache.forEach(c => {
                    const statusBadge = getCampaignStatusBadge(c.status);
                    const deliveryBadge = getDeliveryBadge(c.delivery_status);
                    html += `
                        <div class="card" style="margin-bottom:12px;">
                            <div class="card-header">
                                ${c.name}
                                <span style="margin-left:8px;">${statusBadge}</span>
                                <span style="margin-left:4px;">${deliveryBadge}</span>
                                <span style="margin-left:auto; font-size:11px; color:#6c6c8a;">Приоритет: ${c.priority || '-'}</span>
                            </div>
                            <div class="card-body">
                                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:12px;">
                                    <div>
                                        <div style="font-size:11px; color:#6c6c8a;">Плейлист</div>
                                        <div style="font-size:13px;">${c.playlist_name || '-'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:11px; color:#6c6c8a;">Таргетинг</div>
                                        <div style="font-size:13px;">${c.target_summary || '-'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:11px; color:#6c6c8a;">Устройства</div>
                                        <div style="font-size:13px;">${c.devices_synced || 0} / ${c.devices_total || 0} доставлено</div>
                                    </div>
                                </div>
                                ${c.schedule ? `<div style="font-size:12px; color:#8888aa; margin-bottom:8px;">
                                    Расписание: ${c.schedule.start_date || '?'} - ${c.schedule.end_date || '?'} | ${c.schedule.time_from || '?'} - ${c.schedule.time_to || '?'}
                                </div>` : ''}
                                <div class="btn-group" style="margin-top:0;">
                                    ${c.status === 'draft' ? `<button class="btn btn-sm btn-success" onclick="publishCampaign('${c.id}')">&#9654; Опубликовать</button>` : ''}
                                    ${c.status === 'active' ? `<button class="btn btn-sm btn-warning" onclick="pauseCampaign('${c.id}')">&#9208; Пауза</button>` : ''}
                                    ${c.status === 'paused' ? `<button class="btn btn-sm btn-success" onclick="publishCampaign('${c.id}')">&#9654; Возобновить</button>` : ''}
                                    ${c.status !== 'stopped' ? `<button class="btn btn-sm btn-danger" onclick="stopCampaign('${c.id}')">&#9632; Стоп</button>` : ''}
                                    ${c.status === 'stopped' || c.status === 'draft' ? `<button class="btn btn-sm btn-danger" onclick="deleteCampaign('${c.id}')">&#10005; Удалить</button>` : ''}
                                    <button class="btn btn-sm btn-secondary" onclick="retryCampaign('${c.id}')">&#8635; Повтор доставки</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                div.innerHTML = html;
                addLog('Кампании загружены: ' + campaignsCache.length, 'success');
            }
        } catch (e) { div.innerHTML = `<div class="empty-state" style="color:#e94560;">Ошибка: ${e.message}</div>`; }
    }

    function getCampaignStatusBadge(status) {
        const map = { draft: ['badge-secondary', 'Черновик'], active: ['badge-success', 'Активна'], paused: ['badge-warning', 'Пауза'], stopped: ['badge-danger', 'Остановлена'] };
        const [cls, label] = map[status] || ['badge-secondary', status || '-'];
        return `<span class="badge ${cls}">${label}</span>`;
    }
    function getDeliveryBadge(status) {
        const map = { pending: ['badge-secondary', 'Ожидание'], delivering: ['badge-info', 'Доставка'], completed: ['badge-success', 'Доставлено'], stopped: ['badge-danger', 'Остановлено'] };
        const [cls, label] = map[status] || ['badge-secondary', status || '-'];
        return `<span class="badge ${cls}">${label}</span>`;
    }

    async function loadPlaylistSelect() {
        try {
            const result = await apiCall('/playlists');
            if (result.success) {
                playlistsCache = result.data || [];
                const sel = document.getElementById('campaignFormPlaylist');
                sel.innerHTML = '<option value="">-- Выберите плейлист --</option>';
                playlistsCache.forEach(pl => { sel.innerHTML += `<option value="${pl.id}">${pl.name} (${pl.item_count || 0} эл.)</option>`; });
            }
        } catch (e) {}
    }

    async function loadTargetOptions() {
        try {
            const [storesRes, deptsRes, devicesRes] = await Promise.all([
                apiCall('/stores'),
                apiCall('/departments'),
                apiCall('/devices'),
            ]);
            if (storesRes.success) storesCache = storesRes.data || [];
            if (deptsRes.success) departmentsCache = deptsRes.data || [];
            if (devicesRes.success) devicesCache = devicesRes.data || [];
        } catch (e) {}
    }

    function onTargetTypeChange() {
        const type = document.getElementById('campaignFormTargetType').value;
        const selDiv = document.getElementById('targetSelection');
        const listDiv = document.getElementById('targetList');
        if (type === 'all') { selDiv.style.display = 'none'; return; }
        selDiv.style.display = 'block';
        listDiv.innerHTML = '';
        if (type === 'stores') {
            storesCache.forEach(s => {
                listDiv.innerHTML += `<label class="target-item"><input type="checkbox" class="target-check" value="${s.id}"> ${s.name} (${s.region})</label>`;
            });
        } else if (type === 'departments') {
            departmentsCache.forEach(d => {
                listDiv.innerHTML += `<label class="target-item"><input type="checkbox" class="target-check" value="${d.id}"> ${d.name} - ${d.store_name}</label>`;
            });
        } else if (type === 'devices') {
            devicesCache.forEach(d => {
                listDiv.innerHTML += `<label class="target-item"><input type="checkbox" class="target-check" value="${d.id}"> ${d.name} (${d.device_type} ${d.resolution}) - ${d.store_name}</label>`;
            });
        }
    }

    async function saveCampaign() {
        const targetType = document.getElementById('campaignFormTargetType').value;
        const targeting = { type: targetType };
        if (targetType !== 'all') {
            const checked = Array.from(document.querySelectorAll('.target-check:checked')).map(c => c.value);
            if (!checked.length) { addLog('Выберите целевые объекты', 'warn'); return; }
            if (targetType === 'stores') targeting.store_ids = checked;
            else if (targetType === 'departments') targeting.department_ids = checked;
            else if (targetType === 'devices') targeting.device_ids = checked;
        }
        const days = Array.from(document.querySelectorAll('.day-check:checked')).map(c => parseInt(c.value));
        const data = {
            name: document.getElementById('campaignFormName').value.trim(),
            description: document.getElementById('campaignFormDesc').value.trim(),
            playlist_id: document.getElementById('campaignFormPlaylist').value,
            priority: parseInt(document.getElementById('campaignFormPriority').value) || 5,
            targeting: targeting,
            schedule: {
                start_date: document.getElementById('campaignFormStartDate').value,
                end_date: document.getElementById('campaignFormEndDate').value,
                time_from: document.getElementById('campaignFormTimeFrom').value,
                time_to: document.getElementById('campaignFormTimeTo').value,
                days_of_week: days,
            }
        };
        if (!data.name) { addLog('Введите название кампании', 'warn'); return; }
        if (!data.playlist_id) { addLog('Выберите плейлист', 'warn'); return; }
        try {
            const result = await apiCall('/campaigns', { method: 'POST', body: data });
            if (result.success) {
                addLog('Кампания создана: ' + data.name, 'success');
                hideModal('campaignModal');
                document.getElementById('campaignFormName').value = '';
                document.getElementById('campaignFormDesc').value = '';
                loadCampaigns();
            } else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function publishCampaign(id) {
        if (!confirm('Опубликовать кампанию? Контент будет доставлен на устройства.')) return;
        try {
            const result = await apiCall('/campaigns/' + id + '/publish', { method: 'POST' });
            if (result.success) { addLog('Кампания опубликована', 'success'); loadCampaigns(); }
            else { addLog('Ошибка: ' + result.error, 'error'); alert(result.error); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function pauseCampaign(id) {
        try {
            const result = await apiCall('/campaigns/' + id + '/pause', { method: 'POST' });
            if (result.success) { addLog('Кампания приостановлена', 'success'); loadCampaigns(); }
            else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function stopCampaign(id) {
        if (!confirm('Остановить кампанию?')) return;
        try {
            const result = await apiCall('/campaigns/' + id + '/stop', { method: 'POST' });
            if (result.success) { addLog('Кампания остановлена', 'success'); loadCampaigns(); }
            else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function deleteCampaign(id) {
        if (!confirm('Удалить кампанию?')) return;
        try {
            const result = await apiCall('/campaigns/' + id, { method: 'DELETE' });
            if (result.success) { addLog('Кампания удалена', 'success'); loadCampaigns(); }
            else { addLog('Ошибка: ' + result.error, 'error'); alert(result.error); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    async function retryCampaign(id) {
        try {
            const result = await apiCall('/campaigns/' + id + '/retry', { method: 'POST' });
            if (result.success) { addLog('Повторная доставка запущена', 'success'); loadCampaigns(); }
            else { addLog('Ошибка: ' + result.error, 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    // ===== Monitoring =====
    async function loadMonDevices() {
        const div = document.getElementById('monDevicesTable');
        try {
            const result = await apiCall('/devices');
            if (result.success) {
                const devices = result.data || [];
                if (!devices.length) { div.innerHTML = '<div class="empty-state">Нет устройств</div>'; return; }
                let html = '<table class="data-table"><thead><tr><th>Устройство</th><th>Тип</th><th>Разрешение</th><th>Магазин</th><th>Отдел</th><th>IP</th><th>Статус</th><th>Последняя синхр.</th></tr></thead><tbody>';
                devices.forEach(d => {
                    const statusBadge = d.status === 'online' ? '<span class="badge badge-success">Online</span>' :
                        d.status === 'offline' ? '<span class="badge badge-secondary">Offline</span>' : '<span class="badge badge-danger">Error</span>';
                    html += `<tr><td>${d.name}</td><td>${d.device_type}</td><td>${d.resolution}</td><td>${d.store_name}</td><td>${d.department_name}</td><td>${d.ip_address}</td><td>${statusBadge}</td><td style="font-size:11px;">${d.last_sync || 'Нет'}</td></tr>`;
                });
                html += '</tbody></table>';
                div.innerHTML = html;
            }
        } catch (e) { div.innerHTML = `<div class="empty-state" style="color:#e94560;">Ошибка: ${e.message}</div>`; }
    }

    async function loadDeliveryReport() {
        const div = document.getElementById('deliveryReport');
        try {
            const result = await apiCall('/delivery-report');
            if (result.success) {
                const data = result.data || [];
                if (!data.length) { div.innerHTML = '<div class="empty-state">Нет данных о доставке</div>'; return; }
                let html = '<table class="data-table"><thead><tr><th>Кампания</th><th>Статус</th><th>Доставка</th><th>Устройства</th><th>Прогресс</th></tr></thead><tbody>';
                data.forEach(r => {
                    const pct = r.devices_total > 0 ? Math.round(r.devices_synced / r.devices_total * 100) : 0;
                    html += `<tr>
                        <td><strong>${r.campaign_name}</strong></td>
                        <td>${getCampaignStatusBadge(r.status)}</td>
                        <td>${getDeliveryBadge(r.delivery_status)}</td>
                        <td>${r.devices_synced} / ${r.devices_total}</td>
                        <td>
                            <div style="background:#333366; border-radius:4px; height:16px; width:120px; overflow:hidden;">
                                <div style="background:#53d769; height:100%; width:${pct}%; transition:width .3s;"></div>
                            </div>
                            <span style="font-size:11px; color:#8888aa;">${pct}%</span>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                div.innerHTML = html;
            }
        } catch (e) { div.innerHTML = `<div class="empty-state" style="color:#e94560;">Ошибка: ${e.message}</div>`; }
    }

    async function loadEventLog() {
        const div = document.getElementById('eventLogTable');
        try {
            const result = await apiCall('/events', { params: { limit: 100 } });
            if (result.success) {
                const events = result.data || [];
                if (!events.length) { div.innerHTML = '<div class="empty-state">Нет событий</div>'; return; }
                let html = '<table class="data-table"><thead><tr><th>Время</th><th>Действие</th><th>Тип объекта</th><th>Описание</th><th>Пользователь</th></tr></thead><tbody>';
                events.forEach(e => {
                    html += `<tr>
                        <td style="white-space:nowrap; font-size:12px;">${e.timestamp}</td>
                        <td>${getActionBadge(e.action)}</td>
                        <td>${e.entity_type}</td>
                        <td>${e.details}</td>
                        <td style="font-size:12px;">${e.user || '-'}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                div.innerHTML = html;
            }
        } catch (e) { div.innerHTML = `<div class="empty-state" style="color:#e94560;">Ошибка: ${e.message}</div>`; }
    }

    // ===== Demo Data =====
    async function loadDemoData() {
        if (!confirm('Загрузить демонстрационные данные? (магазины, устройства, медиа, плейлисты, кампании)')) return;
        addLog('Загрузка демо-данных...', 'info');
        try {
            const result = await apiCall('/init-demo', { method: 'POST' });
            if (result.success) {
                addLog(result.message || 'Демо-данные загружены', 'success');
                refreshAll();
            } else { addLog('Ошибка: ' + (result.error || result.message), 'error'); }
        } catch (e) { addLog('Ошибка: ' + e.message, 'error'); }
    }

    // ===== Refresh All =====
    function refreshAll() {
        loadDashboard();
        if (currentPanel === 'stores') loadStores();
        if (currentPanel === 'devices') loadDevices();
        if (currentPanel === 'media') loadMedia();
        if (currentPanel === 'playlists') loadPlaylists();
        if (currentPanel === 'campaigns') loadCampaigns();
        if (currentPanel === 'monitoring') { loadMonDevices(); loadDeliveryReport(); loadEventLog(); }
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboard();
        addLog('DIGI Marketing модуль инициализирован', 'info');
    });
</script>
</body>
</html>

#!/usr/bin/env python3
"""
Импорт услуг Nufarul из данных страницы https://nufarul.com/ru/order-online.html
в таблицу NUF_SERVICES (Oracle).
Запуск: из корня проекта, с настроенным .env и Oracle: python import_nufarul_services.py
"""
import os
import sys

root_dir = os.path.dirname(os.path.abspath(__file__))
if root_dir not in sys.path:
    sys.path.insert(0, root_dir)

# Группы услуг (порядок как на странице заказов nufarul.com)
# (start_index, end_index, group_code)
GROUP_INDEX_RANGES = [
    (0, 3, "delivery"),           # ДОСТАВКА ЗАКАЗОВ
    (3, 167, "dry_cleaning"),     # ХИМЧИСТКА (текстиль, кожа, шубы, др.)
    (167, 174, "carpets"),        # ХИМЧИСТКА КОВРОВ
    (174, 184, "pillows_cleaning"),  # Химчистка подушек с заменой наперника
    (184, 195, "laundry"),        # СТИРКА БЕЛЬЯ
    (195, 210, "leather_dyeing"), # КРАШЕНИЕ ИЗДЕЛИЙ ИЗ КОЖИ
    (210, 210, "conditions"),     # Условия предоставления услуг (пусто)
    (210, 217, "silicone_pillows"),  # ПРОДАЖА ПОДУШЕК ИЗ СИЛИКОНА
]


def _group_for_index(i: int) -> str:
    for start, end, code in GROUP_INDEX_RANGES:
        if start <= i < end:
            return code
    return "dry_cleaning"


# Данные со страницы order-online.html (nufarul.com) — все категории и цены
# Формат: (name_ru, price, unit, [notes]). unit: buc, mp, kg, com, km
SERVICES_DATA = [
    # --- ДОСТАВКА ЗАКАЗОВ ---
    ("Доставка по всем секторам города (Botanica, Buiucani, Centru, Râșcani, Ciocana)", 90, "com", "de la 90 lei/com"),
    ("Доставка другие населённые пункты (Durlești, Dumbrava, Stăuceni, Codru, Aeroport и др.)", 150, "com", "de la 150 lei/com"),
    ("Доставка по республике", 6, "km", "de la 6 lei/km"),
    # --- Одежда из текстиля ---
    ("Блуза с аппликациями из кожи", 190, "buc", None),
    ("Блуза с длинным рукавом", 140, "buc", None),
    ("Блуза с коротким рукавом", 110, "buc", None),
    ("Брюки на утепленной подкладке (вкл. для лыжников)", 185, "buc", None),
    ("Брюки с кожаными аппликациями", 275, "buc", None),
    ("Брюки, джинсы", 135, "buc", None),
    ("Вуаль", 105, "buc", None),
    ("Галстук", 55, "buc", None),
    ("Демисезонное пальто с капюшоном", 330, "buc", None),
    ("Демисезонное пальто без капюшона", 300, "buc", None),
    ("Жилет с капюшоном", 120, "buc", None),
    ("Жилет без капюшона", 100, "buc", None),
    ("Жилет на пуху, синтепоне (демисезонное) с капюшоном", 235, "buc", None),
    ("Жилет на пуху, синтепоне (демисезонное) без капюшона", 195, "buc", None),
    ("Жилет на пуху, синтепоне с капюшоном", 270, "buc", None),
    ("Жилет на пуху, синтепоне без капюшона", 230, "buc", None),
    ("Комбинезон", 220, "buc", None),
    ("Комбинезон с подкладкой", 300, "buc", None),
    ("Куртка Vindiac (ветровка), джинсовая с капюшоном", 205, "buc", None),
    ("Куртка Vindiac (ветровка), джинсовая без капюшона", 185, "buc", None),
    ("Куртка на пуху (демисезонное) с капюшоном", 295, "buc", None),
    ("Куртка на пуху (демисезонное) без капюшона", 265, "buc", None),
    ("Куртка на пуху с капюшоном", 340, "buc", None),
    ("Куртка на пуху без капюшона", 300, "buc", None),
    ("Куртка на синтепоне (демисезонное) с капюшоном", 260, "buc", None),
    ("Куртка на синтепоне (демисезонное) без капюшона", 230, "buc", None),
    ("Куртка на утеплённой подкладке из натурального меха с капюшоном", 330, "buc", None),
    ("Куртка на утеплённой подкладке из натурального меха без капюшона", 290, "buc", None),
    ("Куртка на утеплённой подкладке из синтепона с капюшоном", 325, "buc", None),
    ("Куртка на утеплённой подкладке из синтепона без капюшона", 285, "buc", None),
    ("Куртка от спортивного костюма с капюшоном", 135, "buc", None),
    ("Куртка от спортивного костюма без капюшона", 115, "buc", None),
    ("Майка трикотажная", 55, "buc", None),
    ("Носки", 40, "buc", None),
    ("Пальто зимнее, кашемировое с капюшоном", 365, "buc", None),
    ("Пальто зимнее, кашемировое без капюшона", 325, "buc", None),
    ("Пальто короткое зимнее, кашемировое с капюшоном", 340, "buc", None),
    ("Пальто короткое зимнее, кашемировое без капюшона", 300, "buc", None),
    ("Пальто короткое на пуху, синтепоне с капюшоном", 340, "buc", None),
    ("Пальто короткое на пуху, синтепоне без капюшона", 300, "buc", None),
    ("Пальто на пуху, синтепоне с капюшоном", 370, "buc", None),
    ("Пальто на пуху, синтепоне без капюшона", 330, "buc", None),
    ("Перчатки", 45, "buc", None),
    ("Пиджак", 165, "buc", None),
    ("Пиджак (свыше 85 см), кардиган", 190, "buc", None),
    ("Пиджак из пальтовой ткани", 205, "buc", None),
    ("Пижама толстая", 115, "buc", None),
    ("Пижама тонкая", 100, "buc", None),
    ("Платье простое", 170, "buc", None),
    ("Платье сложное", 210, "buc", None),
    ("Платье вечернее простое", 230, "buc", None),
    ("Платье вечернее сложное", 250, "buc", None),
    ("Платье длинное простое", 290, "buc", None),
    ("Платье длинное сложное", 390, "buc", None),
    ("Платье свадебное (макс. 2 юбки)", 480, "buc", None),
    ("Платье свадебное (сложное, 3 юбки)", 600, "buc", None),
    ("Платье свадебное (сложное, мин. 4 юбки или шлейф)", 885, "buc", None),
    ("Плащ", 260, "buc", None),
    ("Плащ на подкладке из натурального меха", 315, "buc", None),
    ("Плащ на подкладке из синтетического меха", 260, "buc", None),
    ("Подкладка из искусственного меха с капюшоном", 200, "buc", None),
    ("Подкладка из искусственного меха без капюшона", 160, "buc", None),
    ("Подкладка из натурального меха с капюшоном", 305, "buc", None),
    ("Подкладка из натурального меха без капюшона", 265, "buc", None),
    ("Поло, футболка, раглан с рукавами", 75, "buc", None),
    ("Поло, футболка, раглан без рукавов", 65, "buc", None),
    ("Рубашка", 85, "buc", None),
    ("Рубашка из шелка", 115, "buc", None),
    ("Рубашка сложного покроя", 100, "buc", None),
    ("Свитер, жакет, джемпер с длинным рукавом", 130, "buc", None),
    ("Свитер, жакет, джемпер с коротким рукавом", 105, "buc", None),
    ("Спортивный костюм", 200, "buc", None),
    ("Тонкая шапка, кепка, берет", 75, "buc", None),
    ("Халат длинный с капюшоном", 135, "buc", None),
    ("Халат длинный без капюшона", 115, "buc", None),
    ("Халат короткий с капюшоном", 125, "buc", None),
    ("Халат короткий без капюшона", 105, "buc", None),
    ("Шапка зимняя", 100, "buc", None),
    ("Шарф, платок <1м²", 60, "buc", None),
    ("Шарф, платок >1м²", 90, "buc", None),
    ("Юбка <70 см", 120, "buc", None),
    ("Юбка >70 см", 130, "buc", None),
    ("Юбка (плиссе, гофре, складки)", 150, "buc", None),
    ("Юбка вязанная <70 см", 130, "buc", None),
    ("Юбка вязанная >70 см", 140, "buc", None),
    # --- Другие изделия из текстиля ---
    ("Гардино, тюлевые изделия, шторы", 27, "mp", "lei/m²"),
    ("Драпировочные изделия, скатерти, дорожка, чехлы, накидка на диван", 50, "buc", None),
    ("Изделия для спальни из длинно-петлевого полотна 2-х спальные", 345, "buc", None),
    ("Изделия для спальни из длинно-петлевого полотна", 275, "buc", None),
    ("Мягкие игрушки 3-4 кг", 150, "buc", None),
    ("Мягкие игрушки 4-5 кг", 180, "buc", None),
    ("Мягкие игрушки 1.0–2.0 кг", 85, "buc", None),
    ("Мягкие игрушки 2-3 кг", 120, "buc", None),
    ("Мягкие игрушки до 1 кг", 40, "buc", None),
    ("Одеяло 2-х спальное шерстяное, полушерстяное, синтепоновое", 365, "buc", None),
    ("Одеяло 2-х спальное двойное", 320, "buc", None),
    ("Одеяло 2-х спальное шерстяное, полушерстяное", 300, "buc", None),
    ("Одеяло 2-х спальное синтепоновое", 260, "buc", None),
    ("Одеяло пуховое", 285, "buc", None),
    ("Одеяло пуховое 2-х спальное", 315, "buc", None),
    ("Одеяло пуховое двойное", 365, "buc", None),
    ("Одеяло стёганое шерстяное, полушерстяное односпальное", 245, "buc", None),
    ("Одеяло стёганое синтепоновое односпальное", 215, "buc", None),
    ("Одеяло шерстяное, полушерстяное", 190, "buc", None),
    ("Плед", 190, "buc", None),
    ("Плед 2-х спальный", 205, "buc", None),
    ("Плед двойной", 310, "buc", None),
    ("Плед дублированный 2-х спальный", 310, "buc", None),
    ("Подушка на синтепоне 50x50", 70, "buc", None),
    ("Подушка на синтепоне 50x70", 80, "buc", None),
    ("Покрывало более 3 кв.м", 245, "buc", None),
    ("Покрывало до 3 кв.м", 145, "buc", None),
    ("Спальный мешок на пуху", 360, "buc", None),
    ("Спальный мешок на синтепоне", 300, "buc", None),
    ("Сумка, ранец", 195, "buc", None),
    ("Чехол для матраса из тонкой ткани", 65, "mp", "lei/m²"),
    ("Шторы на подкладке", 37, "mp", "lei/m²"),
    # --- Рабочая одежда ---
    ("Брюки рабочая одежда", 110, "buc", None),
    ("Бонетка, берет, бейсболка рабочая", 45, "buc", None),
    ("Комбинезон рабочая одежда", 125, "buc", None),
    ("Куртка рабочая с капюшоном", 160, "buc", None),
    ("Куртка рабочая без капюшона", 140, "buc", None),
    ("Одежда священнослужителей", 350, "buc", None),
    ("Плащ, плащ-накидка с капюшоном", 200, "buc", None),
    ("Плащ, плащ-накидка без капюшона", 170, "buc", None),
    ("Полукомбинезон", 120, "buc", None),
    ("Рубашка рабочая", 70, "buc", None),
    ("Фартук", 70, "buc", None),
    ("Футболка с длинным рукавом рабочая", 70, "buc", None),
    ("Футболка с коротким рукавом рабочая", 55, "buc", None),
    ("Халат рабочий", 95, "buc", None),
    ("Брюки рабочие утеплённые", 120, "buc", None),
    ("Комбинезон рабочий утепленный", 215, "buc", None),
    ("Куртка длинная рабочая с капюшоном", 250, "buc", None),
    ("Куртка длинная рабочая без капюшона", 220, "buc", None),
    # --- Кожа, шубы натуральные ---
    ("Брюки кожа", 400, "buc", None),
    ("Воротник (волк, норка)", 145, "buc", None),
    ("Дублёнка 60-90 см", 565, "buc", None),
    ("Дублёнка <60 см", 530, "buc", None),
    ("Дублёнка свыше 90 см", 615, "buc", None),
    ("Жилет кожа", 265, "buc", None),
    ("Кепи кожа", 120, "buc", None),
    ("Куртка кожа", 555, "buc", None),
    ("Пальто кожа", 615, "buc", None),
    ("Перчатки кожа", 110, "buc", None),
    ("Пиджак кожа", 470, "buc", None),
    ("Платье кожа", 460, "buc", None),
    ("Полушубок (волк, норка)", 525, "buc", None),
    ("Рубашка кожа", 435, "buc", None),
    ("Шапка кожа", 110, "buc", None),
    ("Шуба (волк, норка)", 675, "buc", None),
    ("Шуба (кролик, собака, нутрия, каракуль)", 525, "buc", None),
    ("Шуба (кролик, собака, нутрия, каракуль) 2", 445, "buc", None),
    ("Юбка кожа", 300, "buc", None),
    # --- Кожа искусственная ---
    ("Дублёнка искусственная до 90 см", 295, "buc", None),
    ("Дублёнка искусственная свыше 90 см", 350, "buc", None),
    ("Шапка искусственная кожа", 90, "buc", None),
    ("Шуба искусственная", 315, "buc", None),
    # --- Обувь ---
    ("Ботики кожа", 170, "buc", None),
    ("Ботики текстиль", 110, "buc", None),
    ("Полусапожки кожа", 210, "buc", None),
    ("Полусапожки текстиль", 150, "buc", None),
    ("Сапожки кожа", 290, "buc", None),
    ("Сапожки текстиль", 210, "buc", None),
    ("Туфли, мокасины, кроссовки кожаные", 170, "buc", None),
    ("Туфли, мокасины, кроссовки текстиль", 110, "buc", None),
    # --- Химчистка ковров ---
    ("Антимолевая обработка ковров", 20, "mp", "lei/m²"),
    ("Ковры грязезащитные", 60, "buc", None),
    ("Ковры ручной работы или сильно загрязненные", 50, "mp", "lei/m²"),
    ("Ковры, паласы >6м и площадь >24 кв.м", 55, "mp", "lei/m²"),
    ("Ковры, паласы толщина <10 мм", 40, "mp", "lei/m²"),
    ("Ковры, паласы толщина >10 мм", 45, "mp", "lei/m²"),
    ("Упаковка ковров", 20, "buc", "lei/ковер"),
    # --- Химчистка подушек ---
    ("Изменение размеров наперника или изготовление из ткани клиента", 12, "buc", "lei/шт"),
    ("Наперник 40x40", 45, "buc", None),
    ("Наперник 40x60", 55, "buc", None),
    ("Наперник 50x50", 60, "buc", None),
    ("Наперник 50x70", 80, "buc", None),
    ("Наперник 60x60", 80, "buc", None),
    ("Наперник 70x70", 85, "buc", None),
    ("Наперник 80x80", 100, "buc", None),
    ("Чистка пера", 14, "kg", "lei/kg"),
    # --- Стирка белья ---
    ("Гардино, тюлевые изделия, шторы стирка без глажения", 45, "kg", "lei/kg"),
    ("Глажение белья после стирки", 30, "kg", "lei/kg"),
    ("Крахмаление", 5, "kg", "lei/kg"),
    ("Одеяла, толстые покрывала стирка", 45, "kg", "lei/kg"),
    ("Плед стирка", 100, "kg", "lei/kg"),
    ("Постельное и фасонное белье", 33, "kg", "lei/kg"),
    ("Рабочая одежда стирка без глажения", 45, "kg", "lei/kg"),
    ("Стирка комбинированная с химчисткой", 100, "kg", "lei/kg"),
    ("Столовое белье салфетки", 40, "kg", "lei/kg"),
    ("Столовое белье скатерти", 38, "kg", "lei/kg"),
    ("Тонкие ковры стирка", 45, "kg", "lei/kg"),
    # --- Крашение кожи ---
    ("Брюки крашение кожа", 525, "buc", None),
    ("Дублёнка крашение до 60 см", 735, "buc", None),
    ("Жилет крашение кожа", 340, "buc", None),
    ("Кепи крашение", 140, "buc", None),
    ("Куртка крашение кожа", 735, "buc", None),
    ("Перчатки крашение", 150, "buc", None),
    ("Пиджак крашение кожа", 595, "buc", None),
    ("Ремень крашение", 110, "buc", None),
    ("Рубашка крашение кожа", 525, "buc", None),
    ("Сандали, шлепанцы крашение", 130, "buc", None),
    ("Сапоги высокие крашение", 270, "buc", None),
    ("Сумка, клач крашение", 220, "buc", None),
    ("Туфли, кеды, мокасины, кроссовки крашение", 205, "buc", None),
    ("Юбка крашение кожа", 430, "buc", None),
    # --- Продажа подушек из силикона ---
    ("Подушка силикон 40x40 см", 105, "buc", "по предв. заказу"),
    ("Подушка силикон 40x60 см", 116, "buc", "по предв. заказу"),
    ("Подушка силикон 50x50 см", 126, "buc", "по предв. заказу"),
    ("Подушка силикон 50x70 см", 180, "buc", "по предв. заказу"),
    ("Подушка силикон 60x60 см", 171, "buc", "по предв. заказу"),
    ("Подушка силикон 70x70 см", 219, "buc", "по предв. заказу"),
    ("Подушка силикон 80x80 см", 251, "buc", "по предв. заказу"),
]


def run_import(clear_first: bool = False):
    from models.database import DatabaseModel

    with DatabaseModel() as db:
        if clear_first:
            db.execute_query("DELETE FROM NUF_SERVICES")
            db.connection.commit()
            print("Таблица NUF_SERVICES очищена.")

        inserted = 0
        for i, item in enumerate(SERVICES_DATA):
            name_ru = item[0]
            price = item[1]
            unit = item[2]
            notes = item[3] if len(item) > 3 else None
            group_code = _group_for_index(i)
            name_ru = (name_ru or "")[:200]
            name_ro = name_ru
            try:
                db.execute_query(
                    """INSERT INTO NUF_SERVICES (NAME, NAME_RO, PRICE, UNIT, ACTIVE, NOTES, SERVICE_GROUP)
                       VALUES (:name, :name_ro, :price, :unit, 'Y', :notes, :service_group)""",
                    {
                        "name": name_ru,
                        "name_ro": name_ro,
                        "price": float(price),
                        "unit": unit[:50] if unit else "buc",
                        "notes": notes[:4000] if notes else None,
                        "service_group": group_code[:80] if group_code else None,
                    },
                )
                inserted += 1
            except Exception as e:
                print(f"Ошибка при вставке '{name_ru[:50]}...': {e}")
        db.connection.commit()
    return inserted


def escape_sql(s):
    if s is None:
        return "NULL"
    return "'" + str(s).replace("'", "''") + "'"


def print_sql():
    """Выводит SQL INSERT для импорта в Oracle (без подключения к БД)."""
    print("-- Импорт услуг Nufarul из https://nufarul.com/ru/order-online.html")
    print("-- Запуск в SQL*Plus/SQL Developer или: python import_nufarul_services.py --sql | sqlplus user/pass@db")
    print("DELETE FROM NUF_SERVICES;")
    print("COMMIT;")
    for i, item in enumerate(SERVICES_DATA):
        name_ru = (item[0] or "")[:200]
        price = item[1]
        unit = (item[2] or "buc")[:50]
        notes = (item[3] if len(item) > 3 else None)
        group_code = _group_for_index(i)
        name_ro = name_ru
        notes_sql = escape_sql(notes) if notes else "NULL"
        group_sql = escape_sql(group_code) if group_code else "NULL"
        print(f"INSERT INTO NUF_SERVICES (NAME, NAME_RO, PRICE, UNIT, ACTIVE, NOTES, SERVICE_GROUP) VALUES ({escape_sql(name_ru)}, {escape_sql(name_ro)}, {price}, {escape_sql(unit)}, 'Y', {notes_sql}, {group_sql});")
    print("COMMIT;")


if __name__ == "__main__":
    if "--sql" in sys.argv or "-s" in sys.argv:
        print_sql()
        sys.exit(0)
    clear = "--clear" in sys.argv or "-c" in sys.argv
    try:
        n = run_import(clear_first=clear)
        print(f"Импортировано услуг: {n}")
    except Exception as e:
        print(f"Ошибка: {e}")
        sys.exit(1)

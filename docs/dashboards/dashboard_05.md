# Dashboard 05: Кредиты — Оператор

## Описание

Мобильный интерфейс для консультантов магазина по оформлению рассрочки 0% для покупателей. Оптимизирован для планшетов и мобильных устройств. Позволяет быстро оформить кредит прямо в торговом зале за 5-10 минут по ID клиента.

## Назначение

Этот дашборд предназначен для:
- **Консультантов магазина**: Оформление заявок на рассрочку в торговом зале
- **Кассиров**: Быстрое оформление кредита при покупке
- **Менеджеров по продажам**: Консультирование клиентов по доступным программам
- **Продавцов**: Помощь покупателям в выборе оптимальной программы рассрочки

## Бизнес-процесс

### Типичный сценарий использования

1. **Поиск товара**: Консультант сканирует штрихкод или вводит название/артикул
2. **Выбор программы**: Система автоматически показывает только доступные программы для товара (фильтрация по матрице)
3. **Расчёт платежей**: Автоматический расчёт первого взноса, ежемесячного платежа, общей суммы
4. **Оформление заявки**: Заполнение минимальных данных клиента (ФИО, телефон, ID)
5. **Отправка в банк**: Заявка отправляется в банки-партнёры через API
6. **Получение результата**: Мгновенное одобрение/отказ или статус "на рассмотрении"
7. **Оформление сделки**: При одобрении - подписание договора и отгрузка товара

## Доступные виджеты

### 1. Кредиты — Оператор
**Тип**: Embed  
**URL**: `/UNA.md/orasldev/credit-operator`  
**Описание**: Мобильный интерфейс с:
- Поиском товаров по штрихкоду или названию
- Отображением доступных программ рассрочки
- Формой оформления заявки
- Историей последних заявок

## Функциональность

### Главный экран

1. **Поиск товара**:
   - Большое поле ввода "Сканировать штрихкод или ввести название/артикул"
   - Кнопка "Сканер" с иконкой камеры (моковое сканирование - открывает поле ввода)
   - Горизонтальный скролл популярных товаров (4-6 карточек с фото, названием, ценой)
   - Быстрый поиск по популярным товарам

2. **История заявок**:
   - Последние 3-5 заявок за сегодня
   - Информация: товар, клиент (ФИО), статус (одобрено/отказано/на рассмотрении), время
   - Быстрый доступ к повторному оформлению

### Экран товара

- **Фото товара**: Крупное изображение товара
- **Название и цена**: Название товара и текущая цена крупным шрифтом
- **Блок "Доступные рассрочки"**:
  - Вертикальный список карточек программ (фильтруется автоматически по матрице)
  - Каждая карточка содержит:
    - Название программы (например, "Maib 0-0-24")
    - Срок рассрочки (24 месяца)
    - Первый взнос (0 MDL)
    - Ежемесячный платёж (автоматический расчёт: цена / срок, округление)
    - Кнопка "Выбрать"
  - **Подсветка самой выгодной программы**: Зелёным цветом выделяется программа с самым длинным сроком или самым низким платежом
  - **Реалтайм расчёт**: При выборе программы сразу показывается расчёт платежей

### Экран оформления заявки

- Информация о выбранной программе (readonly)
- Расчет: первый взнос, ежемесячный платёж, общая сумма
- Форма клиента:
  - ФИО
  - Телефон (маска +373 ___ ___ __ __)
  - Серия и номер ID/паспорта
- Кнопка "Отправить заявку в банк"

### Экран результата

После отправки заявки:
- **Loading spinner**: 3-5 секунд (симуляция обработки банком)
- **Результат** (моковые ответы):
  - **Успех (80%)**: 
    - Зелёная иконка check
    - Текст "Заявка одобрена! Сумма одобрена: XXX MDL. Подпишите договор."
    - Кнопка "Новая заявка"
  - **Отказ (20%)**: 
    - Красная иконка
    - Текст "Отказано. Причина: низкий скоринг" (или другая причина)
    - Кнопка "Попробовать другую программу"
  - **На рассмотрении**: 
    - Жёлтая иконка
    - Текст "Заявка отправлена, ждите звонка в течение 5 мин"
    - Кнопка "Новая заявка"

### Дополнительные возможности

- **История заявок**: Внизу главного экрана отображается простая история последних 3-5 заявок
- **Быстрый расчёт**: При изменении программы автоматически пересчитываются платежи
- **Валидация данных**: Проверка корректности введённых данных клиента перед отправкой

## База данных

### Таблицы

#### CRED_PRODUCTS
Каталог товаров:
- `PRODUCT_ID` (PK)
- `PRODUCT_NAME` - Название товара
- `CATEGORY_ID` (FK) - Категория
- `BRAND_ID` (FK) - Бренд
- `PRICE` - Цена
- `BARCODE` - Штрихкод
- `IMG_URL` - URL изображения
- `IS_ACTIVE` - Активен ли товар

#### CRED_APPLICATIONS
Заявки на кредит:
- `APPLICATION_ID` (PK)
- `PRODUCT_ID` (FK) - Товар
- `PROGRAM_ID` (FK) - Программа
- `CLIENT_FIO` - ФИО клиента
- `CLIENT_PHONE` - Телефон
- `CLIENT_ID_NUMBER` - Серия и номер ID
- `APPLICATION_STATUS` - Статус (approved, rejected, on_review)
- `APPROVED_AMOUNT` - Одобренная сумма
- `REJECT_REASON` - Причина отказа
- `CREATED_AT`, `UPDATED_AT` - Даты

### Представления (Views)

#### V_CRED_PRODUCTS
Представление товаров с категориями и брендами:
```sql
SELECT 
    p.*,
    c.CATEGORY_NAME,
    b.BRAND_NAME
FROM CRED_PRODUCTS p
LEFT JOIN CRED_CATEGORIES c ON p.CATEGORY_ID = c.CATEGORY_ID
LEFT JOIN CRED_BRANDS b ON p.BRAND_ID = b.BRAND_ID
WHERE p.IS_ACTIVE = 1
```

#### V_CRED_APPLICATIONS_RECENT
Последние заявки:
```sql
SELECT 
    a.*,
    p.PRODUCT_NAME,
    pr.PROGRAM_NAME
FROM CRED_APPLICATIONS a
JOIN CRED_PRODUCTS p ON a.PRODUCT_ID = p.PRODUCT_ID
JOIN CRED_PROGRAMS pr ON a.PROGRAM_ID = pr.PROGRAM_ID
ORDER BY a.CREATED_AT DESC
```

### Пакеты (Packages)

#### CRED_OPERATOR_PKG
Процедуры для оператора:
- `GET_PRODUCTS(P_LIMIT NUMBER, P_CUR OUT SYS_REFCURSOR)` - Получение популярных товаров
- `GET_PRODUCT_BY_ID(P_ID NUMBER, P_CUR OUT SYS_REFCURSOR)` - Получение товара по ID
- `GET_PRODUCT_BY_BARCODE(P_BARCODE VARCHAR2, P_CUR OUT SYS_REFCURSOR)` - Поиск по штрихкоду
- `SEARCH_PRODUCTS(P_QUERY VARCHAR2, P_CUR OUT SYS_REFCURSOR)` - Поиск товаров
- `GET_PROGRAMS_FOR_PRODUCT(P_PRODUCT_ID NUMBER, P_CUR OUT SYS_REFCURSOR)` - Доступные программы для товара
- `CREATE_APPLICATION(...)` - Создание заявки
- `GET_RECENT_APPLICATIONS(P_LIMIT NUMBER, P_CUR OUT SYS_REFCURSOR)` - Последние заявки

## Развертывание

### 1. Развертывание объектов БД

```bash
python deploy_oracle_objects.py
```

Или выполните SQL скрипты в порядке:
1. `sql/05_cred_tables.sql` - Таблицы (включая CRED_PRODUCTS и CRED_APPLICATIONS)
2. `sql/06_cred_views.sql` - Представления
3. `sql/07_cred_triggers.sql` - Триггеры
4. `sql/09_cred_operator_package.sql` - Пакет оператора
5. `sql/10_demo_data.sql` - Демо-данные (товары и заявки)

### 2. Настройка приложения

Интерфейс оператора доступен по адресу `/UNA.md/orasldev/credit-operator` и использует API:
- `GET /api/credit-operator/products?limit=6` - Популярные товары
- `GET /api/credit-operator/products/:id` - Товар по ID
- `GET /api/credit-operator/products?barcode=...` - Поиск по штрихкоду
- `GET /api/credit-operator/products?search=...` - Поиск товаров
- `GET /api/credit-operator/programs-for-product/:id` - Программы для товара
- `POST /api/credit-operator/application` - Создание заявки
- `GET /api/credit-operator/recent-applications?limit=5` - Последние заявки

## Доработка

### Добавление нового поля в товар

1. **Добавьте колонку:**
```sql
ALTER TABLE CRED_PRODUCTS ADD NEW_FIELD VARCHAR2(100);
```

2. **Обновите представление:**
Добавьте поле в `V_CRED_PRODUCTS`.

3. **Обновите API:**
Добавьте обработку в `CreditController.get_products()`.

4. **Обновите интерфейс:**
Добавьте отображение в `credit_operator.html`.

### Кастомизация расчета платежей

Расчет выполняется в JavaScript в `credit_operator.html`. Формула:
```javascript
const monthlyPayment = Math.ceil((price - firstPayment) / termMonths);
```

Измените логику расчета в функции `calculatePayment()`.

### Добавление новых статусов заявки

1. **Обновите CHECK constraint:**
```sql
ALTER TABLE CRED_APPLICATIONS 
DROP CONSTRAINT CHK_APPLICATION_STATUS;

ALTER TABLE CRED_APPLICATIONS 
ADD CONSTRAINT CHK_APPLICATION_STATUS 
CHECK (APPLICATION_STATUS IN ('approved', 'rejected', 'on_review', 'new_status'));
```

2. **Обновите интерфейс:**
Добавьте обработку нового статуса в `showResult()`.

## API

### Поиск товара

**Endpoint**: `GET /api/credit-operator/products?search=холодильник`

**Ответ**:
```json
{
  "success": true,
  "data": [
    {
      "product_id": 1,
      "product_name": "Холодильник Samsung",
      "category_name": "Холодильники",
      "brand_name": "Samsung",
      "price": 25000,
      "barcode": "1234567890",
      "img_url": "/static/images/product1.jpg"
    }
  ]
}
```

### Получение программ для товара

**Endpoint**: `GET /api/credit-operator/programs-for-product/1`

**Ответ**:
```json
{
  "success": true,
  "data": [
    {
      "program_id": 1,
      "program_name": "Maib 0-0-24",
      "term_months": 24,
      "first_payment_pct": 0,
      "rate_pct": 0,
      "monthly_payment": 1042
    }
  ]
}
```

### Создание заявки

**Endpoint**: `POST /api/credit-operator/application`

**Тело запроса**:
```json
{
  "product_id": 1,
  "program_id": 1,
  "client_fio": "Иванов Иван Иванович",
  "client_phone": "+373 123 456 78",
  "client_id_number": "1234567890"
}
```

**Ответ**:
```json
{
  "success": true,
  "application_id": 1,
  "status": "approved",
  "approved_amount": 25000,
  "reject_reason": null
}
```

## Troubleshooting

### Товары не отображаются
- Проверьте, что таблица `CRED_PRODUCTS` заполнена данными
- Проверьте, что `IS_ACTIVE = 1` для товаров
- Проверьте консоль браузера на ошибки API

### Программы не фильтруются
- Убедитесь, что матрица доступности настроена в админке
- Проверьте, что процедура `GET_PROGRAMS_FOR_PRODUCT` корректно фильтрует по категории

### Заявки не создаются
- Проверьте права доступа к таблице `CRED_APPLICATIONS`
- Убедитесь, что последовательность `CRED_APPLICATIONS_SEQ` создана
- Проверьте логи сервера на ошибки

### Расчет платежей неверный
- Проверьте формулу расчета в JavaScript
- Убедитесь, что процент первого взноса корректно применяется
- Проверьте округление значений

## Интеграция с банковскими системами

### Автоматическая отправка заявок

При нажатии кнопки "Отправить заявку в банк":
1. Заявка сохраняется в таблицу `CRED_APPLICATIONS`
2. Заявка отправляется в банки-партнёры через API (планируется интеграция с Easy Credit ECM)
3. Система получает ответ от банка (одобрено/отказано/на рассмотрении)
4. Статус обновляется в базе данных

### Множественные банки-партнёры

Согласно ТЗ, заявка может отправляться одновременно в несколько банков:
- Maib
- Victoriabank
- Moldindconbank
- Express Credit
- И другие банки-партнёры

Если несколько банков одобрили заявку, клиент выбирает банк по своему усмотрению.

### Расчёт платежей

Расчёт выполняется автоматически:
- **Ежемесячный платёж** = (Цена товара - Первый взнос) / Срок в месяцах
- Округление до целого числа
- Отображение в реальном времени при выборе программы

**Пример**:
- Товар: 25000 MDL
- Программа: Maib 0-0-24 (24 месяца, первый взнос 0%)
- Ежемесячный платёж: 25000 / 24 = 1042 MDL

## Дополнительные ресурсы

- [Dashboard 04: Кредиты — Админка](/UNA.md/orasldev/docs/dashboard/04)
- [DDL скрипты](/UNA.md/orasldev/docs/sql)
- [API документация](/UNA.md/orasldev/docs/api)
- [Easy Credit API документация](/UNA.md/orasldev/docs/easycredit)

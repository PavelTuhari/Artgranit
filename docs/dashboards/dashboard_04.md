# Dashboard 04: Кредиты — Админка

## Описание

Админ-панель для управления кредитными программами банков-партнёров. Позволяет создавать, редактировать и настраивать кредитные предложения для ритейлера бытовой техники (Bomba.md). Система работает по партнёрской схеме: ритейлер выступает как партнёр банков/МФО, а весь кредитный процесс (скоринг, одобрение, договор, график платежей) берёт на себя финансовая организация.

## Назначение

Этот дашборд предназначен для:
- **Администраторов кредитных программ**: Управление программами рассрочки от разных банков-партнёров
- **Финансовых менеджеров**: Настройка условий кредитования, расчёт комиссий, анализ рентабельности
- **IT-специалистов**: Интеграция с банковскими системами через API (Easy Credit ECM, SOAP/REST)
- **Менеджеров по продажам**: Мониторинг доступности программ по категориям товаров

## Бизнес-логика

### Партнёрская модель

Bomba.md не управляет кредитами самостоятельно. Система работает следующим образом:
- Несколько банков/МФО предлагают разные кредитные продукты (рассрочка 0-0-6, 0-0-12, 0-0-24)
- Каждая программа имеет свои условия: срок, процентная ставка, первый взнос, мин/макс сумма
- Программы могут быть привязаны к определённым категориям товаров
- Некоторые бренды могут быть исключены из программ
- Заявка клиента отправляется в банк, который принимает решение об одобрении/отказе

## Доступные виджеты

### 1. Кредиты — Админка
**Тип**: Embed  
**URL**: `/UNA.md/orasldev/credit-admin`  
**Описание**: Полнофункциональная админ-панель с:
- Таблицей всех кредитных программ
- Формой создания/редактирования программ
- Матрицей доступности программ по категориям товаров
- Разделом **Отчёты** — настраиваемые отчёты (CRED_REPORTS, CRED_REPORT_PARAMS)
- Фильтрацией и поиском

## Функциональность

### Управление программами

- **Создание программы**: Форма с полями:
  - Название программы
  - Банк (Maib, Victoriabank, Moldindconbank, Express Credit)
  - Срок (6-36 месяцев)
  - Процентная ставка
  - Первый взнос (0%, 10%, 20% или custom)
  - Мин./Макс. сумма
  - Комиссия банка (%)
  - Статус (активна/выключена)

- **Редактирование**: Открытие формы с предзаполненными данными
- **Удаление**: Удаление программы с подтверждением
- **Архивация**: Перевод программы в архив

### Матрица доступности

Таблица для настройки доступности программ по категориям товаров:
- Строки: Категории товаров (Холодильники, Стиральные машины, Телевизоры, Смартфоны, Ноутбуки и т.д.)
- Столбцы: Кредитные программы
- Чекбоксы: Назначение программы категории
- Массовое выделение: Возможность назначить программу на несколько категорий одновременно
- Фильтрация: По цене (диапазон) для категории

**Логика фильтрации:**
- Программа показывается для товара только если:
  1. Категория товара включена в матрицу доступности программы
  2. Цена товара находится в диапазоне MIN_AMOUNT - MAX_AMOUNT программы
  3. Бренд товара НЕ находится в списке исключённых брендов программы

## База данных

### Таблицы

#### CRED_BANKS
Справочник банков:
- `BANK_ID` (PK)
- `BANK_NAME` - Название банка
- `IS_ACTIVE` - Активен ли банк

#### CRED_CATEGORIES
Категории товаров:
- `CATEGORY_ID` (PK)
- `CATEGORY_NAME` - Название категории

#### CRED_BRANDS
Бренды товаров:
- `BRAND_ID` (PK)
- `BRAND_NAME` - Название бренда

#### CRED_PROGRAMS
Кредитные программы:
- `PROGRAM_ID` (PK)
- `PROGRAM_NAME` - Название программы
- `BANK_ID` (FK) - Банк
- `TERM_MONTHS` - Срок в месяцах
- `RATE_PCT` - Процентная ставка
- `FIRST_PAYMENT_PCT` - Первый взнос (%)
- `MIN_AMOUNT` - Минимальная сумма
- `MAX_AMOUNT` - Максимальная сумма
- `COMMISSION_PCT` - Комиссия банка (%)
- `IS_ACTIVE` - Активна ли программа
- `NOTES` - Примечания
- `CREATED_AT`, `UPDATED_AT` - Даты

#### CRED_PROGRAM_CATEGORIES
Связь программ с категориями:
- `PROGRAM_ID` (FK)
- `CATEGORY_ID` (FK)

#### CRED_PROGRAM_EXCLUDED_BRANDS
Исключённые бренды для программ:
- `PROGRAM_ID` (FK)
- `BRAND_ID` (FK)

### Представления (Views)

#### V_CRED_PROGRAMS
Представление программ с информацией о банке:
```sql
SELECT 
    p.*,
    b.BANK_NAME
FROM CRED_PROGRAMS p
JOIN CRED_BANKS b ON p.BANK_ID = b.BANK_ID
```

#### V_CRED_MATRIX
Матрица доступности программ по категориям:
```sql
SELECT 
    c.CATEGORY_ID,
    c.CATEGORY_NAME,
    p.PROGRAM_ID,
    p.PROGRAM_NAME,
    CASE WHEN pc.PROGRAM_ID IS NOT NULL THEN 1 ELSE 0 END AS IS_AVAILABLE
FROM CRED_CATEGORIES c
CROSS JOIN CRED_PROGRAMS p
LEFT JOIN CRED_PROGRAM_CATEGORIES pc 
    ON c.CATEGORY_ID = pc.CATEGORY_ID 
    AND p.PROGRAM_ID = pc.PROGRAM_ID
```

### Пакеты (Packages)

#### CRED_ADMIN_PKG
Процедуры для администрирования:
- `GET_PROGRAMS(P_ACTIVE NUMBER, P_CUR OUT SYS_REFCURSOR)` - Получение списка программ
- `GET_PROGRAM_BY_ID(P_ID NUMBER, P_CUR OUT SYS_REFCURSOR)` - Получение программы по ID
- `UPSERT_PROGRAM(...)` - Создание/обновление программы
- `DELETE_PROGRAM(P_ID NUMBER)` - Удаление программы
- `GET_MATRIX(P_CUR OUT SYS_REFCURSOR)` - Получение матрицы доступности
- `SET_MATRIX_ROW(P_CATEGORY_ID NUMBER, P_PROGRAM_ID NUMBER, P_ENABLED NUMBER)` - Установка доступности

## Развертывание

### 1. Развертывание объектов БД

```bash
python deploy_oracle_objects.py
```

Или выполните SQL скрипты в порядке:
1. `sql/05_cred_tables.sql` - Таблицы
2. `sql/06_cred_views.sql` - Представления
3. `sql/07_cred_triggers.sql` - Триггеры
4. `sql/08_cred_admin_package.sql` - Пакет администрирования
5. `sql/10_demo_data.sql` - Демо-данные

### 2. Настройка приложения

Админ-панель доступна по адресу `/UNA.md/orasldev/credit-admin` и использует API:
- `GET /api/credit-admin/programs` - Список программ
- `POST /api/credit-admin/programs` - Создание/обновление
- `DELETE /api/credit-admin/programs/<id>` - Удаление
- `GET /api/credit-admin/matrix` - Матрица доступности
- `POST /api/credit-admin/matrix` - Обновление матрицы

## Доработка

### Добавление нового поля в программу

1. **Добавьте колонку в таблицу:**
```sql
ALTER TABLE CRED_PROGRAMS ADD NEW_FIELD VARCHAR2(100);
```

2. **Обновите представление:**
Добавьте поле в `V_CRED_PROGRAMS`.

3. **Обновите пакет:**
Добавьте параметр в `UPSERT_PROGRAM`.

4. **Обновите API:**
Добавьте обработку в `CreditController.upsert_program()`.

5. **Обновите форму:**
Добавьте поле ввода в `credit_admin.html`.

### Добавление нового банка

1. **Добавьте запись в таблицу:**
```sql
INSERT INTO CRED_BANKS (BANK_NAME, IS_ACTIVE) 
VALUES ('Новый Банк', 1);
```

2. **Обновите форму:**
Добавьте опцию в select банков (или загружайте динамически из API).

## API

### Получение списка программ

**Endpoint**: `GET /api/credit-admin/programs?active=1`

**Ответ**:
```json
{
  "success": true,
  "data": [
    {
      "program_id": 1,
      "program_name": "Maib 0-0-24",
      "bank_name": "Maib",
      "term_months": 24,
      "rate_pct": 0,
      "first_payment_pct": 0,
      "min_amount": 1000,
      "max_amount": 50000,
      "commission_pct": 0,
      "is_active": 1
    }
  ]
}
```

### Создание программы

**Endpoint**: `POST /api/credit-admin/programs`

**Тело запроса**:
```json
{
  "program_name": "Новая программа",
  "bank_id": 1,
  "term_months": 12,
  "rate_pct": 0,
  "first_payment_pct": 0,
  "min_amount": 5000,
  "max_amount": 100000,
  "commission_pct": 0,
  "is_active": 1
}
```

## Troubleshooting

### Программы не отображаются
- Проверьте, что таблицы созданы
- Проверьте, что демо-данные загружены
- Проверьте консоль браузера на ошибки API

### Ошибки при сохранении
- Проверьте права доступа к таблице `CRED_PROGRAMS`
- Убедитесь, что последовательность `CRED_PROGRAMS_SEQ` создана
- Проверьте логи сервера на ошибки SQL

### Матрица не обновляется
- Проверьте, что пакет `CRED_ADMIN_PKG` создан
- Убедитесь, что процедура `SET_MATRIX_ROW` работает корректно

## Интеграция с банковскими системами

### Easy Credit (ECM) API

Система поддерживает интеграцию с Easy Credit через SOAP/REST API. Интеграция позволяет автоматизировать процессы отправки заявок, проверки статусов, расчёта платежей и получения документов.

#### Тестовое окружение
- **Базовый URL**: `http://w91.ecredit.md:49082/`
- **Сервисы**:
  - `Request_v4_PJ.svc` - Создание новой заявки на кредит
    - Обязательные поля: `user`, `passwd`, данные клиента и товара
  - `URNStatus_v2.svc` - Проверка текущего статуса заявки
    - Обязательные поля: `user`, `passwd`, `urn` (номер заявки)
  - `ECM_CancelRequest.svc` - Отмена заявки
    - Обязательные поля: `user`, `passwd`, `urn`
  - `ECM_GetDocs_V2.svc` - Получение документов по заявке
    - Обязательные поля: `user`, `passwd`, `urn`
  - `ECM_InstallmentCalc.svc` - Расчёт рассрочки
    - Обязательные поля: `user`, `passwd`, сумма, срок
  - `Preapproved_v2.1.svc` - Предварительное одобрение
    - Обязательные поля: `user`, `passwd`, данные клиента

#### Продакшн окружение
- **Базовый URL**: `https://w81.ecredit.md:8082/`
- Те же сервисы, что и в тестовом окружении
- Использует HTTPS для безопасности

#### Реализация интеграции

**Текущий статус**: Базовая структура готова. Полная интеграция с Easy Credit API планируется в следующих версиях.

**Планируемая архитектура**:
1. Создание модуля `integrations/easy_credit.py` для работы с SOAP/REST API
2. Обновление `CreditController.create_application()` для отправки заявок в Easy Credit
3. Фоновые задачи для проверки статусов заявок
4. Кэширование результатов расчётов

**Пример использования (планируется)**:
```python
from integrations.easy_credit import EasyCreditAPI

ecm = EasyCreditAPI(environment='test')
result = ecm.create_request(client_data, product_data, program_data)
status = ecm.check_status(result.urn)
```

### Автоматизация процессов

- **Автоматическая отправка заявок**: Заявки отправляются в банки-партнёры в порядке приоритета
- **Расчёт рентабельности**: Система рассчитывает комиссии и рентабельность для каждой программы
- **Мониторинг статусов**: Автоматическая проверка статусов заявок через API
- **Генерация отчётов**: Отчёты по продажам, одобрениям, отказам

## Расширенная функциональность

### Управление исключениями

- **Исключённые бренды**: Можно указать бренды, которые не участвуют в программе (например, Apple для некоторых программ)
- **Исключённые товары**: Возможность добавить конкретные товары в стоп-лист
- **Условия акций**: Настройка правил (только новые товары, акционные товары запрещены и т.д.)

### Аналитика и отчёты

- Статистика по программам: количество заявок, одобрений, отказов
- Рентабельность: расчёт комиссий и прибыли по каждой программе
- Мониторинг производительности: какие программы наиболее популярны

## Дополнительные ресурсы

- [DDL скрипты](/UNA.md/orasldev/docs/sql)
- [API документация](/UNA.md/orasldev/docs/api)
- [Dashboard 05: Кредиты — Оператор](/UNA.md/orasldev/docs/dashboard/05)
- [Easy Credit API документация](/UNA.md/orasldev/docs/easycredit)
- [Настраиваемые отчёты](/UNA.md/orasldev/docs/cred-reports)
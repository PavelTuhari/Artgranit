#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É IP

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_DIR" || { echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞!"; exit 1; }

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É IP"
echo ""

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 3003
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞..."
OLD_PID=$(lsof -ti:3003 2>/dev/null)
if [ -n "$OLD_PID" ]; then
    echo "   –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å: $OLD_PID"
    kill -9 $OLD_PID 2>/dev/null
    sleep 2
    echo "   ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "   ‚ÑπÔ∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω)"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if grep -q "SERVER_HOST = os.environ.get('SERVER_HOST', '0.0.0.0')" config.py; then
    echo "   ‚úÖ SERVER_HOST –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ 0.0.0.0"
else
    echo "   ‚ö†Ô∏è  SERVER_HOST –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ config.py"
fi
echo ""

# –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π IP
LOCAL_IP=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null || ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}' | head -1)

echo "‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!"
echo ""
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ:"
echo "   ‚Ä¢ http://localhost:3003"
if [ -n "$LOCAL_IP" ]; then
    echo "   ‚Ä¢ http://${LOCAL_IP}:3003"
fi
echo ""

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
if [ -f "venv/bin/activate" ]; then
    source venv/bin/activate
else
    echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
export ENVIRONMENT=LOCAL
export PORT=3003
export SERVER_HOST=0.0.0.0  # –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏

echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
echo "   SERVER_HOST —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: 0.0.0.0"
echo "   PORT —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: 3003"
echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (5 —Å–µ–∫—É–Ω–¥)..."
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
python3 app.py &
APP_PID=$!
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å –∏ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞..."
LISTENING=$(netstat -an | grep "3003" | grep "LISTEN")

if echo "$LISTENING" | grep -q "127.0.0.1.3003"; then
    echo "   ‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ —Å–ª—É—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ 127.0.0.1"
    echo "   –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–æ—Ü–µ—Å—Å..."
    kill $APP_PID 2>/dev/null
    echo ""
    echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "   1. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è SERVER_HOST –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ"
    echo "   2. Flask/SocketIO –∫–µ—à–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
    echo ""
    echo "üîß –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é:"
    echo "   export SERVER_HOST=0.0.0.0"
    echo "   export PORT=3003"
    echo "   python3 app.py"
    exit 1
elif echo "$LISTENING" | grep -qE "\*\.3003|0\.0\.0\.0\.3003"; then
    echo "   ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö (0.0.0.0)"
    echo ""
    echo "üéâ –£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!"
    echo ""
    echo "üåê –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é:"
    echo "   ‚Ä¢ http://localhost:3003"
    if [ -n "$LOCAL_IP" ]; then
        echo "   ‚Ä¢ http://${LOCAL_IP}:3003"
        echo ""
        echo "üìä Dashboard:"
        echo "   ‚Ä¢ http://${LOCAL_IP}:3003/UNA.md/orasldev/dashboard"
        echo "   ‚Ä¢ Fullscreen: http://${LOCAL_IP}:3003/UNA.md/orasldev/dashboard/01"
    fi
    echo ""
    echo "‚ö†Ô∏è  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ñ–æ–Ω–µ. –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:"
    echo "   lsof -ti:3003 | xargs kill -9"
    echo ""
    echo "–ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏):"
    echo "   ./run_local.sh"
else
    echo "   ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ä—Ç–∞"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é: netstat -an | grep 3003"
fi

